GlobalPlatform


__________________________
Card Specification
Version 2.1.1
March 2003




Recipients of this document are invited to submit, with their comments, notification of any relevant
patent rights or other intellectual property rights of which they may be aware which might be infringed
by the implementation of the specification set forth in this document, and to provide supporting
documentation.
   03/25/2003                                GlobalPlatform Card Specification 2.1.1                                                                             3

Table of Contents

1. INTRODUCTION..................................................................................................................................... 16

1.1       Audience .........................................................................................................................................................16

1.2       Normative References ...................................................................................................................................17

1.3       Terminology and Definitions ........................................................................................................................17

1.4       Abbreviations and Notations ........................................................................................................................20

1.5     Revisions History ...........................................................................................................................................21
   1.5.1    Open Platform Card Specification v2.0 to Open Platform Card Specification v2.0.1 .............................21
   1.5.2    Major Adjustments in GlobalPlatform Card Specification V2.1 .............................................................22
   1.5.3    Revisions in GlobalPlatform Card Specification V2.1.1 .........................................................................24


2. SYSTEM ARCHITECTURE.................................................................................................................... 27


3. CARD ARCHITECTURE ........................................................................................................................ 28

3.1       Runtime Environment...................................................................................................................................29

3.2     Card Manager................................................................................................................................................29
   3.2.1    GlobalPlatform Environment (OPEN).....................................................................................................29
   3.2.2    Issuer Security Domain............................................................................................................................30
   3.2.3    Cardholder Verification Management .....................................................................................................30

3.3       Security Domains ...........................................................................................................................................30

3.4       GlobalPlatform API.......................................................................................................................................30

3.5       Card Content..................................................................................................................................................31


4. SECURITY ARCHITECTURE ................................................................................................................ 32

4.1       Goals ...............................................................................................................................................................32

4.2     Security Responsibilities ...............................................................................................................................33
   4.2.1    Card Issuer's Security Responsibilities ....................................................................................................33
   4.2.2    Application Provider's Security Responsibilities.....................................................................................33
   4.2.3    Controlling Authority's Security Responsibilities....................................................................................33
   4.2.4    On-Card Components' Security Requirements ........................................................................................34
   4.2.5    Back-End System Security Requirements ...............................................................................................35




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
   4                                        GlobalPlatform Card Specification 2.1.1                                                        03/25/2003

4.3     Cryptographic support..................................................................................................................................36
   4.3.1    Integrity and Authentication for Card Content Management...................................................................36
   4.3.2    Secure Communication............................................................................................................................37


5. LIFE CYCLE MODELS........................................................................................................................... 39

5.1     Card Life Cycle ..............................................................................................................................................39
   5.1.1    Card Life Cycle States .............................................................................................................................39
   5.1.2    Card Life Cycle Transitions.....................................................................................................................42

5.2     Executable Load File/ Executable Module Life Cycle ................................................................................43
   5.2.1    Executable Load File Life Cycle .............................................................................................................43
   5.2.2    Executable Module Life Cycle ................................................................................................................43

5.3     Application and Security Domain Life Cycle ..............................................................................................43
   5.3.1    Application Life Cycle States ..................................................................................................................44
   5.3.2    Security Domain Life Cycle States..........................................................................................................47

5.4       Sample Life Cycle Illustration ......................................................................................................................49


6. CARD MANAGER .................................................................................................................................. 51

6.1     Card Manager Overview ..............................................................................................................................51
   6.1.1    OPEN.......................................................................................................................................................51
   6.1.2    Issuer Security Domain............................................................................................................................53
   6.1.3    CVM Handler ..........................................................................................................................................53

6.2     Card Manager Services.................................................................................................................................53
   6.2.1    Application Access to OPEN Services ....................................................................................................53
   6.2.2    Application Access to CVM Services......................................................................................................54
   6.2.3    Application Access to Issuer Security Domain Services .........................................................................54
   6.2.4    Issuer Security Domain Access to Applications ......................................................................................55

6.3     Command Dispatch .......................................................................................................................................55
   6.3.1   Basic Logical Channel .............................................................................................................................56
   6.3.2   Supplementary Logical Channel..............................................................................................................59

6.4     Card Content Management ..........................................................................................................................62
   6.4.1    Card Content Loading and Installation ....................................................................................................62
   6.4.2    Content Removal .....................................................................................................................................67
   6.4.3    Content Extradition..................................................................................................................................70

6.5       Delegated Management .................................................................................................................................71

6.6     GlobalPlatform Registry ...............................................................................................................................72
   6.6.1    Issuer Security Domain Data Elements Description................................................................................72
   6.6.2    Application/Executable Load File/Executable Module Data Elements ...................................................73




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
   03/25/2003                               GlobalPlatform Card Specification 2.1.1                                                                          5

6.7     Security Management....................................................................................................................................76
   6.7.1    Application Locking ................................................................................................................................76
   6.7.2    Card Locking ...........................................................................................................................................77
   6.7.3    Card Termination.....................................................................................................................................78
   6.7.4    Operational Velocity Checking................................................................................................................79
   6.7.5    Tracing and Event Logging .....................................................................................................................80
   6.7.6    Securing Content Loading and Installation..............................................................................................80

6.8     Issuer Security Domain .................................................................................................................................81
   6.8.1     Issuer Identification Number ...................................................................................................................82
   6.8.2     Card Image Number ................................................................................................................................82
   6.8.3     Card Recognition Data.............................................................................................................................82
   6.8.4     On-Card Key Information........................................................................................................................83

6.9     CVM Management ........................................................................................................................................84
   6.9.1   CVM States..............................................................................................................................................84
   6.9.2   CVM Format............................................................................................................................................85


7. SECURITY DOMAINS ............................................................................................................................ 86

7.1       Overview.........................................................................................................................................................86

7.2     Security Domain Services..............................................................................................................................87
   7.2.1    Application Access to Security Domain Services....................................................................................87
   7.2.2    Security Domain Access to Applications.................................................................................................88

7.3       Personalization Support................................................................................................................................88

7.4       Runtime Messaging Support.........................................................................................................................90

7.5       DAP Verification............................................................................................................................................91

7.6     Delegated Management .................................................................................................................................91
   7.6.1    Delegated Loading...................................................................................................................................92
   7.6.2    Delegated Installation ..............................................................................................................................92
   7.6.3    Delegated Extradition ..............................................................................................................................95
   7.6.4    Delegated Deletion ..................................................................................................................................95

7.7     Delegated Management Tokens and Receipts and DAP Verification .......................................................96
   7.7.1    Load Token..............................................................................................................................................97
   7.7.2    Load Receipt............................................................................................................................................97
   7.7.3    Install and Extradition Tokens .................................................................................................................98
   7.7.4    Install Receipt ..........................................................................................................................................98
   7.7.5    Extradition Receipt ..................................................................................................................................99
   7.7.6    Delete Receipt..........................................................................................................................................99
   7.7.7    Load File Data Block Hash......................................................................................................................99
   7.7.8    Load File Data Block Signature (DAP Verification).............................................................................100




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
   6                                       GlobalPlatform Card Specification 2.1.1                                                        03/25/2003

8. SECURE COMMUNICATION............................................................................................................... 101

8.1       Secure Channel ............................................................................................................................................101

8.2     Explicit / Implicit Secure Channel .............................................................................................................101
   8.2.1    Explicit Secure Channel Initiation .........................................................................................................102
   8.2.2    Implicit Secure Channel Initiation .........................................................................................................102
   8.2.3    Secure Channel Termination .................................................................................................................102

8.3       Direct / Indirect Handling of a Secure Channel Protocol ........................................................................102

8.4       Entity Authentication ..................................................................................................................................103

8.5       Secure Messaging.........................................................................................................................................103

8.6       Secure Channel Protocol Identifier............................................................................................................103


9. APDU COMMAND REFERENCE ........................................................................................................ 105

9.1     General Coding Rules..................................................................................................................................106
   9.1.1   Life Cycle Status Coding.......................................................................................................................106
   9.1.2   Application Privileges Coding...............................................................................................................107
   9.1.3   General Error Conditions.......................................................................................................................108
   9.1.4   Class Byte Coding .................................................................................................................................108
   9.1.5   APDU Command and Response Data ...................................................................................................109
   9.1.6   Key Type Coding...................................................................................................................................109
   9.1.7   Optional Receipts in Delegated Management Response Messages .......................................................109

9.2       DELETE Command ....................................................................................................................................110

9.3       GET DATA Command................................................................................................................................112

9.4       GET STATUS Command ...........................................................................................................................114

9.5       INSTALL Command...................................................................................................................................118

9.6       LOAD Command.........................................................................................................................................124

9.7       MANAGE CHANNEL Command .............................................................................................................127

9.8       PUT KEY Command...................................................................................................................................129

9.9       SELECT Command.....................................................................................................................................133

9.10      SET STATUS Command ............................................................................................................................135

9.11      STORE DATA Command...........................................................................................................................137




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
   03/25/2003                                GlobalPlatform Card Specification 2.1.1                                                                         7

A. GLOBALPLATFORM API ................................................................................................................... 140

A.1        Deprecated Open Platform Java Card API...............................................................................................141

A.2        GlobalPlatform on a Java Card .................................................................................................................160

A.3        GlobalPlatform on Windows Powered Smart Card .................................................................................186


B. ALGORITHMS (CRYPTOGRAPHIC AND HASHING)........................................................................ 189

B.1    Data Encryption Standard (DES) ..............................................................................................................189
  B.1.1    Encryption/Decryption...........................................................................................................................189
  B.1.2    MACing .................................................................................................................................................189

B.2    Hashing Algorithms.....................................................................................................................................189
  B.2.1    Secure Hash Algorithm (SHA-1)...........................................................................................................190

B.3        Public Key Cryptography Scheme 1 (PKCS#1) ........................................................................................190

B.4        DES Padding ................................................................................................................................................190


C. SECURE CONTENT MANAGEMENT................................................................................................. 191

C.1    Keys...............................................................................................................................................................191
  C.1.1    Issuer Security Domain Keys ................................................................................................................191
  C.1.2    Security Domain Keys ...........................................................................................................................191

C.2        Load File Data Block Hash .........................................................................................................................192

C.3    Tokens...........................................................................................................................................................192
  C.3.1    Load Token............................................................................................................................................192
  C.3.2    Install Token ..........................................................................................................................................193
  C.3.3    Extradition Token ..................................................................................................................................194

C.4    Receipts.........................................................................................................................................................195
  C.4.1    Load Receipt..........................................................................................................................................196
  C.4.2    Install Receipt ........................................................................................................................................196
  C.4.3    Delete Receipt........................................................................................................................................197
  C.4.4    Extradition Receipt ................................................................................................................................197

C.5    DAP Verification..........................................................................................................................................198
  C.5.1   PKC Scheme..........................................................................................................................................198
  C.5.2   DES Scheme ..........................................................................................................................................198


D. SECURE CHANNEL PROTOCOL '01'................................................................................................199

D.1        Secure Communication ...............................................................................................................................199




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
   8                                       GlobalPlatform Card Specification 2.1.1                                                          03/25/2003

   D.1.1         SCP01 Secure Channel ..........................................................................................................................199
   D.1.2         Mutual Authentication ...........................................................................................................................199
   D.1.3         Message Integrity...................................................................................................................................202
   D.1.4         Message Data Confidentiality................................................................................................................202
   D.1.5         ICV Encryption......................................................................................................................................202
   D.1.6         Security Level........................................................................................................................................202

D.2       Cryptographic Keys.....................................................................................................................................203

D.3    Cryptographic Usage...................................................................................................................................203
  D.3.1    DES Session Keys .................................................................................................................................203
  D.3.2    Authentication Cryptograms..................................................................................................................205
  D.3.3    APDU Command MAC Generation and Verification ...........................................................................205
  D.3.4    APDU Data Field Encryption and Decryption ......................................................................................207
  D.3.5    Key Sensitive Data Encryption and Decryption ....................................................................................208

D.4    Secure Channel APDU Commands............................................................................................................208
  D.4.1    INITIALIZE UPDATE Command ........................................................................................................209
  D.4.2    EXTERNAL AUTHENTICATE Command .........................................................................................211


E. SECURE CHANNEL PROTOCOL '02'................................................................................................ 213

E.1    Secure Communication ...............................................................................................................................213
  E.1.1    SCP02 Secure Channel ..........................................................................................................................213
  E.1.2    Entity Authentication.............................................................................................................................214
  E.1.3    Message Integrity...................................................................................................................................216
  E.1.4    Message Data Confidentiality................................................................................................................217
  E.1.5    Security Level........................................................................................................................................217

E.2       Cryptographic Keys.....................................................................................................................................218

E.3    Cryptographic Algorithms..........................................................................................................................218
  E.3.1    Cipher Block Chaining (CBC)...............................................................................................................218
  E.3.2    Message Integrity ICV using Explicit Secure Channel Initiation ..........................................................218
  E.3.3    Message Integrity ICV using Implicit Secure Channel Initiation ..........................................................219
  E.3.4    ICV Encryption......................................................................................................................................219

E.4    Cryptographic Usage...................................................................................................................................219
  E.4.1    DES Session Keys .................................................................................................................................219
  E.4.2    Authentication Cryptograms in Explicit Secure Channel Initiation.......................................................220
  E.4.3    Authentication Cryptogram in Implicit Secure Channel Initiation ........................................................220
  E.4.4    APDU Command C-MAC Generation and Verification .......................................................................221
  E.4.5    APDU Response R-MAC Generation and Verification.........................................................................223
  E.4.6    APDU Command Data Field Encryption and Decryption .....................................................................224
  E.4.7    Sensitive Data Encryption and Decryption............................................................................................225

E.5       Secure Channel APDU Commands............................................................................................................226




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
  03/25/2003                            GlobalPlatform Card Specification 2.1.1                                                                          9

  E.5.1       INITIALIZE UPDATE Command ........................................................................................................227
  E.5.2       EXTERNAL AUTHENTICATE Command .........................................................................................229
  E.5.3       BEGIN R-MAC SESSION Command ..................................................................................................231
  E.5.4       END R-MAC SESSION Command ......................................................................................................233


F. GLOBALPLATFORM DATA VALUES AND CARD RECOGNITION DATA ...................................... 235

F.1    Data Values ..................................................................................................................................................235

F.2    Structure of Card Recognition Data ..........................................................................................................235

F.3    Security Domain Management Data ..........................................................................................................237




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
   10                                     GlobalPlatform Card Specification 2.1.1                                                      03/25/2003

Table of Figures and Tables
Figure 2-1: GlobalPlatform Architecture.....................................................................................................................27
Figure 3-1: GlobalPlatform Card Architecture ............................................................................................................28
Figure 3-2 Card Content Relationships .......................................................................................................................31
Figure 5-1: Card Life Cycle State Transitions.............................................................................................................42
Figure 5-2: Application Life Cycle State Transitions..................................................................................................46
Figure 5-3: Security Domain Life Cycle State Transitions..........................................................................................48
Figure 5-4: Sample Card Life Cycle and Application Life Cycles ..............................................................................50
Figure 6-1: OPEN Architecture ...................................................................................................................................52
Figure 6-2: Loading and Installation Process ..............................................................................................................63
Figure 6-3: Load and Installation Flow Diagram ........................................................................................................66
Figure 6-4: Install Flow Diagram ................................................................................................................................67
Figure 6-5: Executable Load File Deletion Flow ........................................................................................................69
Figure 6-6: Application Extradition Flow ...................................................................................................................71
Figure 6-7: Application Locking Flow ........................................................................................................................77
Figure 6-8: Card Locking Flow ...................................................................................................................................78
Figure 6-9: Terminate Card Flow ................................................................................................................................79
Figure 7-1: Application Personalization through Associated Security Domain ..........................................................89
Figure 7-2: Runtime Messaging Flow .........................................................................................................................90
Figure 7-3: Delegated Loading and Installation ..........................................................................................................94
Figure 7-4: Delegated Deletion ...................................................................................................................................96
Figure 7-5 Load Token Calculation.............................................................................................................................97
Figure 7-6: Load Receipt Calculation..........................................................................................................................97
Figure 7-7: Install//Extradition Token Calculation......................................................................................................98
Figure 7-8: Install Receipt Calculation........................................................................................................................98
Figure 7-9: Extradition Receipt Calculation ................................................................................................................99
Figure 7-10: Delete Receipt Calculation .....................................................................................................................99
Figure 7-11: Load File Data Block Hash Calculation................................................................................................100
Figure 7-12: Load File Data Block Signature Calculation ........................................................................................100


Figure D-1: Mutual Authentication Flow (Security Domain)....................................................................................201
Figure D-2: Mutual Authentication Flow (using services of Security Domain)........................................................201




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
   03/25/2003                             GlobalPlatform Card Specification 2.1.1                                                                  11

Figure D-3: Session Key - Step 1 - Generate Derivation data ...................................................................................204
Figure D-4: Session Key - Step 2 - Create S-ENC Session Key ...............................................................................204
Figure D-5: Session Key – Step 3 - Create S-MAC Session Key..............................................................................204
Figure D-6: APDU Command MAC Generation and Verification ...........................................................................206
Figure D-7: APDU Data Field Encryption ................................................................................................................207


Figure E-1: Explicit Secure Channel Initiation Flow ................................................................................................215
Figure E-2: Create Secure Channel Session Key from the Base Key........................................................................220
Figure E-3: C-MAC Generation on Unmodified APDU ...........................................................................................222
Figure E-4: C-MAC Generation on Modified APDU................................................................................................222
Figure E-5: R-MAC Generation ................................................................................................................................223
Figure E-6: APDU Command Data Field Encryption ...............................................................................................225


Table 1-1: Normative References ................................................................................................................................17
Table 1-2: Terminology and Definitions .....................................................................................................................20
Table 1-3: Abbreviations and Notations......................................................................................................................21
Table 9-1: Authorized GlobalPlatform Commands per Card Life Cycle State .........................................................105
Table 9-2: Minimum Security Requirements for GlobalPlatform Commands ..........................................................106
Table 9-3: Executable Load File Life Cycle Coding .................................................................................................106
Table 9-4: Application Life Cycle Coding ................................................................................................................107
Table 9-5: Security Domain Life Cycle Coding ........................................................................................................107
Table 9-6: Issuer Security Domain Life Cycle Coding..............................................................................................107
Table 9-7: Application Privileges ..............................................................................................................................107
Table 9-8: General Error Conditions .........................................................................................................................108
Table 9-9: CLA Byte Coding ....................................................................................................................................108
Table 9-10: Key Type Coding ...................................................................................................................................109
Table 9-11: Confirmation Structure...........................................................................................................................109
Table 9-12: DELETE Command Message ................................................................................................................110
Table 9-13: DELETE Reference Control Parameter P2 ............................................................................................110
Table 9-14: DELETE [key] Command Message Data Field .....................................................................................111
Table 9-15: DELETE Response Data Field...............................................................................................................111
Table 9-16: DELETE Error Conditions.....................................................................................................................111




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
   12                                     GlobalPlatform Card Specification 2.1.1                                                     03/25/2003

Table 9-17: GET DATA Command Message ...........................................................................................................112
Table 9-18: Key Information Data Structure .............................................................................................................113
Table 9-19: GET DATA Error Conditions ................................................................................................................113
Table 9-20: GET STATUS Command Message .......................................................................................................114
Table 9-21: GET STATUS Reference Control Parameter P2 ...................................................................................115
Table 9-22: Issuer Security Domain, Application and Executable Load File Information Data ...............................115
Table 9-23: GlobalPlatform Registry Data (TLV).....................................................................................................116
Table 9-24: Executable Load File and Executable Module Information Data ..........................................................116
Table 9-25: GET STATUS Warning Conditions.......................................................................................................116
Table 9-26: GET STATUS Error Conditions ............................................................................................................117
Table 9-27: INSTALL Command Message...............................................................................................................118
Table 9-28: INSTALL Command Reference Control Parameter P1 .........................................................................118
Table 9-29: INSTALL [for load] Command Data Field............................................................................................119
Table 9-30: INSTALL [for install] Command Data Field.........................................................................................120
Table 9-31: INSTALL [for make selectable] Command Data Field .........................................................................121
Table 9-32: INSTALL [for extradition] Command Data Field .................................................................................121
Table 9-33: INSTALL [for personalization] Command Data Field ..........................................................................122
Table 9-34: Load Parameter Tags..............................................................................................................................122
Table 9-35: Install Parameter Tags............................................................................................................................122
Table 9-36: INSTALL Response Data Field .............................................................................................................123
Table 9-37: INSTALL Error Conditions ...................................................................................................................123
Table 9-38: LOAD Command Message Structure.....................................................................................................124
Table 9-39: LOAD Command Reference Control Parameter P1...............................................................................124
Table 9-40: Load File Structure.................................................................................................................................125
Table 9-41: LOAD Response Data Field...................................................................................................................126
Table 9-42: LOAD Error Conditions.........................................................................................................................126
Table 9-43: MANAGE CHANNEL Command Message..........................................................................................127
Table 9-44: MANAGE CHANNEL Warning Conditions.........................................................................................128
Table 9-45: MANAGE CHANNEL Error Conditions ..............................................................................................128
Table 9-46: PUT KEY Command Message...............................................................................................................129
Table 9-47: PUT KEY Reference Control Parameter P1 ..........................................................................................130
Table 9-48: PUT KEY Reference Control Parameter P2 ..........................................................................................130




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
   03/25/2003                              GlobalPlatform Card Specification 2.1.1                                                                  13

Table 9-49: Key Version Number Diagram...............................................................................................................130
Table 9-50: Key Data Field .......................................................................................................................................131
Table 9-51: PUT KEY Error Conditions ...................................................................................................................132
Table 9-52: SELECT Command Message.................................................................................................................133
Table 9-53: SELECT Reference Control Parameter P1.............................................................................................133
Table 9-54: SELECT Reference Control Parameter P2.............................................................................................133
Table 9-55: File Control Information ........................................................................................................................134
Table 9-56: SELECT Warning Condition .................................................................................................................134
Table 9-57: SELECT Error Conditions .....................................................................................................................134
Table 9-58: SET STATUS Command Message ........................................................................................................135
Table 9-59: SET STATUS – Status Type..................................................................................................................135
Table 9-60: SET STATUS Error Conditions.............................................................................................................136
Table 9-61: STORE DATA Command Message.......................................................................................................137
Table 9-62: STORE DATA Reference Control Parameter P1...................................................................................137
Table 9-63: STORE DATA Error Condition.............................................................................................................138


Table A-1: GlobalPlatform on a Java Card: Security Level ......................................................................................165
Table A-2: GlobalPlatform on Windows Powered Smart Card: Security Level .......................................................187


Table C-1: Issuer Security Domain Keys ..................................................................................................................191
Table C-2: Additional Security Domain Key ............................................................................................................191
Table C-3: Data Elements Included in the Load Token.............................................................................................193
Table C-4: Data Elements Included in the INSTALL [for Install] Token .................................................................194
Table C-5: Data Elements Included in the INSTALL [for make selectable] Token..................................................194
Table C-6: Data Elements Included in the Extradition Token...................................................................................195
Table C-7: Data Elements Included in the Load Receipt...........................................................................................196
Table C-8: Data Elements Included in the Install Receipt.........................................................................................196
Table C-9: Data Elements Included in the Delete Receipt ........................................................................................197
Table C-10: Data Elements Included in the Extradition Receipt...............................................................................197


Table D-1: Security Domain Secure Channel Keys...................................................................................................203
Table D-2: Minimum Security Requirements for SCP01 Commands.......................................................................208




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
   14                                   GlobalPlatform Card Specification 2.1.1                                                 03/25/2003

Table D-3: SCP01 Command Support per Card Life Cycle State .............................................................................208
Table D-4: INITIALIZE UPDATE Command Message...........................................................................................209
Table D-5: INITIALIZE UPDATE Response Message ............................................................................................210
Table D-6: INITIALIZE UPDATE Error Condition .................................................................................................210
Table D-7: EXTERNAL AUTHENTICATE Command Message............................................................................211
Table D-8: EXTERNAL AUTHENTICATE Reference Control Parameter P1........................................................211
Table D-9: EXTERNAL AUTHENTICATE Error Condition ..................................................................................212


Table E-1: SCP02 - Security Domain Secure Channel Base Key .............................................................................218
Table E-2: SCP02 - Security Domain Secure Channel Keys.....................................................................................218
Table E-3: SCP02 Command Support .......................................................................................................................226
Table E-4: Minimum Security Requirements for SCP02 Commands .......................................................................226
Table E-5: SCP02 Command Support per card Life Cycle State ..............................................................................226
Table E-6: INITIALIZE UPDATE Command Message ...........................................................................................227
Table E-7: INITIALIZE UPDATE Response Message.............................................................................................228
Table E-8: INITIALIZE UPDATE Error Condition..................................................................................................228
Table E-9: EXTERNAL AUTHENTICATE Command Message ............................................................................229
Table E-10: EXTERNAL AUTHENTICATE Reference Control Parameter P1 ......................................................229
Table E-11: EXTERNAL AUTHENTICATE warning Code ...................................................................................230
Table E-12: BEGIN R-MAC SESSION Command Message....................................................................................231
Table E-13: BEGIN R-MAC SESSION Reference Control Parameter P1 ...............................................................231
Table E-14: BEGIN R-MAC SESSION Reference Control Parameter P2 ...............................................................231
Table E-15: BEGIN R-MAC SESSION Command Data Field.................................................................................232
Table E-16: BEGIN R-MAC SESSION Error Conditions ........................................................................................232
Table E-17: END R-MAC SESSION Command Message .......................................................................................233
Table E-18: END R-MAC SESSION Reference Control Parameter P1 ...................................................................233
Table E-19: END R-MAC SESSION Reference Control Parameter P2 ...................................................................233
Table E-20: END R-MAC SESSION Error Conditions ............................................................................................234


Table F-1: Structure of Card Recognition Data.........................................................................................................236
Table F-2: Security Domain Management Data ........................................................................................................237




   Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
   The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
   information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
   prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            15




                                               Part I
                                           Introduction




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
16                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003


1. Introduction
GlobalPlatform is an organization that has been established by leading companies from the payments and
communications industries, the government sector and the vendor community, and is the first to promote a global
infrastructure for smart card implementation across multiple industries. Its goal is to reduce barriers hindering the
growth of cross-industry, multiple Application smart cards. The smart card issuers will continue to have the
freedom to choose from a variety of cards, terminals and back-end systems.
For smart cards to reach their true potential, consumers need to be able to use them for a wide variety of
functions. For example, the cards can be used with mobile phones to make purchases over the Internet as well as
to securely access a PC. Smart cards should also be cost effective and easily multifunctional.
Beginning in the mid-1990s, a number of very significant breakthroughs occurred in the chip card industry with
the introduction of open systems specifications for Application development. The three leading technologies in
this area are Java Card™, Windows® Powered Smart Cards, and MULTOS™. These technology specifications
provide an important contribution to the solution towards the multi-Application chip card vision, such as common
programming standards allowing Application portability between different card specific implementations.
Through the Open Platform initiative, first Visa International and now GlobalPlatform have been working with
the chip card industry to deliver a missing and critically important chip card standard — a hardware-neutral,
vendor-neutral, Application-independent card management specification. This new specification provides a
common security and card management architecture that protects the most important aspect of a chip card system
investment — the infrastructure.
GlobalPlatform defines a flexible and powerful specification for Card Issuers to create multi-Application chip
card systems to meet the evolution of their business needs. The specification allows them to choose the card
technology that is right for them today while also ensuring that they can migrate, if necessary, to a different card
technology in the future without significant impact to their infrastructure.
This specification describes the GlobalPlatform Specifications that shall be implemented on GlobalPlatform smart
cards.
The following meanings apply to SHALL, SHOULD, and MAY in this document:
     x   SHALL indicates that the statement containing the SHALL must be implemented as defined in this
          Specification. It does not mandate the implementation of the statement.
     x   SHOULD indicates a recommendation. It is strongly recommended to implement the statement as
          defined in this Specification.
     x   MAY indicates an option.


1.1       Audience
This specification is intended primarily for card manufacturers and application developers developing
GlobalPlatform card implementations. Although this specification defines card components, command interfaces,
transaction sequences, and interfaces that can be common across many different industries, it does not detail the
implementation of the lower layers security, which may vary from one industry to the other.
This specification is also intended for a more general audience as it describes the generic security concepts and
the various actors involved in a multi-Application Card Management System.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            17




1.2      Normative References
 Standard / Specification                                              Description
ANSI X9.52                             Triple Data Encryption Algorithm Modes of Operation, draft, 1996
                                       Multi Application Smart Card Management Systems GlobalPlatform
CAMS v3.0 June 2000
                                       Functional Requirements
                                       Federal Information Processing Standards Publication 46-3, Reaffirmed
FIPS PUB 46-3                          1999: Data Encryption Standard (DES): U.S. Department Of
                                       Commerce/National Institute Of Standards And Technology
                                       Federal Information Processing Standards Publication 180-1, 1995: Secure
FIPS PUB 180-1                         Hash Standard: U.S. Department Of Commerce, Technology
                                       Administration, National Institute Of Standards And Technology
                                       Identification cards – Integrated circuit(s) cards with contacts - Part 4:
ISO/IEC 7816-4:1995
                                       Inter-industry commands for interchange
                                       Identification cards – Integrated circuit(s) cards with contacts - Part 5:
ISO/IEC 7816-5:1994
                                       Numbering systems and registration procedure for application identifiers
                                       Identification cards - Integrated circuit(s) cards with contacts- Part 6:
ISO/IEC 7816-6:1996
                                       Interindustry data elements
                                       Information technology – ASN.1 encoding rules: Specification of Basic
ISO/IEC 8825-1:1998                    Encoding Rules (BER), Canonical Encoding Rules (CER) and
                                       Distinguished Encoding Rules (DER)
                                       [IS8731-1] Banking - Approved algorithms for message authentication –
ISO 8731-1:1987
                                       Part 1: DEA
                                       [IS9797] Information technology – Security techniques - Data integrity
ISO/IEC 9797:1994                      mechanism using a cryptographic check function employing a block cipher
                                       algorithm
                                       [IS10116] Information technology - Modes of operation of an n-bit block
ISO/IEC 10116: 1997
                                       cipher algorithm
                                       [IS10118-3] Information technology – Security techniques - Hash
ISO/IEC 10118-3: 1998
                                       functions –Part 3: Dedicated hash functions
                                       Go to the following web site for Java Card™ documentation:
Java Card™ 2.1.1, 2.2
                                       java.sun.com/products/javacard
                                       PKCS #1 v2.0: RSA Cryptography Standard, RSA Laboratories, October
PKCS#1 (RFC 2437)
                                       1998 (RFC 2437).
Windows®-Powered Smart                 Go to the following web site for more information on Windows for Smart
Cards                                  Cards®: www.microsoft.com
                                        Table 1-1: Normative References


1.3      Terminology and Definitions
Table 1-2 defines the expressions used within this Specification that use an upper case first letter in each word of
the expression. Expressions within this document that use a lower case first letter in each word take the common
sense meaning. (Tagged data elements are also given an upper case first letter in each word of their names.)




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
18                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003



               Term                                                      Definition
                                       Instance of an Executable Module after it has been installed and made
Application
                                       selectable
Application Protocol Data Unit         Standard communication messaging protocol between a card accepting
(APDU)                                 device and a smart card
                                       Entity that owns an application and is responsible for the application's
Application Provider
                                       behavior
                                       The link between the Application and the external world on a logical
                                       channel starting with the selection of the Application and ending when
Application Session
                                       another Application selection occurs on the logical channel, the logical
                                       channel is closed or the Card Session terminates
                                       A cryptographic technique that uses two related transformations, a public
                                       transformation (defined by the Public Key component) and a private
Asymmetric Cryptography                transformation (defined by the Private Key component); these two key
                                       components have a property so that it is computationally infeasible to
                                       discover the Private Key, even if given the Public Key
Basic Logical Channel                  The permanently available interface between the card and an external
                                       entity. The Basic Logical Channel is numbered zero
                                       Code and Application information (but not Application data) contained in
Card Content                           the card that is under the responsibility of the OPEN e.g. Executable Load
                                       Files, Application instances, etc
Card Image Number (CIN)                An identifier for a specific GlobalPlatform card
                                       Entity that owns the card and is ultimately responsible for the behavior of
Card Issuer
                                       the card
                                       Generic term for the 3 card management entities of a GlobalPlatform card
Card Manager                           i.e. the OPEN, Issuer Security Domain and the Cardholder Verification
                                       Method Services provider
                                       Information that tells an external system, in particular a Card and
Card Recognition Data                  Application Management System (CAMS), how to work with the card
                                       (including indicating that this is a GlobalPlatform card)
                                       The link between the card and the external world starting with the ATR
Card Session
                                       and ending with a subsequent reset or a deactivation of the card
                                       Data that uniquely identifies a card being the concatenation of the Issuer
Card Unique Data
                                       Identification Number and Card Image Number
Cardholder                             The end user of a card
Cardholder Verification Method         A method to ensure that the person presenting the card is the person to
(CVM)                                  whom the card was issued
                                       The Controlling Authority has the privilege to keep the control over the
Controlling Authority
                                       Card Content through the mandating of DAP Verification
DAP Block                              Part of the Load File used for ensuring Load File Data Block verification
                                       A mechanism used by a Security Domain to verify that a Load File Data
DAP Verification
                                       Block is authentic
                                       Pre-authorized Card Content changes performed by an approved
Delegated Management
                                       Application Provider




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            19

               Term                                                      Definition
                                       An asymmetric cryptographic transformation of data that allows the
                                       recipient of the data to prove the origin and integrity of the data; it protects
Digital Signature
                                       the sender and the recipient of the data against forgery by third parties; it
                                       also protects the sender against forgery by the recipient
                                       Actual on-card container of one or more application's executable code
                                       (Executable Modules). It may reside in Immutable Persistent Memory or
Executable Load File
                                       may be created in Mutable Persistent Memory as the resulting image of a
                                       Load File Data Block
                                       Contains the on-card executable code of a single application present within
Executable Module
                                       an Executable Load File
GlobalPlatform Registry                A container of information related to Card Content management
                                       A logical term used to represent the back end systems that support the
                                       GlobalPlatform system; hosts perform functions such as authorization and
Host
                                       authentication, administration, Post-Issuance application code and data
                                       downloading, and transactional processing
Immutable Persistent Memory            Memory that can only be read
                                       On-card entity providing support for the control, security, and
Issuer Security Domain
                                       communication requirements of the Card Issuer
                                       The existence of Card Content on a GlobalPlatform card and the various
Life Cycle
                                       stages of this existence where applicable
Life Cycle State                       A specific state within the Life Cycle of the card or of Card Content
                                       A file transferred to a GlobalPlatform card that contains a Load File Data
Load File
                                       Block and possibly one or more DAP Blocks
                                       Part of the Load File that contains one or more application(s) and libraries
Load File Data Block                   or support information for the application(s) as required by the specific
                                       platform
Load File Data Block Hash              A value providing integrity for the Load File Data Block
                                       A value encompassing the Load File Data Block Hash and providing both
Load File Data Block Signature
                                       integrity and authenticity of the Load File Data Block
Message Authentication Code            A symmetric cryptographic transformation of data that provides data
(MAC)                                  origin authentication and data integrity
Mutable Persistent Memory              Memory that can be modified
OPEN                                   The central on-card administrator that owns the GlobalPlatform Registry
Post-Issuance                          Phase following the card being issued to the Cardholder
Pre-Issuance                           Phase prior to the card being issued to the Cardholder
Private Key                            The private component of the asymmetric key pair
Public Key                             The public component of the asymmetric key pair
                                       An cryptographic value provided by the card (if so required by the Card
Receipt
                                       Issuer) as proof that a Delegated Management operation has occurred
                                       A counter, used in conjunction with the Retry Limit, to determine when
Retry Counter
                                       attempts to present a CVM value shall be prohibited
                                       The maximum number of times an invalid CVM value can be presented
Retry Limit                            prior to the CVM handler prohibiting further attempts to present a CVM
                                       value




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
 20                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

                Term                                                      Definition
                                        A communication mechanism between an off-card entity and a card that
 Secure Channel
                                        provides a level of assurance, to one or both entities
 Secure Channel Protocol                A secure communication protocol and set of security services
                                        A session, during an Application Session, starting with the Secure Channel
 Secure Channel Session                 initiation and ending with a Secure Channel termination or termination of
                                        either the Application Session or Card Session
                                        On-card entity providing support for the control, security, and
 Security Domain
                                        communication requirements of the Application Provider
 Supplementary Logical Channel          Up to 3 additional interfaces (other than the permanently available Basic
                                        Logical Channel) between the card and an external entity. Each
                                        Supplementary Logical Channel is numbered 1, 2 or 3
                                        A cryptographic technique that uses the same secret key for both the
 Symmetric Cryptography
                                        originator’s and the recipient’s transformation
                                        A cryptographic value provided by a Card Issuer as proof that a Delegated
 Token
                                        Management operation has been authorized
                                     Table 1-2: Terminology and Definitions


 1.4      Abbreviations and Notations
Abbreviation                                                      Meaning
AID                Application Identifier
APDU               Application Protocol Data Unit
API                Application Programming Interface
ASCII              American Standard Code for Information Interchange
ATR                Answer-to-Reset
BCD                Binary Coded Decimal
BER                Basic Encoding Rules
CBC                Cipher Block Chaining
CIN                Card Image Number / Card Identification Number
CLA                Class byte of the command message
CVM                Cardholder Verification Method
DAP                Data Authentication Pattern
DEK                Data Encryption Key
DES                Data Encryption Standard
ECB                Electronic Code Book
EMV                Europay, MasterCard, and Visa; used to refer to the ICC Specifications for Payment Systems
ENC                Encryption
FCI                File Control Information
HEX                Hexadecimal
ICC                Integrated Circuit Card
ICV                Initial Chaining Vector
IIN                Issuer Identification Number
INS                Instruction byte of the command message




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
 03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            21

Abbreviation                                                    Meaning
ISO                International Organization for Standardization
Lc                 Exact length of data in a case 3 or case 4 command
Le                 Maximum length of data expected in response to a case 2 or case 4 command
LV                 Length Value
MAC                Message Authentication Code
OID                Object Identifier
OPEN               GlobalPlatform environment
P1                 Reference control parameter 1
P2                 Reference control parameter 2
PIN                Personal Identification Number
RAM                Random Access Memory
RFU                Reserved for Future Use
RID                Registered Application Provider Identifier
ROM                Read-only Memory
RSA                Rivest / Shamir / Adleman asymmetric algorithm
SCP                Secure Channel Protocol
SW                 Status Word
SW1                Status Word One
SW2                Status Word Two
TLV                Tag Length Value
                                    Table 1-3: Abbreviations and Notations




 1.5      Revisions History

 1.5.1     Open Platform Card Specification v2.0 to Open Platform Card
         Specification v2.0.1
 This section provides a brief reminder of the revisions made to the Open Platform Card Specification 2.0 Card
 Specification in the Open Platform Card Specification 2.0.1'.
 Wording and formatting of the specification had been improved.
 Anything relating to a specific implementation of Open Platform had been removed from the main body of the
 specification and was detailed in the Appendices.
 Anything specific relating to the personalization of Open Platform or Applications had been removed.
 The changes relating specifically to the Java Card™ implementation of Open Platform were listed in the
 beginning of Appendix A - GlobalPlatform API.
 All the issues identified in the FAQ document dated April-June 1999 and the FAQ documents dated October-
 November 1999 and relating strictly to Open Platform, had been included in this version. The one caveat to this
 was the point 3.1.20 of the FAQ document dated October-November 1999 i.e. it is now required that the Security
 Domain associated with an Application be the same Security Domain used to perform Delegated Management
 functions for this Application.




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
22                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The inclusion of Part V described a specific use of security and key management that was not present in Open
Platform 2.0.


1.5.2      Major Adjustments in GlobalPlatform Card Specification V2.1
The following major adjustments are the modifications decided by GlobalPlatform Members. All of these
modifications are intended to make the GlobalPlatform more usable for a wider number of entities while
maintaining backwards compatibility. The minor editing changes and rewording for readability are not listed.

1.5.2.1    Enhancement to DAP Verification Scheme
In the process of implementing GlobalPlatform cards that supported Delegated Management and DAP
Verification, it was determined that the method defined in the previous version of Open Platform necessitated the
verification of multiple signatures on large blocks of data (Load File and Load File Data Block) that differed only
slightly. When multiple DAP Verifications and possibly Delegated Management was being performed
simultaneously, multiple hash generations were required to run concurrently. This negatively impacted the
performance of the load process.
A new method has been defined in which instead of signing large blocks of data, a hash of the critical large block
of data (Load File Data Block) may be generated and this hash signed. In this new method signatures are required
on very much smaller blocks of information. Only one hash generation and check is required on the Load File
Data Block (see Section 6.7.6.1 - Load File Data Block Hash).

1.5.2.2     Application Reception of Data from Security Domains
The Secure Channel mechanism previously provided by Open Platform only allowed an Application to request
services from its associated Security Domain.
A new service is now provided that may be initiated by a Security Domain. It allows data to be passed by the
Security Domain associated with an Application to the Application for further processing. The main purpose of
this service is to facilitate the personalization of Applications through the Applications' associated Security
Domain. A new INSTALL command has been defined to identify the Application to be personalized (see Section
9.5 - INSTALL Command).

1.5.2.3     Security Domain Association and Extradition
In the previous Open Platform Card Specification an Executable Load File was associated to a Security Domain
and all Applications instantiated from an Executable Load file, when installed, were also associated to the same
Security Domain. This method was restrictive.
The new scheme provides Application Extradition. Application Extradition allows an Application that is already
associated with a Security Domain to be extradited and associated with another Security Domain (see Section
7.6.3 - Delegated Extradition).
Another benefit provided by this enhancement is that in addition to Executable Load Files and Applications, now
applications within Executable Load Files become visible in the GlobalPlatform Registry at the time that the
Executable Load File is registered (see Section 9.5 - INSTALL Command).




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            23

In order to avoid confusion between selectable Applications and the applications within an Executable Load File
a new term has been introduced i.e. Executable Module. The term Executable Module is intended to identify the
one or more applications present within an Executable Load File (see Section 5.2.2 - Executable Module Life
Cycle).

1.5.2.4    Executable Modules
In the previous Open Platform Card Specification, an off-card entity could only retrieve information relating to
the Executable Load Files and selectable Applications present on the card. In order to enhance the information
returned by the GET STATUS command, an additional set of information will be stored in the GlobalPlatform
Registry and returned in the response to the GET STATUS command. This information relates to the Executable
Module and it is now possible to also retrieve information relating to application code within an Executable Load
File that is available for installation.

1.5.2.5    Card Recognition Data
A concerted effort was made to ensure that there would be a uniform method to determine basic information
about a card. The Card Recognition Data and the method for retrieving this data have been included in this
version of the GlobalPlatform Card Specification. Information such as: this is a GlobalPlatform card,
implemented in a particular way, and with a particular version number is now available (see Section 6.8.3 - Card
Recognition Data).

1.5.2.6    Support of New Secure Channel Protocols
In order to be more accommodating, the method for including additional Secure Channel Protocols has been
formalized. While this was allowed in previous versions of the Open Platform Card Specification, only one
Secure Channel Protocol was defined. As part of the efforts of GlobalPlatform a formal process for including
Secure Channel Protocols is defined. This version of the specification details two Secure Channel Protocols and
their selection process. To provide clarity a slight re-organization of the GlobalPlatform Card specification has
been done. Part V of the Open Platform 2.0.1' specification has been removed. Part of its content is incorporated
into Part III and the rest is moved into the Appendices (see Appendix D - Secure Channel Protocol '01'and E -
Secure Channel Protocol '02').

1.5.2.7    Cardholder Verification Method Services
Additional services and features regarding the optional CVM have been included (see Section 6.9 - CVM
Management). In the previous versions of the Open Platform Card Specification, the CVM provided the
possibility for a single PIN to be common across multiple Applications. When the PIN was changed by one
Application it became visible to all Applications. However an Application could not check whether the PIN had
previously been correctly presented to another Application during the same Card Session. The new Card
Verification Method (CVM) services provide the ability to do this check.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
24                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

1.5.2.8    Card Manager Separation
Historically the Card Manager has been viewed and defined as the major on-card component with no distinction
or separation between the various responsibilities encompassed within as well as not clearly defining where the
runtime environment ends and the Card Manager begins. A decision has been made to separate the Card Manager
into 3 distinct entities and clearly identifying what runtime environment functionality must be within each. (See
Section 3.2 - Card Manager) While the term Card Manager is still present, it now encompasses the OPEN, the
Issuer Security Domain and the Cardholder Verification Method Services provider. This new structure clarifies
the responsibilities of the Card Manager and takes into account both Java Card and Windows Powered Smart
Card.

1.5.2.9    Windows Powered Smart Card API
The GlobalPlatform API for Windows Powered Smart Card is now included in Appendix A.3 - GlobalPlatform
on Windows Powered Smart Card.

1.5.2.10 Java Card API
Taking into account the various new features of the GlobalPlatform a new API (See Appendix A.2 -
GlobalPlatform on a Java Card) providing support for these new, and all relevant existing, features has been
specified for Java Card. The previous Open Platform API for Java Card defined in version 2.0.1' is deprecated
and remains in this version for backward compatibility.

1.5.2.11 Appendices
The body of the GlobalPlatform Card Specification only contains generic GlobalPlatform descriptions. All
information specific to a particular implementation has been positioned in a set of Appendices.


1.5.3      Revisions in GlobalPlatform Card Specification V2.1.1
The following modifications correct issues in the previous version and synchronize with recent evolutions of the
underlying runtime environment specifications while maintaining full backwards compatibility. The minor editing
changes and rewording for readability are not listed.

1.5.3.1    Errata
All intermediate published errata have been incorporated into this version. There is also a small set of errata and
precisions that would have been published at around the same time this version is released, and these have also
been incorporated directly into this version.

1.5.3.2    Content Removal
A new optional Card Content removal feature has been added that allows an Executable Load File and all its
related Applications to be deleted in the same operation.

1.5.3.3    Logical Channels
To meet the emerging needs of some industries and recent evolutions of the underlying runtime environment
specifications, logical channel functionality is added to this version of the specification as an optional feature.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            25

1.5.3.4    Additional Secure Channel Protocol Implementation Options
An enhanced mechanism of generating a C-MAC has been added to both Secure Channel Protocol '01' and Secure
Channel Protocol '02'. One new implementation option has been added for Secure Channel Protocol '01' and four
new implementation options have been added for Secure Channel Protocol '02'. It is recommended that these new
implementation options be used.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
26                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003




                                            Part II
                                         Architecture




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                     GlobalPlatform Card Specification 2.1.1                                                  27


2. System Architecture
Deploying a large number of chip cards based on dynamic, multi-application technology is not unlike deploying a
very large number of workstations in a vast, semi-connected network. These card-based workstations support
several different applications at any one time as well as allow for the possibility of updating or deleting those
applications and installing new applications at any point in time.

                                                                                          6445677



                                                           Cards
                                 Set Top                                 Cell Phones
                                  Boxes                                                   Card
                                                                                       Acceptance
                 Application                                                            Devices
                Development
                   Tools




                                             Global
                                             Open Platform
   Key Management
                                              Open Standards Architecture for                                   Terminal
       Systems                             Dynamic Multiapplication Card Schemes                               Management
                                                                                                                Systems




                                                                                                    Applications
                                                                                                      Servers
             Card Management
                 Systems



                                                       Personalization
                                                          Systems


                                   Figure 2-1: GlobalPlatform Architecture
The GlobalPlatform architecture is designed to provide Card Issuers with the system management architecture for
managing these smart cards. Although GlobalPlatform is based on the paradigm that there is one single Card
Issuer for a card, it offers to the Card Issuer the flexibility for managing an ever-changing array of business
partners who may want to run applications on the Card Issuer's cards.
GlobalPlatform gives Card Issuers the power to manage their cards with the ultimate flexibility by enabling them
to share control over part of their card with business partners. The ultimate control always rests with the Card
Issuer, but through GlobalPlatform, the business partners of a Card Issuer can be allowed to manage their own
Applications on the Card Issuer's cards as appropriate.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
28                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003


3. Card Architecture
The GlobalPlatform card architecture is comprised of a number of components that ensure hardware and vendor-
neutral interfaces to Applications and off-card management systems. The following figure shows the components
in a sample card configuration which includes an application from the Card Issuer as well an application from one
of the business partners of the Card Issuer referred to as an Application Provider.



                                                                                       Application Provider
                                                                                           Application
                               Application Provider
                                Security Domain




                                                                  Card Issuer
                                                                  Application
            Card Manager




                            Issuer
                           Security
                           Domain


                                                   GP API              RTE API

                                      OPEN



                                         Runtime Environment



                                Figure 3-1: GlobalPlatform Card Architecture
All applications shall be implemented in a secure runtime environment that includes a hardware-neutral
Application Programming Interface (API) to support application portability. GlobalPlatform does not mandate a
specific runtime environment technology. The Card Manager is the primary GlobalPlatform card component that
acts as the central administrator for a GlobalPlatform card. Special key and security management applications
called Security Domains are created to ensure complete separation of keys between the Card Issuer and multiple
Application Providers.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            29

3.1      Runtime Environment
The GlobalPlatform is intended to run on top of any secure, multi-application card runtime environment. This
runtime environment is responsible for providing a hardware-neutral API for applications as well as a secure
storage and execution space for applications to ensure that each application's code and data can remain separate
and secure from other applications on the card.


3.2      Card Manager
The Card Manager, as the central administrator of the card, assumes multiple responsibilities.
Some of these responsibilities are the same as, or very close to, those typically performed by the card runtime
environment and are described in Section 3.2.1 - GlobalPlatform Environment (OPEN).
Another major responsibility of the Card Manager is to be the on-card representative of the Card Issuer. Section
3.2.2 - Issuer Security Domain details this responsibility.
The Card Manager can be viewed as three entities:
    x   The GlobalPlatform Environment,
    x   The Issuer Security Domain, and
    x   The Cardholder Verification Methods
These three entities are either incorporated as one or each can be viewed as a distinct separate entity.
See Section 6.1 - Card Manager Overview for a detailed description of the functions and responsibilities of the
Card Manager.


3.2.1      GlobalPlatform Environment (OPEN)
The main responsibilities of the GlobalPlatform Environment (OPEN) are to provide an API to applications,
command dispatch, Application selection, (optional) logical channel management, and Card Content
management. These functions are available if not provided by the runtime environment, or if provided by the
runtime environment in a way not complying with this Specification.
The OPEN performs the application code loading and related Card Content management.
The OPEN also manages the installation of applications loaded to the card. The OPEN is responsible for
enforcing security principles defined for content loading and installation. These principles encompass verification
of the application code and that authorization to load and/or install has been provided by the Card Issuer.
Another important function provided by the OPEN is APDU command dispatching and Application selection.
When a SELECT command is received, the OPEN sets the Application referenced in the SELECT command to
be the selected Application and subsequent Application commands shall be dispatched to the selected
Application.
The availability of logical channels introduces an additional dimension to the card’s architecture as multiple
Applications may be selected concurrently. The OPEN shall rely on the runtime environment to control whether
and when an individual Application can be selected concurrently with itself or another Application. When
supporting logical channels, the OPEN shall allow for Applications that have no notion of logical channels as
well as those that are multi-selectable. Support of logical channels is optional.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
30                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The OPEN owns and uses an internal GlobalPlatform Registry as an information resource for Card Content
management. The GlobalPlatform Registry contains information for managing the card, Executable Load Files,
Applications, Security Domain associations, and privileges.


3.2.2      Issuer Security Domain
The Issuer Security Domain, as the mandatory on-card representative of the Card Issuer, has the capability of
loading, installing, and deleting applications that belong either to the Card Issuer or to other Application
Providers. In this and most other aspects it is very similar to any other Security Domain (see Section 3.3 -
Security Domains) on the card.


3.2.3      Cardholder Verification Management
The Card Manager may provide services related to Cardholder verification (see Section 6.9 - CVM Management).


3.3      Security Domains
Just as the Issuer Security Domain is the on-card representative of the Card Issuer, an Application Provider
Security Domain, referred to simply as a Security Domain, in this Specification is the on-card representative of an
Application Provider or Controlling Authority. A Controlling Authority may exist whose role is to enforce the
security policy on all application code loaded to the card. If so, the Controlling Authority also uses a Security
Domain as its on-card representative.
Security Domains support security services such as key handling, encryption, decryption, digital signature
generation and verification for their owners (Card Issuer, Application Provider or Controlling Authority)
applications.
The Security Domain has application characteristics such as application AID, Application privileges, and Life
Cycle State (the Issuer Security Domain inherits the Life Cycle State of the card). An example of the Security
Domain functioning as an Application is when the Security Domain is selected in order to load a new application
to the card.
Each Security Domain implements a Secure Channel Protocol defining the security applied during
communication between the Card Issuer, Application Provider or Controlling Authority and its on-card Security
Domain.
The Security Domain also provides an interface for Applications to access the Security Domain's services. It has a
well-defined external APDU interface to ensure that all Security Domain implementations behave consistently
and can be managed identically by the same off-card management systems. As the majority of these services and
APDU commands are related to Card Content management, the Security Domain is closely interacting with the
OPEN.
Each Security Domain is established on behalf of a Card Issuer, an Application Provider or a Controlling
Authority when these off-card entities require the use of keys that are completely isolated from each other.


3.4      GlobalPlatform API
The GlobalPlatform API provides services to Applications (e.g. Cardholder verification, personalization, or
security services). It also provides Card Content management services (e.g. card locking or application Life Cycle
State update) to Applications.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            31

For an example of an implementation of the Application Programming Interface (API) on a Java Card™, see
appendix A.2
For an example of an implementation of the Application Programming Interface (API) on a Windows Powered
Smart Card®, see appendix A.3


3.5      Card Content
All Card Content, as defined in this specification, is first available on the card in the form of an Executable Load
File. An Executable Load File can either exist in:
x   Immutable Persistent Memory in which case it is loaded during the manufacturing stage and cannot be
     altered (except being disabled), or
x   Mutable Persistent Memory in which case it can be loaded, or removed during Pre-Issuance or Post-Issuance.
Each Executable Load File may contain one or multiple Executable Modules, being application code. The
installation of an Application creates an instance from an Executable Module plus possibly Application data
within Mutable Persistent Memory. Any Application instance and its related data can be removed. A
GlobalPlatform card is intended to support multiple Executable Load Files and multiple Executable Modules and
as such multiple Applications may co-exist on an GlobalPlatform card.
Figure 3-2 represents the relationship between an Executable Load File, an Executable Module and an
Application.


                                                                     Mutable Persistent Memory


                                                                        Application instance
                      Executable Module
                                                                              and data


                 Executable Load File present
                   in Immutable Persistent                              Application instance
                    Memory or loaded into                                     and data
                  Mutable Persistent Memory


                      Executable Module




                                    Figure 3-2 Card Content Relationships




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
32                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003


4. Security Architecture
Well-designed security architectures are crucial to protecting the structure and function of cards within the
GlobalPlatform system.
This section outlines:
     x   The security goals behind the architecture,
     x   The specific responsibilities of the Card Issuer as the owner of the card,
     x   The Application Providers as the owners of the Applications,
     x   The Controlling Authority,
     x   The security requirements for the on-card components, and
     x   The cryptographic support provided by GlobalPlatform


4.1       Goals
The primary goal of the GlobalPlatform is to ensure the security and integrity of the card's components for the life
of the card. These components are
     x   The runtime environment,
     x   The OPEN,
     x   The Issuer Security Domain
     x   The Security Domains,
     x   The Applications
To ensure card security and integrity, the GlobalPlatform is designed to support a range of secure mechanisms
for:
     x   Data integrity,
     x   Resource availability,
     x   Confidentiality, and
     x   Authentication.
The choice of security policy and cryptography is assumed to be industry and product specific.
Because the cards are only part of a larger card system involving multiple parties and off-card components, the
GlobalPlatform also relies upon non-cryptographic, procedural means of protection, such as code testing and
verification, physical security, and secure key handling. However, these aspects are out of scope for this card
specification.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            33

4.2      Security Responsibilities

4.2.1      Card Issuer's Security Responsibilities
The Card Issuer is responsible for:
    x   Generating and loading the Issuer Security Domain keys,
    x   Enforcing standards and policies for Application Providers governing all aspects of Applications to be
         provided to the Card Issuer or operated on the Card Issuer's cards,
    x   Working with Application Providers to create and initialize Security Domains other than the Issuer
         Security Domain,
    x   Determining policy with regards to card and application Life Cycle management, velocity checking
         levels, Application privileges, and other security parameters,
    x   Managing the application code loading and installing both on a Pre-Issuance and Post-Issuance basis,
         and
    x   Cryptographically authorizing load, install, and extradition to be performed by Application Providers.
         (See Section 6.5 - Delegated Management for a description of the Delegated Management).


4.2.2      Application Provider's Security Responsibilities
The Application Provider is responsible for:
    x   Generating the keys for its own Security Domains or obtaining Security Domain keys from a trusted
         third party,
    x   Working with the Card Issuer to load generated keys into the Application Provider's Security Domain,
    x   Providing applications that meet the Card Issuer's security standards and policies,
    x   Providing application code signatures according to the Application Provider's security policy,
    x   Obtaining pre-authorization for load, install, and extradition from the Card Issuer, and
    x   Returning receipts for load, install, delete, and extradition, according to the Card Issuer's policy.


4.2.3      Controlling Authority's Security Responsibilities
A Controlling Authority is responsible for:
    x   Generating the keys for its own Security Domain or obtaining Security Domain keys from a trusted third
         party,
    x   Working with the Card Issuer to load generated keys into the Controlling Authority's Security Domain,
         and
    x   Providing application code signatures according to its own defined security standards and policies to
         Card Issuers and Application Providers.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
34                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

4.2.4      On-Card Components' Security Requirements

4.2.4.1    Runtime Environment Security Requirements
The runtime environment is responsible for:
     x   Providing an interface to all Applications that ensures that the runtime environment security mechanisms
          cannot be bypassed, deactivated, corrupted or otherwise circumvented,
     x   Performing secure memory management to ensure that:
              Each application's code and data (including transient session data) as well as the runtime
                environment itself and its data (including transient session data) is protected from unauthorized
                access from within the card
              When more than one logical channel is supported, each concurrently selected Application's code
                and data (including transient session data) as well as the runtime environment itself and its data
                (including transient session data) is protected from unauthorized access from within the card
              The previous contents of the memory is not accessible when that memory is reused
              The memory recovery process is secure and consistent in case of a loss of power or withdrawal of
                the card from the card reader while an operation is in progress
(See the appropriate runtime environment documentation for more details).

4.2.4.2    OPEN Security Requirements
The OPEN shall:
     x   Provide an interface to all Applications that ensures that the GlobalPlatform security mechanism cannot
          be bypassed, deactivated, corrupted or otherwise circumvented,
     x   Check application access rules according to the Application privileges.
     x   Manage card and Application Life Cycle (see Chapter 5 - Life Cycle Models)
     x   Ensure that the Card Content changes initiated by a Security Domain other than the Issuer Security
          Domain are authorized by the Card Issuer,
     x   Ensure that application code has been signed by the Controlling Authority represented on the card, and
     x   Ensure that application code has been signed by Application Providers represented on the card, if
          required.

4.2.4.3    Issuer Security Domain Security Requirements
The Issuer Security Domain enforces the security policies of the Card Issuer.
The Issuer Security Domain shall:
     x   Communicate with off-card entities in accordance with the Card Issuer's security policy in Pre-Issuance
          and Post-Issuance,
     x   Manage card data,




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            35

    x    Be able to provide cryptographic protection services for its own Applications during their
          personalization,
    x    Verify the Card Issuer authorization for Card Content changes initiated by a Security Domain other than
          the Issuer Security Domain,
    x    Request the OPEN to load, install, extradite, and delete applications and,
    x    Generate receipts for load, install, extradition, and delete when required by the Card Issuer's security
          policy.

4.2.4.4    CVM Handler Security Requirements
The CVM handler shall:
    x    Be able to provide CVM services to Applications, such as verifying incoming CVM data,
    x    Hold the CVM data securely, and
    x    Perform internal velocity checks on the CVM to prevent card and Application access violations (see
          Section 6.7.4 - Operational Velocity Checking).

4.2.4.5    Security Domains Security Requirements
The Security Domains enforce the security policies of an Application Provider or Controlling Authority. Security
Domains other than the Issuer Security Domain shall:
    x    Communicate with off-card entities in accordance with the Application Provider's security policy,
    x    Be able to provide cryptographic protection services for their associated Applications,
    x    Verify the application signature when requested by the OPEN.
Security Domains authorized by the Card Issuer to perform Card Content changes shall:
    x    Request the OPEN to load, install, extradite, and delete applications and,
    x    Return to the off-card entity any receipt for load, install, extradition, and delete when provided by the
          Issuer Security Domain.

4.2.4.6    Application Security Requirements
Applications should:
    x    Expose only data and resources that are necessary for proper application functionality and,
    x    Perform internal security measures required by the Application Provider.


4.2.5      Back-End System Security Requirements
Despite the best efforts of the card and the loading processes to provide a stable and secure environment, these
components alone cannot ensure total security. The back-end systems (multiple back-end systems may exist for a
single card), which communicate with the cards, perform the verifications, and manage the off-card key
databases, also shall be trusted. Responsible personnel, secure operating systems, system security policies, and
audit procedures are all essential components that secure the back-end systems. These requirements are beyond
the scope of this Specification.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
36                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

4.3       Cryptographic support
One of the major requirements for a GlobalPlatform card is the ability to provide a minimum level of
cryptographic functionality. This cryptography is, for example, used for the generation of signatures, and is
available for use by the Applications present on the card.
The Issuer Security Domain shall implement one Secure Channel Protocol. A Security Domain other than the
Issuer Security Domain shall implement [at least] one Secure Channel Protocol. A GlobalPlatform card should
support symmetric cryptography such as the Data Encryption Standard (DES) algorithm. A GlobalPlatform card
may also support asymmetric cryptography such as the Rivest / Shamir / Adleman (RSA) algorithm.
The following cryptographic services are described in this chapter:
     x   Integrity and authentication
     x   Secure messaging
When present, services to encrypt and decrypt any pattern of data using these algorithms shall be available to
Applications.
It is the responsibility of the Card Issuer or the Controlling Authority to set up the appropriate off-card procedures
to comply with the governmental restrictions upon cryptography. Features to disable or restrict cryptography
usage by Applications on a card are beyond the scope of this Specification.


4.3.1      Integrity and Authentication for Card Content Management
The concepts of integrity and authentication represent an additional value associated with a message or a block of
data.
The purpose of this additional value is to provide a method of verifying the source and/or the integrity of
particular block of code or data.
The choice of cryptographic algorithms for integrity and authentication is assumed to be industry and product
specific.
The following describes the different usages of integrity and authentication for Card Content management in this
Specification.

4.3.1.1    Load File Data Block Hash
The Load File Data Block Hash is intended to verify the integrity of a complete Load File Data Block when
loaded to a GlobalPlatform card. Its intention is to provide a method for the OPEN to verify the integrity of the
Load File Data Block. (See Section 6.4.1.1 - Card Content Loading for further details.)
The Load File Data Block Hash also has two other functions:
     x   It is used in the computation of the Load File Data Block Signature (see Section 4.3.1.2 - Load File Data
          Block Signature).
     x   It is included in the computation of the Load Token (see Section 4.3.1.3 - Delegated Management
          Tokens)




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            37

4.3.1.2    Load File Data Block Signature
The Load File Data Block Signature is an authentication value generated by an off-card entity (an Application
Provider or a Controlling Authority). This is the signature of the Load File Data Block Hash and is included in the
DAP Block of the Load File. One or more DAP Blocks may be included in a Load File.
When present during the loading of a Load File to the card, each signature shall be verified by the appropriate
Security Domain. The verification operation is referred to as Data Authentication Pattern (DAP) Verification.

4.3.1.3    Delegated Management Tokens
Delegated Management Tokens are signatures of one or more Delegated Management functions (loading
application code, installing Applications and extraditing Applications) generated by the Card Issuer and used to
provide the Card Issuer the control over these Card Content changes. Tokens are required when the Issuer
Security Domain is not managing the Card Content changes itself. The Issuer Security Domain shall verify
Tokens.

4.3.1.4    Receipts
The Issuer Security Domain may generate Receipts during Delegated Management. A Receipt is proof to the
Card Issuer that an Application Provider has modified the Card Content.


4.3.2      Secure Communication
A GlobalPlatform card may provide security services related to information exchanged between the card and an
off-card entity. The security level of the communication with an off-card entity does not necessarily apply to each
individual message being transmitted but can only apply to the environment and/or context in which messages are
transmitted. The concept of the Life Cycle of the card (see Section 5.1 - Card Life Cycle) may be used to
determine the security level of the communication between the card and an off-card entity.
The choice of cryptographic algorithms for secure communication is assumed to be industry and product specific.
A GlobalPlatform card offers the following security services associated with messages and defined within a
Secure Channel Protocol (see Chapter 8 - Secure Communication):
    x    Entity authentication - in which the card or the off-card entity proves its authenticity to the other entity
          through a cryptographic exchange;
    x    Integrity and authentication - in which the receiving entity (the card or off-card entity) ensures that the
          data being received from the sending entity (respectively the off-card entity or card) actually came from
          an authenticated entity in the correct sequence and has not been altered; and,
    x    Confidentiality - in which data being transmitted from the sending entity (the off-card entity or card) to
          the receiving entity (respectively the card or off-card entity) is not viewable by an unauthenticated
          entity.
Authentication of the off-card entity combined with the card Life Cycle State allows the card to assume its
environment and/or context.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
38                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003




                                        Part III
                                    Implementation




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            39


5. Life Cycle Models
The GlobalPlatform defines Life Cycle models to control the functionality and security of the following
GlobalPlatform components:
    x    Card,
    x    Executable Load Files,
    x    Executable Modules and
    x    Applications.
The OPEN owns and maintains the Life Cycle information within the GlobalPlatform Registry and manages the
requested state transitions.
The Life Cycle models of each component are presented in this section.


5.1       Card Life Cycle
The OPEN is responsible for maintaining the overall security and administration of the card and its content. As
the OPEN plays this supervisory role over the entire card, its life cycle can be thought of as the life cycle of the
card and is referred to as the card Life Cycle in the subsequent sections.
From a GlobalPlatform perspective, the card Life Cycle begins with the state OP_READY. Although a cards life
includes activities prior to the initial card Life Cycle State, these activities are considered card implementation
specific and are beyond the scope of this Specification.
The end of the card Life Cycle is the state TERMINATED.


5.1.1      Card Life Cycle States
The following card Life Cycle States shall apply:
    1.    OP_READY
    2.    INITIALIZED
    3.    SECURED
    4.    CARD_LOCKED
    5.    TERMINATED
The card Life Cycle States OP_READY and INITIALIZED are intended for use during the Pre-Issuance phases
of the card’s life.
The states SECURED, CARD_LOCKED and TERMINATED are intended for use during the Post-Issuance
phase of the card although it is possible to terminate the card at any point during its life.

5.1.1.1    Card Life Cycle State OP_READY
The state OP_READY indicates that the runtime environment shall be available and the Issuer Security Domain,
acting as the selected Application, shall be ready to receive, execute and respond to APDU commands.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
40                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The following functionality shall be present when the card is in the state OP_READY:
     x   The runtime environment shall be ready for execution,
     x   The OPEN shall be ready for execution,
     x   The Issuer Security Domain shall be the Default Selected Application,
     x   Executable Load Files that were included in Immutable Persistent Memory shall be registered in the
          GlobalPlatform Registry,
     x   An initial key shall be available within the Issuer Security Domain.
The card shall be capable of Card Content changes for applications expected to be available at card issuance, the
loading of the Load Files containing applications not already present in the card may occur.
The installation, from Executable Load Files, of any Application may occur.
Additionally, if any personalization information is available at this stage, Applications may be personalized.
The OP_READY state may be used by an off-card entity to perform the following actions:
     x   Security Domains other than the Issuer Security Domain may be loaded and/or installed,
     x   The Security Domain keys may be inserted in order to maintain a cryptographic key separation from the
          Issuer Security Domain keys.

5.1.1.2    Card Life Cycle State INITIALIZED
The state INITIALIZED is an administrative card production state. The state transition from OP_READY to
INITIALIZED is irreversible. Its functionality is beyond the scope of this Specification. This state may be used to
indicate that some initial data has been populated (e.g. Issuer Security Domain keys and/or data) but that the card
is not yet ready to be issued to the Cardholder.
The card shall be capable of Card Content changes.

5.1.1.3    Card Life Cycle State SECURED
The state SECURED is the intended operating card Life Cycle State in Post-Issuance. This state is used by the
OPEN to enforce the Card Issuer's security policies related to Post-Issuance card behavior such as application
loading, installation and activation. The state transition from INITIALIZED to SECURED is irreversible.
The card shall be capable of Card Content and Application content changes.
The SECURED state should be used to indicate to off-card entities that the Issuer Security Domain contains all
necessary keys and security elements for full functionality.

5.1.1.4    Card Life Cycle State CARD_LOCKED
The Card Life Cycle state CARD_LOCKED is present to provide the Card Issuer with the capability to disable
Security Domain and Applications functionality. The Card Life Cycle state transition from SECURED to
CARD_LOCKED is reversible.
Setting the card to this state means that the card shall no longer function except via the Issuer Security Domain.
Card Content changes including any type of data management (specifically Issuer Security Domain keys and
data) are not allowed in this state.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            41

Either the OPEN, or an Application on the card with the relevant privilege (see Section 6.6.2.4 - Application
Privileges), or an off-card entity authenticated by the Issuer Security Domain may initiate the transition from the
state SECURED to the state CARD_LOCKED.

5.1.1.5    Card Life Cycle State TERMINATED
The state TERMINATED signals the end of the card Life Cycle and the card. The state transition from any other
state to TERMINATED is irreversible. When in the state TERMINATED, all APDU commands shall be routed
to the Issuer Security Domain and the Issuer Security Domain shall only respond to the GET DATA command.
The state TERMINATED shall be used to permanently disable all card functionality including most of the
functionality of the Issuer Security Domain itself. This card state is intended as a mechanism for an Application
to logically 'destroy' the card for such reasons as the detection of a severe security threat or expiration of the card.
The OPEN itself, an Application on the card with the relevant privilege (see Section 6.6.2.4 - Application
Privileges) or an off-card entity authenticated by the Issuer Security Domain may initiate the transition from any
of the previous states to the state TERMINATED.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
42                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

5.1.2      Card Life Cycle Transitions
Figure 5-1 illustrates the state transition diagram for the card Life Cycle. This can typically be viewed as a
sequential process with certain possibilities for reversing a state transition or skipping states.




                                                                        OP_READY




                                                                        INITIALIZED




                                                                        SECURED




                                                                      CARD_LOCKED




                                                                       TERMINATED




                                     Legend
                                     Issuer Security Dom ain
                                     Privileged Application



                                Figure 5-1: Card Life Cycle State Transitions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            43

5.2       Executable Load File/ Executable Module Life Cycle
An Executable Load File is the actual on-card container of one or more application's executable code (Executable
Modules). It may reside in Immutable Persistent Memory or may be created in Mutable Persistent Memory as the
resulting image of a Load File Data Block. The format in which the Executable Load File is stored on the card is
beyond the scope of this Specification.
The OPEN owns and maintains the Executable Load File Life Cycle information within the GlobalPlatform
Registry.


5.2.1      Executable Load File Life Cycle
The Executable Load File Life Cycle can only have one state.

5.2.1.1    Executable Load Life Cycle LOADED
The OPEN shall consider all Executable Load Files present in the card in Immutable Persistent Memory or
Mutable Persistent Memory to be in the state LOADED. An Executable Load File transferred to the card through
a Load File shall become an entry in the GlobalPlatform Registry following the successful completion of the load
process. Executable Load Files present in Immutable Persistent Memory shall automatically have entries within
the GlobalPlatform Registry and be associated with the Issuer's Security Domain.

5.2.1.2    Executable Load File Deletion
The OPEN may receive a request to delete an Executable Load File. If the Executable Load File cannot be
physically deleted (e.g., because it is stored in Immutable Persistent Memory), the following behavior shall apply
except that the actual space cannot be reclaimed.
The space previously used to store a physically deleted Executable Load File is reclaimed and may be reused. The
entries within the GlobalPlatform Registry of the Executable Load File and each Executable Module within the
Executable Load File shall also be removed, and the card shall not keep any records of the Executable Load File's
or Executable Module's previous existence.
If the received request is also intended to delete each of the Applications instantiated from the Executable
Modules within this Executable Load File, then for each of these Applications the behavior described in Section
5.3.1.4 - Application Deletion or Section 5.3.2.5 - Security Domain Deletion shall occur.


5.2.2      Executable Module Life Cycle
The Executable Module Life Cycle is linked to the Executable Load File Life Cycle.


5.3       Application and Security Domain Life Cycle
The Life Cycle of the Application or Security Domain begins when the application is instantiated from an
Executable Module. The Life Cycle reflects states that are controlled by the OPEN and states that are controlled
directly by the Application.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
44                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The Application becomes an entry in the GlobalPlatform Registry and the OPEN sets the Application Life Cycle
State to the initial state of INSTALLED during the Application installation process initiated by the Issuer Security
Domain or the Security Domain associated with the Executable Load File. The OPEN is also responsible for
making the Application available for selection by setting its Life Cycle State to SELECTABLE upon request
during the Application installation process. While the OPEN actually performs these transitions, they may be
initiated from a Security Domain with the Delegated Management privilege.
Once an Application or Security Domain is available for selection, it takes control of managing its own Life
Cycle. The definition of these state transitions is Application or Security Domain dependent and not controlled by
the OPEN.
At any point in the Application or Security Domain Life Cycle, the OPEN may take control for security
protection by setting the Life Cycle State to LOCKED. The OPEN also controls the deletion of an Application
from the card.
The OPEN owns and maintains the Life Cycle State information within the GlobalPlatform Registry. The Issuer
Security Domain may inform off-card entities of Life Cycle States (see Section 9.4 - GET STATUS Command).


5.3.1      Application Life Cycle States
This Specification defines the following Application Life Cycle States:
     1.   INSTALLED
     2.   SELECTABLE
     3.   LOCKED
In addition to these Application Life Cycle States, the Application may define its own Application dependent
states.
Once the Application reaches the SELECTABLE state, it is responsible for managing the next steps of its own
Life Cycle. It may use any Application specific states as long as these do not conflict with the states already
defined by GlobalPlatform. The OPEN may not perform these transitions without instruction from the
Application and the Application is responsible for defining state transitions and ensuring that these transitioning
rules are respected.
Note: Applications using the deprecated API should be aware that when converting to the GlobalPlatform API
the OPEN no longer enforces Application specific Life Cycle State transitions.

5.3.1.1    Application Life Cycle State INSTALLED
The state INSTALLED means that the Application executable code has been properly linked and that any
necessary memory allocation has taken place. The Application becomes an entry in the GlobalPlatform Registry
and this entry is accessible to authenticated off-card entities. The Application is not yet selectable. The
installation process is not intended to incorporate personalization of the Application, which may occur as a
separate step.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            45

5.3.1.2    Application Life Cycle State SELECTABLE
The state SELECTABLE means that the Application is able to receive commands from off-card entities. The state
transition from INSTALLED to SELECTABLE is irreversible. The Application shall be properly installed and
functional before it may be set to the state SELECTABLE. The transition to SELECTABLE may be combined
with the Application installation process.
The behavior of the Application in the state SELECTABLE is beyond the scope of this Specification.

5.3.1.3    Application Life Cycle State LOCKED
The OPEN or the off-card entity authenticated by the Issuer Security Domain uses the state LOCKED as a
security management control to prevent the selection, and therefore the execution, of the Application.
If the OPEN detects a threat from within the card and determines that the threat is associated with a particular
Application, that Application may be prevented from further selection by the OPEN setting the state to LOCKED.
Alternatively, the off-card entity authenticated by the Issuer Security Domain may determine that a particular
Application on the card needs to be locked for a business or security reason and may initiate the Application Life
Cycle transition via the OPEN.
Once the state is LOCKED, only the Issuer Security Domain is allowed to unlock the Application. The OPEN
shall ensure that the Application Life Cycle returns to its previous state.

5.3.1.4    Application Deletion
At any point in the Application Life Cycle, the OPEN may receive a request to delete an Application.
The space previously used to store a physically deleted Application is reclaimed and may be reused. The entry
within the GlobalPlatform Registry is also removed, and the OPEN is not required to maintain a record of the
deleted Application's previous existence.

5.3.1.5    Application Specific Life Cycle States
These states are Application specific. The behavior of the Application, while in these states, is determined by the
Application itself and is beyond the scope of this Specification. The OPEN does not enforce any control on
Application specific Life Cycle State transitions.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
46                             GlobalPlatform Card Specification 2.1.1                                   03/25/2003

Figure 5-2 illustrates the state transition diagram for the Application Life Cycle. This can typically be viewed as a
sequential process with certain possibilities for reversing a state transition or skipping states.




                    LOCKED from INSTALLED                                         INSTALLED




                            LOCKED from
                                                                                SELECTABLE
                            SELECTABLE




                    LOCKED from application
                                                                           Application specific states
                        specific state




              Legend
              Issuer Security Domain
              Associated Privileged
              Security Domain


              Application


                             Figure 5-2: Application Life Cycle State Transitions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            47




5.3.2      Security Domain Life Cycle States
This Specification defines the following states applicable to a Security Domain:
    1.    INSTALLED
    2.    SELECTABLE
    3.    PERSONALIZED
    4.    LOCKED
There are no proprietary Security Domain Life Cycle States.

5.3.2.1    Security Domain Life Cycle State INSTALLED
The state INSTALLED means that the Security Domain becomes an entry in the GlobalPlatform Registry and this
entry is accessible to authenticated off-card entities. The Security Domain is not yet available for selection. It
cannot be associated with Executable Load Files or Applications yet and therefore its Security Domain services
are not available to Applications.

5.3.2.2    Security Domain Life Cycle State SELECTABLE
The state SELECTABLE means that the Security Domain is able to receive commands (specifically
personalization commands) from off-card entities. As they still do not have keys, the Security Domains cannot be
associated with Executable Load Files or Applications and therefore their services are not available to
Applications when they are in this state. The state transition from INSTALLED to SELECTABLE is irreversible.
The transition to SELECTABLE may be combined with the Security Domain installation process.

5.3.2.3    Security Domain Life Cycle State PERSONALIZED
The definition of what is required for a Security Domain to transition to the state PERSONALIZED is Security
Domain dependent but is intended to indicate that the Security Domain has all the necessary personalization data
and keys for full runtime functionality (i.e. usable in its intended environment). The transition from
SELECTABLE to PERSONALIZED (initiated by the Security Domain itself) is irreversible.
In the state PERSONALIZED, the Security Domain may be associated with Applications and its services become
available to these associated Applications.

5.3.2.4    Security Domain Life Cycle State LOCKED
The OPEN or the off-card entity authenticated by the Issuer Security Domain uses the state LOCKED as a
security management control to prevent the selection of the Security Domain.
If the OPEN detects a threat from within the card and determines that the threat is associated with a particular
Security Domain, that Security Domain may be prevented from further selection by the OPEN setting the
Security Domain's Life Cycle State to LOCKED.
Alternatively, the off-card entity authenticated by the Issuer Security Domain may determine that a particular
Security Domain on the card needs to be locked for a business or security reason and may initiate the state
transition via the OPEN.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
48                                 GlobalPlatform Card Specification 2.1.1                             03/25/2003

In this state, the Security Domain is prevented from being used for Delegated Management if applicable. Locking
a Security Domain prevents this Security Domain from being associated with new Executable Load Files or
Applications and prohibits access to that Security Domain's services by Applications through the OPEN. In this
state, when requested by the OPEN to perform DAP Verification, the Security Domain shall indicate that
verification of the Load File Data Block Signature failed.
Once the Life Cycle State is LOCKED, only the Issuer Security Domain is allowed to unlock the Security
Domain. The OPEN shall ensure that the Security Domain's Life Cycle returns to its previous state.

5.3.2.5    Security Domain Deletion
At any point in the Security Domain Life Cycle, the OPEN may receive a request to delete a Security Domain.
The space previously used to store a physically deleted Security Domain is reclaimed and may be reused. The
entry within the GlobalPlatform Registry is also removed, and the OPEN is not required to maintain a record of
the deleted Security Domain's previous existence.
Figure 5-3 illustrates the state transition diagram for the Security Domain Life Cycle. This can typically be
viewed as a sequential process with certain possibilities for reversing a state transition or skipping states.




                      LOCKED from INSTALLED                      INSTALLED




                               LOCKED from
                                                                SELECTABLE
                               SELECTABLE




                            LOCKED from
                                                               PERSONALIZED
                           PERSONALIZED




       Legend
       Issuer Security Domain
       Associated Privileged
       Security Domain


       Security Domain



                          Figure 5-3: Security Domain Life Cycle State Transitions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            49

5.4      Sample Life Cycle Illustration
This section provides a description of a sample GlobalPlatform card and its Life Cycle transitions from the card's
creation to the time it is terminated. It also shows the status of several Executable Load Files, Executable
Modules and Applications and their relationship with the card life cycle. Figure 5-4 illustrates these sample Life
Cycle States:
Application A: Application code is present as an Executable Module within an Executable Load File in Mutable
Persistent Memory when the card is manufactured. It is installed in an implementation specific manner. It is used
throughout the card's life until the card is terminated and as long as the card is not in a CARD_LOCKED state.
Application B: Application code is present as an Executable Module within an Executable Load File in
Immutable Persistent Memory when the chip is manufactured. It is installed prior to the card being initialized.
Application B, along with its Executable Load File, is deleted some time during the card's life before the card is
terminated. Because the Executable Load File for Application B is stored in Immutable Persistent Memory, it
cannot be physically deleted from the card.
Application C: Application code is present as an Executable Module within an Executable Load File and is
loaded in an implementation specific manner. The Application is installed in Post-Issuance while the card is in the
Life Cycle State SECURED. The Application is used for some time and then deleted along with its Executable
Load File before the card is terminated. Because the Application and its Executable Load File are stored in
Mutable Persistent Memory, the Application and associated Executable Load File, along with all its Executable
Modules, are purged from Mutable Persistent Memory and the memory space reclaimed for reuse.
Application D: Application code is present as an Executable Module within an Executable Load File and is
loaded in an implementation specific manner. It is used during the full lifetime of the card until the card is
terminated and as long as the card Life Cycle State is not CARD_LOCKED.
Application E: Application code is present as an Executable Module within an Executable Load File that is
loaded and installed in Post-Issuance while in the card Life Cycle State SECURED. Application E is used until
the card is terminated and as long as the card Life Cycle State is not CARD_LOCKED.
Application F: Application code is present as an Executable Module within the same Executable Load File as
Application E. It is loaded and installed in Post-Issuance while in the card Life Cycle State SECURED.
Application F is deleted some time during the card's lifetime.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
50                               GlobalPlatform Card Specification 2.1.1                                    03/25/2003

                               EXECUTABLE
                                LOAD FILE
                               EXECUTABLE
        EXECUTABLE              MODULE B
         LOAD FILE

        EXECUTABLE                                     OP_READY
         MODULE A                 install

                              Application B

          install
                                                                            EXECUTABLE
                                                    INITIALIZED              LOAD FILE
                                                                            EXECUTABLE
                                                                             MODULE D
                                                  EXECUTABLE
       Application A                               LOAD FILE
                                                                               install
                                                  EXECUTABLE
                                                   MODULE C
                                                                           Application D




                             use Application B
                                                    install
                                                                                             EXECUTABLE LOAD FILE
                                                                                              EXECUTABLE
                                                                                               MODULE E

                                                                                                          EXECUTABLE
                                                                                                           MODULE F


                                                 Application C
                                                                                                install      install

     use Application A
                                                                         use Application D            Application F
                                              use Application C
                                                                                             Application E
                                  DELETE
                                                                                                    use Application F
                                                    DELETE



                                                                                                            DELETE

                                                              SECURED                      use Application E


       Application A                                                            Applications D and E
                                                     CARD_LOCKED
        Unusable                                                                      Unusable



        END-OF-LIFE                                    TERMINATED           END-OF-LIFE       END-OF-LIFE




                         Figure 5-4: Sample Card Life Cycle and Application Life Cycles




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            51


6. Card Manager

6.1      Card Manager Overview
The Card Manager is the card component responsible for all card administration and card system service
functions.
Section 3.2 - Card Manager provides a general overview of the Card Manager, the OPEN, the Issuer Security
Domain and the CVM handler.


6.1.1      OPEN
The OPEN supports the following functions if the underlying runtime environment does not support them:
    x   Command Dispatch
              Application selection
              (Optional) Logical channel management
              Command dispatching
    x   Card Content Management
              Content verification
              Content loading
              Content installation
              Content removal
    x   Security Management
              Security Domain locking
              Application locking
              Card locking
              Card termination
              Application privilege usage
              Security Domain privilege usage
              Tracing and event logging
The OPEN architecture may be illustrated as a collection of system functions built upon a GlobalPlatform
Registry. The GlobalPlatform Registry is a data store required to support the various system functions of the
GlobalPlatform:




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
52                            GlobalPlatform Card Specification 2.1.1                                              03/25/2003




                                                                                             Security Management
                                                                        Content Management
                                                   Command Dispatch
                                                                      Registry




                                         Figure 6-1: OPEN Architecture
The following are some examples of the use of the GlobalPlatform Registry by the OPEN.

Command Dispatch:
     x   Determine if an Application is present and available to respond to a SELECT command,
     x   When supported, manage logical channels,
     x   Dispatch commands to the selected Application for command processing.

Card Content Management:
     x   Store state and management information about newly loaded Executable Load Files, Executable
          Modules, and installed Applications.
     x   Store the Security Domain to be associated with Executable Load Files being loaded,
     x   Store the privileges and associated Security Domains of the Applications being installed,
     x   Identify an Application's associated Security Domain to provide access for that Application to its
          Security Domain services.

Security Management:
     x   Allow the Card Issuer to audit the Card Content by retrieving status information related to any
          Application present on the card,
     x   Verify and request verification of the authenticity for Executable Load Files,
     x   Verify that Card Content functions are being initiated by Security Domains with the Delegated
          Management privilege,
     x   Verify that resource restrictions are respected during loading and installing of new content and during
          Application runtime execution,
     x   Verify an Application's accessibility to functionality that requires privileges.
The OPEN shall verify the Application privileges before accessing the CVM functionality.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            53

Accessing the OPEN functions by an off-card entity is achieved through the Issuer Security Domain APDU
command interface and for on-card applications through an API. An Application shall use the OPEN API to
communicate with the OPEN from within the card. However, the OPEN retains control of the services and
determines on an individual request basis whether or not to grant each request.


6.1.2      Issuer Security Domain
The Issuer Security Domain, as implied by its name, has functionality very similar to a Security Domain and in
addition to the functionality described herein (Chapter 6 - Card Manager), most of the functionality defined in
Chapter 7 - Security Domains also applies to the Issuer Security Domain. The 2 features that may apply to a
Security Domain but do not apply to the Issuer Security Domain are Delegated Management and DAP
Verification.
The Issuer Security Domain supports the following functions:
    x   Secure Communication for Card Content management
    x   Secure communication support for Applications during:
              Application personalization
              Application runtime
The Issuer Security Domain is responsible for the management of its data (e.g. the card's Issuer Identification
Number).
The APDU command interface, through the Issuer Security Domain, exists primarily to manage card
administration functions, and in that capacity only the authenticated Card Issuer is allowed to access this interface
through the Issuer Security Domain.
The API is the interface that Applications use to request services from the Issuer Security Domain. Only
Applications associated with the Issuer Security Domain are allowed to use the Issuer Security Domain API
services from within the card.


6.1.3      CVM Handler
The CVM handler is responsible for Cardholder verification, including velocity checking.
The API is the interface that Applications use to request services from the CVM.


6.2      Card Manager Services
Appendix A.2 - GlobalPlatform on a Java Card provides the Java Card™ implementation of the following
interfaces.
Appendix A.3 - Application API Interface on Windows Powered Smart Card provides the Windows Powered
Smart Card implementation of the following interfaces.


6.2.1      Application Access to OPEN Services
Applications may access and/or modify some content known or managed by the OPEN. The following services
shall be provided by the OPEN:




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
54                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

     x   Retrieving the Application's own Life Cycle State stored by the OPEN in the GlobalPlatform Registry,
     x   Retrieving the card Life Cycle State,
     x   Obtaining access to the services of the Security Domain associated with the Application,
     x   Transitioning the card Life Cycle State to CARD_LOCKED (depending on the Application relevant
          privilege),
     x   Setting the content of the historical characters in the Answer-to-Reset (ATR) (depending on the
          Application relevant privilege),
     x   Transitioning the Application's own Application Life Cycle State stored by the OPEN in the
          GlobalPlatform Registry,
     x   Transitioning the card Life Cycle State to TERMINATED (depending on the Application relevant
          privilege),


6.2.2      Application Access to CVM Services
This version of the Specification only supports one Cardholder Verification Method (CVM) service that is the
global PIN.
The following services surrounding the CVM handler may be accessed by an Application. The following services
shall be provided by the CVM:
     x   Retrieving the CVM state (e.g. to determine if the CVM value has been submitted, verified or blocked),
     x   Retrieving the number of remaining times the CVM value can be incorrectly presented prior to the CVM
          being blocked,
     x   Setting a new value for the CVM value. This depends on the Application having the relevant privilege,
     x   Requesting that the OPEN verify the content of an incoming CVM value by comparing the incoming
          CVM value to the stored CVM value.
     x   Setting the maximum number of times the CVM value can be incorrectly presented prior to the CVM
          being blocked. This depends on the Application having the relevant privilege.


6.2.3      Application Access to Issuer Security Domain Services
Applications associated with the Issuer Security Domain have the ability to access Issuer Security Domain
services. By using these services, the Application may rely on cryptographic support from the Issuer Security
Domain to ensure confidentiality and integrity during personalization and runtime. The implementation of these
services is beyond the scope of this Specification.
The Issuer Security Domain services defined in this Specification are generic and shall encompass the following
services.
     x   Initiating a Secure Channel,
     x   Verifying the off-card Card Issuer,
     x   Creating a Secure Channel upon successful verification of the off-card Card Issuer,
     x   Providing a method of mutual authentication between the card and a off-card Card Issuer,




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            55

    x   Unwrapping a command received within a Secure Channel,
    x   Verifying the integrity when unwrapping,
    x   Obtaining the original data in the case of confidentiality when unwrapping,
    x   Controlling the sequence of APDU commands,
    x   Decrypting and possibly verifying a secret data block,
    x   Closing a Secure Channel upon request, and
    x   Destroying any secret created by the act of setting up a Secure Channel.
Depending on the specific Secure Channel Protocol supported, the Issuer Security Domain services may also
encompass the possibility of:
    x   Wrapping a response sent within a Secure Channel (adding integrity and/or encrypting the original data
         in the case of confidentiality), and
    x   Controlling the sequence of APDU responses.


6.2.4      Issuer Security Domain Access to Applications
The Issuer Security Domain has the facility to receive a STORE DATA command destined to one of its
associated Applications. The Issuer Security Domain pre-processes this command according to the current Secure
Channel and prior to the command being forwarded to the Application.


6.3      Command Dispatch
The commands received by a GlobalPlatform card shall either be processed by the OPEN or dispatched to the
selected Application for processing.
The SELECT [by name] command is processed by the OPEN.
The processing of the MANAGE CHANNEL command is dependant on the capabilities of the card:
    x   If the card is aware of logical channels but only supports the Basic Logical Channel, the OPEN shall
         respond with the appropriate error,
    x   If the card is aware of logical channels and supports at least one Supplementary Logical Channel, the
         OPEN shall process the command, or
    x   If the card only supports the Basic Logical Channel and has no concept of logical channel support, the
         command shall be dispatched to the selected Application for processing.
Any other type of command received shall be dispatched to the currently selected Application.
Commands are either received on the Basic Logical Channel (logical channel number zero) or on a
Supplementary Logical Channel (logical channel number 1, 2, or 3). In compliance with ISO/IEC 7816-4, logical
channel information shall be indicated in the lower 2 bits of the class byte of the APDU command header. For all
commands, if the command indicates a Supplementary Logical Channel that is not opened then:
    x   If the card only supports the Basic Logical Channel and has no concept of logical channel support, the
         command shall be dispatched to the selected Application for processing.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
56                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

     x   If the card is aware of logical channels, the OPEN shall respond with the appropriate error. (This
          requirement may exclude the SELECT command, if the card supports opening of a logical channel using
          the SELECT command.)
For commands that are dispatched to an Application, it is the responsibility of the Application to correctly reject
commands that it does not recognize, expect or cannot process.
The way in which an Application exhibits its multi-selection capabilities can vary according to the underlying
platform and is beyond the scope of this Specification.
The Issuer Security Domain shall have no multi-selection restrictions on cards that support multiple logical
channels i.e. it shall be capable of being selected across multiple logical channels.


6.3.1       Basic Logical Channel
The Basic Logical Channel is the permanently available interface to a GlobalPlatform card. This Basic Logical
Channel shall be supported by the OPEN.

6.3.1.1     Application Selection on Basic Logical Channel
The OPEN shall support Application selection on the Basic Logical Channel via two processes:
     x   Implicit Selection following the Answer to Reset,
     x   Explicit Selection through the SELECT [by name] command.
The OPEN may also support additional selection processes.
Partial AID selection as defined in Section 6.3.1.1.2 - Explicit Selection, shall be supported. (Partial AID selection
does not require knowledge of the full AID by the off-card entity.) As multiple Applications on the card may have
the same partial AID, it is required that a method exists to select all Applications matching the partial AID.


6.3.1.1.1    Implicit Selection on Basic Logical Channel
After the Answer-to-Reset (ATR) and before the first command is issued to the card, the default selectable
Application shall become the selected Application on the Basic Logical Channel.

Runtime Behavior
The following requirements apply for the OPEN for the implicit Application selection process:
     x   If the card is in the Life Cycle States CARD_LOCKED or TERMINATED, the Issuer Security Domain
          is the selected Application on the Basic Logical Channel and the OPEN shall not attempt to identify the
          default selectable Application.
     x   In all other cases the OPEN shall search the GlobalPlatform Registry for an Application that is marked
          with the Default Selected privilege and if this Application is not in the Life Cycle State LOCKED, it
          shall become the selected Application on the Basic Logical Channel. If this is an Application in the Life
          Cycle State LOCKED, the Issuer Security Domain shall become the selected Application on the Basic
          Logical Channel.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            57

6.3.1.1.2    Explicit Selection on Basic Logical Channel
At any time during a Card Session the OPEN may receive a request to select an Application on the Basic Logical
Channel (SELECT [by name] [first or only occurrence] command). The OPEN shall determine if the requested
AID matches or partially matches an entry within the GlobalPlatform Registry and whether this entry is
selectable.
At any time during a Card Session that has already contained a SELECT [by name] [first or only occurrence]
command, the OPEN may receive a request to select a next Application (SELECT [by name] [next occurrence]
command) on the Basic Logical Channel. The OPEN shall determine if the requested AID matches or partially
matches another entry within the GlobalPlatform Registry and whether this entry is selectable
For both the SELECT [by name] [first or only occurrence] command and the SELECT [by name] [next
occurrence] command, an Application becomes the selected Application on the Basic Logical Channel if:
    x   The requested AID matches (fully or partially) the Application’s AID,
    x   The Application being selected is in the correct Life Cycle State.
    x   The Application has no restrictions due to multi-selection.

Runtime Behavior
The following requirements apply to the OPEN in the explicit Application selection (SELECT [by name]) process
on the Basic Logical Channel (This behavior does not apply if the card Life Cycle State is TERMINATED):
    x   In the card Life Cycle State CARD_LOCKED:
               If the Application being selected is the Issuer Security Domain, the Issuer Security Domain is re-
                 selected and a warning is returned to the off-card entity.
               If any other Application is being selected, the Issuer Security Domain remains selected and an
                 error is returned to the off- card entity.
    x   If a SELECT [by name] [first or only occurrence] or SELECT [by name] [next occurrence] is received
         and the data field of the command message is not present, the Issuer Security Domain shall become the
         currently selected Application and the SELECT command is dispatched to the Issuer Security Domain.
    x   If a SELECT [by name] [first or only occurrence] is received, the search always begins from the start of
         the GlobalPlatform Registry.
    x   If a SELECT [by name] [next occurrence] is received, the search always begins from the entry following
         the currently selected Application on the Basic Logical Channel in the GlobalPlatform Registry.
    x   If a full or partial match is found and this Application is in the Life Cycle State INSTALLED or
         LOCKED, continue searching through the GlobalPlatform Registry for a subsequent full or partial
         match. If no subsequent full or partial match is found, the OPEN shall return the appropriate error to the
         off-card entity.
    x   If a full or partial match is found and this Application cannot be selected due to a multi-selection
         restriction, continue searching through the GlobalPlatform Registry for a subsequent full or partial
         match. If no subsequent full or partial match is found, the OPEN shall return the appropriate error to the
         off-card entity.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
58                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

     x   If a full or partial match is found and this Application is selectable (i.e. in the correct Life Cycle State
          and has no multi-selection restrictions), then it shall become the currently selected Application on the
          Basic Logical Channel and the SELECT [by name] command, whether [first or only occurrence] or
          [next occurrence], is dispatched to the Application.
     x   If no full or partial match is found at all, the currently selected Application on the Basic Logical Channel
          shall remain the selected Application and
              If the SELECT [by name] command has the [first or only occurrence] parameter set, the SELECT
                command is dispatched to the Application.
              If the SELECT [by name] command has the [next occurrence] parameter set, the OPEN shall
                return the appropriate error to the off-card entity.

6.3.1.2    Logical Channel Management on Basic Logical Channel
At any time during a Card Session the OPEN may receive a request on the Basic Logical Channel to either open
or close a Supplementary Logical Channel.
If the card only supports the Basic Logical Channel and has no concept of logical channel support, the MANAGE
CHANNEL command is dispatched to the currently selected Application. In this case, when a Security Domain is
the currently selected Application, the command shall be rejected.
On cards that support logical channels, if a MANAGE CHANNEL [open] is received, the default selectable
Application becomes the selected Application on the newly opened Supplementary Logical Channel. The default
selectable Application must have no multi-selection restrictions in order for the MANAGE CHANNEL [open] to
be successful.
On cards that support logical channels, if a MANAGE CHANNEL [close] is received, terminate the Application
Session currently selected on the Supplementary Logical Channel indicated by the command and then close that
logical channel. The Basic Logical Channel can never be closed.

Runtime Behavior
On receipt of a MANAGE CHANNEL [open] command, the following requirements apply:
     x   If the card is in the Life Cycle State CARD_LOCKED or TERMINATED, return the appropriate error.
     x   If the number of logical channels supported by the OPEN is not sufficient to open a new Supplementary
          Logical channel, return the appropriate error.
     x   The OPEN shall search the GlobalPlatform Registry for the Application that is marked with the Default
          Selected privilege and:
              If this is an Application in the Life Cycle State LOCKED, the Issuer Security Domain shall
                become the selected Application on the Supplementary Logical Channel.
              If this Application cannot be selected due to a multi-selection restriction, the new logical channel
                shall not be opened and the OPEN shall return the appropriate error.
              Otherwise, the Supplementary Logical Channel is opened and this Application shall become the
                selected Application on the Supplementary Logical Channel.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            59

6.3.1.3     Application Command Dispatch on Basic Logical Channel
Once an Application becomes the selected Application on the Basic Logical Channel, the responsibility for
subsequent command dispatching still rests with the OPEN.
Except for the SELECT [by name] commands described in section 6.3.1.1.2 - Explicit Selection that require the
OPEN to return an appropriate error, all SELECT [by name] commands, once processed by the OPEN, are
dispatched to the Application currently selected on the Basic Logical Channel.
On cards that are aware of logical channels, the MANAGE CHANNEL commands are only processed by the
OPEN and are not dispatched to an Application.
All other commands (including the MANAGE CHANNEL commands on cards that are not aware of logical
channels or SELECT commands not described in section 6.3.1.1.2 - Explicit Selection) are immediately
dispatched to the Application currently selected on the Basic Logical Channel. The processing of the command
by the Application is beyond the scope of this Specification.


6.3.2       Supplementary Logical Channel
A Supplementary Logical Channel, if supported, allows an Application to be selected simultaneously to the
Applications selected on other logical channels.

6.3.2.1     Application Selection on Supplementary Logical Channel
The OPEN shall support Application selection on an available Supplementary Logical Channel via two processes:
    x    Implicit Selection following a successful MANAGE CHANNEL [open] command,
    x    Explicit Selection through the SELECT [by name] command.
The OPEN may also support additional selection processes.
Partial AID selection as defined in section 6.3.2.1.2 - Explicit Selection, shall be supported on Supplementary
Logical Channels.


6.3.2.1.1    Implicit Selection on Supplementary Logical Channel
Depending on whether a Supplementary Logical Channel is being opened from the Basic Logical Channel or
from another Supplementary Logical Channel, the behavior of implicit selection differs.
Refer to section 6.3.1.2 - Logical Channel Management for the behavior of implicit selection initiated from the
Basic Logical Channel.
Refer to section 6.3.2.2 - Logical Channel Management for the behavior of implicit selection initiated from a
Supplementary Logical Channel.


6.3.2.1.2    Explicit Selection on Supplementary Logical Channel
At any time on an open Supplementary Logical Channel, the OPEN may receive a request to select an
Application on this Supplementary Logical Channel (SELECT [by name] [first or only occurrence] command).
The OPEN shall determine if the requested AID matches or partially matches an entry within the GlobalPlatform
Registry and whether this entry is selectable.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
60                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

At any time on an open Supplementary Logical Channel that has already contained a SELECT [by name] [first or
only occurrence] command since the Supplementary Logical Channel was last opened, the OPEN may receive a
request to select a next Application (SELECT [by name] [next occurrence] command) on this Supplementary
Logical Channel. The OPEN shall determine if the requested AID matches or partially matches another entry
within the GlobalPlatform Registry and whether this entry is selectable.
For both the SELECT [by name] [first or only occurrence] command and the SELECT [by name] [next
occurrence] command, an Application becomes the selected Application on the Supplementary Logical Channel
if:
     x   The requested AID matches (fully or partially) the Application’s AID,
     x   The Application being selected is in the correct Life Cycle State.
     x   The Application has no restrictions due to multi-selection.

Runtime Behavior
The following requirements apply to the OPEN in the explicit Application selection (SELECT [by name]) process
on a Supplementary Logical Channel:
     x   If the card is in the Life Cycle State CARD_LOCKED or TERMINATED:
              Close the Supplementary Logical Channel, if currently open.
              Return the appropriate error.
     x   If a SELECT [by name] [first or only occurrence] or SELECT [by name] [next occurrence] is received
          and the data field of the command message is not present, the Issuer Security Domain shall become the
          currently selected Application and the SELECT command is dispatched to the Issuer Security Domain.
     x   If a SELECT [by name] [first or only occurrence] is received, the search always begins from the start of
          the GlobalPlatform Registry.
     x   If a SELECT [by name] [next occurrence] is received, the search always begins from the entry following
          the currently selected Application on this Supplementary Logical Channel in the GlobalPlatform
          Registry.
     x   If a full or partial match is found and this Application is in the Life Cycle State INSTALLED or
          LOCKED, continue searching through the GlobalPlatform Registry for a subsequent full or partial
          match. If no subsequent full or partial match is found, the OPEN shall return the appropriate error to the
          off-card entity.
     x   If a full or partial match is found and this Application cannot be selected due to a multi-selection
          restriction, continue searching through the GlobalPlatform Registry for a subsequent full or partial
          match. If no subsequent full or partial match is found, the OPEN shall return the appropriate error to the
          off-card entity.
     x   If a full or partial match is found and this Application is selectable (i.e. in the correct Life Cycle State
          and has no multi-selection restrictions), then it shall become the currently selected Application on this
          Supplementary Logical Channel and the SELECT [by name] command, whether [first or only
          occurrence] or [next occurrence], is dispatched to the Application.
     x   If no full or partial match is found at all, the currently selected Application on the Supplementary
          Logical Channel shall remain the selected Application and




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            61

              If the SELECT [by name] command has the [first or only occurrence] parameter set, the SELECT
                command is dispatched to the Application.
              If the SELECT [by name] command has the [next occurrence] parameter set, the OPEN shall
                return the appropriate error to the off-card entity.

6.3.2.2    Logical Channel Management on Supplementary Logical Channel
At any time on an open Supplementary Logical Channel the OPEN may receive a request to either open or close a
Supplementary Logical Channel.
If a MANAGE CHANNEL [open] is received and the Application selected on the original Supplementary
Logical Channel has no multi-selection restrictions, this Application becomes the selected Application on the
newly opened Supplementary Logical Channel.
If a MANAGE CHANNEL [close] is received, terminate the Application Session currently selected on the
Supplementary Logical Channel indicated by the command and then close that logical channel. The Basic Logical
Channel can never be closed.

Runtime Behavior
On receipt of a MANAGE CHANNEL [open] command, the following requirements apply:
    x    If the card is in the Life Cycle State CARD_LOCKED or TERMINATED, return the appropriate error.
    x    If the number of logical channels supported by the OPEN is not sufficient to open a new Supplementary
          Logical Channel, return the appropriate error.
    x    If the Application currently selected on the original Supplementary Logical Channel cannot be selected
          on the new Supplementary Logical Channel due to a multi-selection restriction, the new logical channel
          shall not be opened and the OPEN shall return the appropriate error.
    x    Otherwise, the Supplementary Logical Channel indicated by the command is opened and the Application
          currently selected on the original Supplementary Logical Channel shall become the selected Application
          on the newly opened Supplementary Logical Channel.

6.3.2.3    Application Command Dispatch on Supplementary Logical Channel
Once an Application becomes the selected Application on a Supplementary Logical Channel, the responsibility
for subsequent command dispatching still rests with the OPEN.
Except for the SELECT [by name] commands described in section 6.3.2.1.2 - Explicit Selection that require the
OPEN to return an appropriate error, all SELECT [by name] commands, once processed by the OPEN, are
dispatched to the Application currently selected on the Supplementary Logical Channel.
The MANAGE CHANNEL commands are only processed by the OPEN and are not dispatched to an
Application.
All other commands (including SELECT commands not described in section 6.3.2.1.2 - Explicit Selection) are
immediately dispatched to the Application currently selected on the Supplementary Logical Channel. The
processing of the command by the Application is beyond the scope of this Specification.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
62                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

6.4      Card Content Management
Card Content management on a GlobalPlatform card includes the capability for the loading, installation, and
removal of Card Content. The OPEN is responsible for the Card Content management even though a Security
Domain receives the initial requests (APDU commands).
The OPEN may prohibit more than one Card Content management operation occuring concurrently.
The following sections describe the implementation and the OPEN requirements to support Card Content loading,
installation, removal and extradition.
Card Content management shall be prohibited in the Card Life Cycle States CARD_LOCKED or
TERMINATED.


6.4.1      Card Content Loading and Installation
The GlobalPlatform Card Content loading process is designed to allow the addition of code to Mutable Persistent
Memory in the card. Card Content loading may be prohibited if a load process is already in progress on another
logical channel.
The Issuer Security Domain shall verify the transmission of the Load File from the off-card entity to the card, and
when applicable, Security Domains with the relevant privilege shall verify the integrity of the Load File Data
Block before the OPEN commits the new content to memory.
The GlobalPlatform Card Content installation process is designed to allow the Card Issuer to make previously
loaded application code executable on the card.
All Card Content installation shall be combined within a load process or performed within an install process.
The Load File Data Block contains the information required in order to create an Executable Load File. The
internal organization of the Load File Data Block is beyond the scope of this Specification. The Java Card™ CAP
file definition and Windows® Powered Smart Card OPL format are examples of an expected Load File Data
Block. The Load File Data Block may also contain information on the Load File Data Block attributes such as its
name, version number and size. The Card Content loading and installation process may include implementation
specific linking and actual verification of the executable code. Additional authentication data may also be present
in the Load File. (See Section 7.7 - Delegated Management Tokens and Receipts and DAP Verification for more
details).
Upon the successful completion of the Card Content loading, an Executable Load File shall be present on the card
and the OPEN shall create an entry in the GlobalPlatform Registry for the Executable Load File. The OPEN shall
also create an entry in the GlobalPlatform Registry for each Executable Module present within an Executable
Load File. However, Executable Modules are not yet ready for execution. Applications shall then be installed,
resulting in another entry in the GlobalPlatform Registry.
Figure 6-2 details the two possible phases of the Card Content loading and installation.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            63


                                                                 Load
    Loading Phase                                               Request



                                                                 Load 1
                                                                    .
                                                                    .
                                                                    .

                                                                 Load n




                                                                 Install
    Installation Phase                                         Application




                                Figure 6-2: Loading and Installation Process
The Issuer Security Domain has the implied privilege for loading any Load File to the card regardless of which
Security Domain the Executable Load File is being associated with (this equates to extradition of the Load File).
The Issuer Security Domain also has the implied privilege for installing any Application on the card regardless of
which Security Domain the Executable Load File containing the Executable Module is associated with.

6.4.1.1    Card Content Loading
The phases in Figure 6-2 use a combination of multiple occurrences of two different APDU commands
(INSTALL and LOAD). The following sequence of APDU commands apply to the loading:
    x    An INSTALL [for load] command serves as the load request for loading. The INSTALL [for load]
          command data field details the requirements regarding a Load File.
    x    Multiple LOAD commands are then used to transport the Load File in blocks according to the size of the
          file and the communications buffer size of the card.
    x    The INSTALL and LOAD commands are processed by the Issuer Security Domain before forwarding
          the load request and Load File to the OPEN for processing.
This Specification allows for two scenarios regarding an executable Application becoming present on a card:
    x    The Load File is loaded into the card and stored in memory as an Executable Load File. The installation
          phase occurs immediately following the loading phase.
    x    The Load File is loaded into the card and stored in memory as an Executable Load File. The installation
          phase occurs at some time in the future, separate from the loading process.

Runtime Behavior (loading)
The following runtime behavior requirements apply to the OPEN during the content loading process:
    x    On receipt of a load request (data contained in the INSTALL [for load] command), the OPEN shall:




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
64                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

              Check that the AID of the Load File is not already present in the GlobalPlatform Registry as an
                Executable Load File or Application,
              If an associated Security Domain AID is present, check that this AID exists within the
                GlobalPlatform Registry, that the associated Security Domain has the relevant privilege, and that
                the associated Security Domain is in a valid Life Cycle State (i.e. PERSONALIZED) (see Section
                5.3.2 - Security Domain Life Cycle States). As this equates to the extradition of the Load File to a
                Security Domain other than that performing the load, request this Security Domain to indicate
                whether it accepts Card Content extraditions.
     x   On receipt of the Load File (one or more LOAD commands), the OPEN shall:
              Verify the resource requirements of the Load File,
              Check in the GlobalPlatform Registry if any Security Domain has the privilege for mandating
                authentication (mandated DAP Verification privilege) of the Load File Data Block and if so:
                     9 Ensure that the required authentication data (DAP Block identifying the above Security
                          Domain) is present in the Load File.
              Check in the GlobalPlatform Registry if the associated Security Domain has the privilege for
                authenticating (DAP Verification privilege) the Load File Data Block and if so:
                     9 Ensure that the required authentication data (DAP Block identifying the associated
                          Security Domain) is present in the Load File.
              If authentication data (one or more DAP Blocks) is present in the Load File;
                     9 Ensure that a Load File Data Block Hash was received during the load request process.

                     9 Extract the authentication data from the Load File,

                     9 Check that each extracted authentication data relates to a Security Domain present in the
                          GlobalPlatform Registry,
                     9 Request that Security Domain(s) associated with authentication data present in the Load
                          File verify that the authentication data relates to the Load File Data Block Hash.
     x   On final receipt of the Load File (last LOAD command) the OPEN may verify the Load File Data Block
          Hash received in the load request when no authentication data was present in the Load File and shall:
              Verify the Load File Data Block Hash received in the load request if authentication data was
                present in the Load File,
              Create an Executable Load File using the Load File Data Block,
              Create an entry for the Executable Load File and its associated Security Domain in the
                GlobalPlatform Registry,
              Create an entry for each Executable Module within the Executable Load File in the
                GlobalPlatform Registry. The associated Security Domain for each Executable Module shall be
                the same as the associated Security Domain for the Executable Load File.
If, at any stage, the OPEN determines that card resources are insufficient for the loading process or that any
verification step has failed, the OPEN shall terminate the loading process, shall return the appropriate error and
shall reclaim any memory allocated to the load process.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            65

6.4.1.2    Card Content Installation
An INSTALL [for install] command is then used to request the installation of an application. The Issuer Security
Domain processes the INSTALL command before forwarding the install request to the OPEN for processing.
The installation internal processing is beyond the scope of this Specification. However, it is assumed that the
installation process includes the creation of instances and allocation of Application data memory.
Following the installation, the OPEN shall register additional information in the GlobalPlatform Registry
regarding the Application Life Cycle State, Security Domain association, and Application privileges.

Runtime Behavior (Installation)
The following runtime behavior requirements apply to the OPEN during the content installation process:
    x    On receipt of the install request (data contained within the INSTALL [for install] command), the OPEN
          shall:
              Check that the Executable Module AID is present in the GlobalPlatform Registry,
              Check that the Instance AID (for future selection of the Application) is not already present in the
                GlobalPlatform Registry as an Application or Executable Load File,
              Verify the resource requirements of the Application,
              Create an Application from the Executable Module,
              Ensure that the Application, depending on the underlying runtime environment, has the knowledge
                of its AID, its privileges and its install parameters,
              Create an entry in the GlobalPlatform Registry for the Application and its associated Security
                Domain, Life Cycle State and privileges.
If the OPEN determines that card resources are insufficient for installing the Application or the runtime
environment does not currently allow the installation, the OPEN shall terminate the installation process, return the
appropriate error and reclaim any memory allocated to the install process.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
66                            GlobalPlatform Card Specification 2.1.1                                     03/25/2003



Loading and Installation Flow
Figure 6-3 is an example of the loading and installing of an Application to a GlobalPlatform card. In this example
the Load File is loaded on the card and stored in memory as an Executable Load File. The installation phase
occurs immediately following the loading phase.

                                                         Issuer Security Domain                                 Security
                                         Host                                                     OPEN
                                                                                                              Domain with
                                                                                                             DAP verification
                                   SELECT Issuer Security Domain
      SELECT
                                          SELECT Response

                                        Optional
                                  Authentication Process

                                               INSTALL
      INSTALL
      [for load]                                                                       validate request
                                         INSTALL Response
                                                                                                                verify Load File
                                                LOAD                                                              Data Block
                                                                                                                   Signature
       LOAD                                                                            store Load File
                                           LOAD Response

                                                LOAD                         Verify Load File Data Block Hash
                                                                                      store Load File
       LOAD                                                                   create and register Executable
       (final)                                                                   Load File and Executable
                                                                                         Module(s)
                                           LOAD Response
                                              INSTALL
                                                                                     validate request
      INSTALL                                                                      install and register
     [for install]                                                                     Application
                                         INSTALL Response

                                                                       Unspecified                        Unspecified
                                         APDU Interface                 interface                          interface



                              Figure 6-3: Load and Installation Flow Diagram




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            67

Installation Flow
Figure 6-4 is an example of installing an Application from an Executable Load File already present on the card:

                                          Host                        Issuer Security Domain             OPEN

                                                 SELECT Issuer Security Domain
       SELECT
                                                       SELECT Response

                                                      Optional
                                                Authentication Process

                                                            INSTALL
                                                                                                       validate request
         INSTALL                                                                                     install and Register
        [for install]                                                                                    Application
                                                      INSTALL Response


                                                                                          Unspecified
                                                       APDU Interface                      interface

                                        Figure 6-4: Install Flow Diagram


6.4.2      Content Removal
This section defines the content removal process that enables a flexible management of the Mutable Persistent
Memory space of the cards through the removal of Applications and/or Executable Load Files. Only code and
data not referenced by another entity on the card may be deleted. Code and data that is currently being accessed
by the runtime environment is deemed to be referenced by another entity. If the Application is selected on another
logical channel this Application cannot be deleted.
The DELETE command (see Section 9.2 - DELETE Command) allows for the actual removal of content from
Mutable Persistent Memory and the logical removal of content from Immutable Persistent Memory. The
DELETE command is processed by the Issuer Security Domain before forwarding the removal request to the
OPEN for processing.
Depending on the memory location of the removed Applications and/or Executable Load File, the OPEN shall
perform the different actions detailed in the following sections. When the Application or Executable Load File
has been successfully removed, its contents in the memory shall no longer be accessible.
The Issuer Security Domain has the implied privilege for deleting any Application or Executable Load File from
the card regardless of which Security Domain the Application or Executable Load File is associated with.

6.4.2.1    Application Removal
Application removal may involve the removal of Application instances as well as any Application data associated
with the Application.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
68                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

Runtime Behavior
The following runtime behavior requirements apply to the OPEN during the Application removal process. The
OPEN shall:
     x   Determine that the Application being deleted has an entry within the GlobalPlatform Registry,
     x   Determine that the Application is not currently selected on another logical channel,
     x   Determine that no other Applications present in the card make reference to this Application,
     x   Determine that no other Applications present in the card maintain references to any data within this
          Application,
     x   If a Security Domain is being deleted, determine that none of the Applications present in the card are
          associated with this Security Domain,
     x   Remove the entry for the Application within the GlobalPlatform Registry,
     x   If the Application has the Default Selected privilege, re-assign the Default Selected privilege to the
          Issuer Security Domain,
     x   Release and mark as available any Mutable Persistent Memory.
If the OPEN determines that any of the above verification steps have failed, the OPEN shall not initiate the delete
process and shall inform the Issuer Security Domain to return the appropriate response. Once this, or any related,
delete process(es) begin they shall all complete in the current Card Session or, in the event of an interruption, at
least the updates to the GlobalPlatform Registry shall complete in a subsequent Card Session.

6.4.2.2    Executable Load File Removal
An Executable Load File contains Executable Modules. The removal applies to the entire Executable Load File.
Physical removal may occur in Mutable Persistent Memory while only logical removal is possible in Immutable
Persistent Memory.
This version of the Specification does not cover the removal of a specific Executable Module within an
Executable Load File.

Runtime Behavior
The following runtime behavior requirements apply to the OPEN during the Executable Load File removal
process.
The OPEN shall:
     x   Determine that the Executable Load File being deleted has an entry within the GlobalPlatform Registry,
     x   Determine that no other Applications and no other Executable Load Files present in the card maintain
          references to this Executable Load File,
     x   Remove the entry for the Executable Load File and the entries for any Executable Modules present in the
          Executable Load File from within the GlobalPlatform Registry,
     x   Release and mark as available any Mutable Persistent Memory.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            69

If the OPEN determines that any of the above verification steps have failed, the OPEN shall not initiate the delete
process and shall inform the Issuer Security Domain to return the appropriate response. Once this delete process
begins it shall all complete in the current Card Session or, in the event of an interruption, at least the updates to
the GlobalPlatform Registry shall complete in a subsequent Card Session.
Only Mutable Persistent Memory is released and marked as available. Executable Load Files contained in
Immutable Persistent Memory cannot be deleted but the entry for the Executable Load File and the entries for the
Executable Modules present in the Executable Load File shall be deleted from the GlobalPlatform Registry.
Deletion Flow
Figure 6-5 is an example of deleting an Executable Load File:



                                        Host                       Issuer Security Domain                   OPEN

                                               SELECT Issuer Security Domain
         SELECT
                                                     SELECT Response


                                               Optional Authentication
                                                      Process

                                                          DELETE
                                                                                                       validate request
         DELETE                                                                                    delete Executable Load
                                                                                                             File
                                                     DELETE Response

                                                                                        Unspecified
                                                     APDU Interface                      interface

                               Figure 6-5: Executable Load File Deletion Flow

6.4.2.3    Executable Load File and related Application Removal
An Executable Load File contains Executable Modules from which Applications have been installed. This
optional feature removes the Executable Load File as well as all these related Applications. Physical removal may
occur in Mutable Persistent Memory while only logical removal is possible in Immutable Persistent Memory.

Runtime Behavior
When supported by the card, the following runtime behavior requirements apply to the OPEN during the
Executable Load File and related Application removal process.
The OPEN shall:
    x    Determine that the Executable Load File being deleted has an entry within the GlobalPlatform Registry,
    x    Locate each Application installed from an Executable Module within this Executable Load File and for
          each Application,
              Determine that the Application is not currently selected on another logical channel,




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
70                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

              Determine that no other non-related Applications present in the card make reference to this
                Application,
              Determine that no other non-related Applications present in the card maintain references to any
                data within this Application,
              If a Security Domain is being deleted, determine that none of the non-related Applications present
                in the card are associated with this Security Domain,
     x   Determine that no other Applications and no other Executable Load Files present in the card maintain
          references to this Executable Load File,
     x   Remove the entry for the Executable Load File and the entries for any Executable Modules present in the
          Executable Load File from within the GlobalPlatform Registry,
     x   Remove the entry for each related Application within the GlobalPlatform Registry,
     x   If the related Application has the Default Selected privilege, re-assign the Default Selected privilege to
          the Issuer Security Domain,
     x   Release and mark as available any Mutable Persistent Memory.
If the OPEN determines that any of the above verification steps have failed, the OPEN shall not initiate the delete
process and shall inform the Issuer Security Domain to return the appropriate response. Once the delete processes
begin they shall all complete in the current Card Session or, in the event of an interruption, at least the updates to
the GlobalPlatform Registry shall complete in a subsequent Card Session.
Only Mutable Persistent Memory is released and marked as available. Executable Load Files contained in
Immutable Persistent Memory cannot be deleted but the entry for the Executable Load File and the entries for the
Executable Modules present in the Executable Load File shall be deleted from the GlobalPlatform Registry.


6.4.3      Content Extradition
The GlobalPlatform Card Content extradition process is designed to allow the association, to a different Security
Domain, of a previously installed Application. The Issuer Security Domain shall verify the extradition request
before the OPEN will allow the extradition.

Runtime Behavior
The following runtime behavior requirements apply to the OPEN during the Card Content extradition process.
The OPEN shall:
     x   Determine if the Application being extradited exists within the GlobalPlatform Registry,
     x   Check that the Security Domain requesting the extradition is the Security Domain associated with the
          Application being extradited,
     x   Check that the Security Domain AID, to which the Application is being extradited, exists within the
          GlobalPlatform Registry,
     x   Check that this Security Domain has the Security Domain privilege,
     x   Check that this Security Domain is in a valid Life Cycle State (i.e. PERSONALIZED),
     x   Request this Security Domain to indicate whether it accepts Card Content extraditions.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            71

Extradition Flow
Figure 6-5 is an example of extraditing an Application:


                                                        Issuer Security          OPEN                      Security
                                        Host
                                                            Domain                                         Domain
                                SELECT Issuer Security Domain
         SELECT
                                      SELECT Response

                                Optional Authentication
                                       Process
                                            INSTALL                          validate request
                                                                                                      accept extradition
                                                                                                          request
    EXTRADITE
                                                                          extradite Application
                                      INSTALL Response
                                                                   Unspecified                  Unspecified
                                      APDU Interface                interface                    interface

                                    Figure 6-6: Application Extradition Flow


6.5      Delegated Management
GlobalPlatform is designed for providing maximum flexibility to the Card Issuer and its business partners
regarding Card Content management while ensuring that the Card Issuer keeps control over the Card Content
present on the card. Delegated Management provides this capability so that a Card Issuer can provide an
Application Provider the capability to perform specific Card Content management.
Delegated Management is not a mandated feature of a GlobalPlatform card and is only necessary for Card Issuers
that choose to offer this flexibility and in order to achieve this, close co-operation between the OPEN and the
Issuer Security Domain is required. Cryptographic security is required for Delegated Management and the Issuer
Security Domain requires the knowledge of keys and algorithms used for Tokens and optionally for Receipts.
If the Card Issuer's Security policy requires Receipt generation, the Issuer Security Domain shall also keep track
of a Confirmation Counter that is incremented when generating each Receipt. When reaching its maximum value,
the Confirmation Counter shall not be reset to zero. Cards are not required to support counter values beyond
32,767.
Delegated Management is a privilege that a Security Domain shall be granted during installation. Delegated
Management requires an Application Provider's Security Domain with this privilege to perform:
    x    Delegated loading,
    x    Delegated installation,
    x    Delegated extradition,
    x    Delegated deletion.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
72                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The Application Provider, instead of the Card Issuer, manages each of the above processes. However, it is
important to note that the OPEN performs the physical loading and installation (See Section 7.6 - Delegated
Management).


6.6       GlobalPlatform Registry
The OPEN owns and manages information deemed necessary to perform the functionality defined by
GlobalPlatform. Exactly how this information is managed is beyond the scope of this Specification. For the
purpose of this Specification it is assumed to be in the GlobalPlatform Registry.
The GlobalPlatform Registry is used to:
     x   Store card management information,
     x   Store relevant application management information (e.g., AID, associated Security Domain and
          privileges),
     x   Support card resource management (e.g., non-volatile memory allocation),
     x   Store Application Life Cycle information,
     x   Store card Life Cycle information,
     x   Track any counters associated with logs.
The contents of the GlobalPlatform Registry may be updated in response to:
     x   A Card Issuer invoked action,
     x   An internal OPEN invoked action,
     x   An authorized Application invoked action.
The GlobalPlatform Registry contains data elements for all Applications, including Security Domains and the
Issuer Security Domain.
There is no mandatory format for the storage of these data elements. However, format requirements do exist for
the handling of the data elements via APDU commands and GlobalPlatform services available to Applications.


6.6.1      Issuer Security Domain Data Elements Description
The Issuer Security Domain AID and card Life Cycle State are stored in the GlobalPlatform Registry similarly to
Application information.
The card Life Cycle State may be retrieved by an Application through the OPEN services or by an off-card entity
through the Issuer Security Domain (See Section 9.4 - GET STATUS Command).
The following sections describe the possible GlobalPlatform Registry data elements for the OPEN.

6.6.1.1    Issuer Security Domain AID
The Issuer Security Domain AID data element uniquely identifies the Issuer Security Domain.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            73

One option of making the Issuer Security Domain the selected Application, is to specify this AID in a SELECT
command with the [first or only occurrence] option set. As another option for making the Issuer Security Domain
the selected Application, the SELECT command could contain no data in which case the AID of the Issuer
Security Domain would be discovered by the off-card entity in the response to the SELECT command.
The Card Issuer is responsible for setting the value for the Issuer Security Domain AID.

6.6.1.2    Card Life Cycle State
The Issuer Security Domain inherits the Life Cycle State of the card.


6.6.2      Application/Executable Load File/Executable Module Data Elements
The following data elements are defined:
    x    Application/Executable Load File/Executable Module AID data element
    x    Application Life Cycle State data element
    x    Resource allocation data element
    x    Application Privileges data element
    x    Associated Security Domain AID data element

6.6.2.1    Application/Executable Load File/Executable Module AID
Each Executable Load File or Executable Module is associated with an AID that shall be unique on the card.
An Application AID may be the same as that of an Executable Module but may not be the same as that of an
Executable Load File or the same as another Application already present in the GlobalPlatform Registry.
This AID may be specified in a SELECT command to select the Application. It is not possible to select
Executable Load Files or Executable Modules.

6.6.2.2    Application/Executable Load File/Executable Module Life Cycle
The Application Life Cycle State data element contains the current Life Cycle of the Application, Executable
Load File or Executable Module.

6.6.2.3    Resource Allocation
The resource allocation data element contains information about the resources that are available to an
Application. It is a system-specific value and is used as a control mechanism by the OPEN to limit the amount of
resources that an Application may claim during runtime.
When additional resources are requested by an Application, the OPEN shall validate the request against the value
of this data element in the GlobalPlatform Registry.

Runtime Behavior
The OPEN shall terminate processing of the Application and shall return an appropriate response code if the
additional resource requested by an Application exceeds its allocation limit.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
74                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The OPEN may choose to lock an Application that makes repeated attempts to allocate additional resources
beyond its allocation limit.

6.6.2.4    Application Privileges
The Application Privileges data element indicates the privileges for each Application.
The following Application privileges are defined:
     x   Application is a Security Domain,
     x   Application is a Security Domain with DAP Verification privileges,
     x   Application is a Security Domain with Delegated Management privileges,
     x   Application is a Security Domain that mandates the presence of a DAP Block in all Load Files,
     x   Application has the privilege to lock the card,
     x   Application has the privilege to terminate the card,
     x   Application is the Default Selected Application,
     x   Application has the privilege to manage the card CVM.
The following rules apply to the assignment of Application privileges:
     x   Only one Application or Security Domain in the card may be set with the Default Selected Application
          privilege at a time (e.g. the Issuer Security Domain, a current legacy Application or an Application that
          requires specific behavior with regards to logical channels),
     x   Once the Default Selected privilege has been assigned to an Application, the privilege can only be
          reassigned to a new Application by deleting the Application which has the privilege,
     x   The Default Selected Application privilege may be assigned only if the Issuer Security Domain has the
          Default Selected Application privilege.
The following recommendation applies to the assignment of Application privileges:
     x   An Application that has the Default Selected privilege and is intended for a card that supports
          Supplementary Logical Channels should not have multi-selection restrictions.
Otherwise, the Application privileges are not mutually exclusive; therefore, one or more privileges may be
marked as set for an Application.
The Issuer Security Domain, as the on-card representative of the Card Issuer, is the most privileged entity of the
card as it is the only entity that performs Card Content management without having been explicitly delegated
previously.
The Issuer Security Domain shall have the following set of privileges clearly identifying its functionality (i.e. a
Security Domain with card lock, card terminate and CVM management privileges and possibly the Default
Selected privilege) in addition to its implied unrestricted Card Content management privilege.

Runtime Behavior
The OPEN shall identify the Issuer Security Domain and use the Application Privileges data element for
controlling the following runtime behavioral requirements:




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            75

    x    Identifying the Default Selected Application during the ATR sequence,
    x    Requesting Token verification and Receipt generation,
    x    Checking that a DAP Block is mandated in Load Files,
    x    Determining if an Application is a Security Domain,
    x    Determining if a Security Domain has DAP Verification privileges,
    x    Determining if a Security Domain has the Delegated Management privilege,
    x    Checking for the validity of a request to lock the card,
    x    Checking for the validity of a request to terminate the card,
    x    Identifying the Default Selected Application when opening a Supplementary Logical Channel from the
          Basic Logical Channel,
    x    Ensuring that only one Application or Security Domain (including the Issuer Security Domain) is
          marked as the Default Selected Application. This privilege can be assigned to an Application only if the
          Issuer Security Domain currently has this privilege,
    x    Ensuring that only the Default Selected Application can successfully request that the Answer-to-Reset
          historical characters be modified. This feature should only be used on cards that support the Basic
          Logical Channel only.
    x    Checking for the validity of requests to change the CVM value and the CVM management parameters
          (e.g. CVM Retry Limit).

6.6.2.5    Associated Security Domain AID
The associated Security Domain AID data element contains the AID of an Executable Load File's or Application's
associated Security Domain. The INSTALL [for load] command may specify the associated Security Domain that
shall be linked to the Executable Load File and as such to each Executable Module within the Executable Load
File. If no Security Domain is specified in the INSTALL [for load] command, the Security Domain performing
the load is assumed to be the associated Security Domain.
An Application is installed through the Issuer Security Domain or through the Security Domain associated to the
Executable Module. In both cases the Security Domain associated with the Executable Module is also associated
to the Application.
Applications may use certain services of their associated Security Domains
Runtime Behavior
When the OPEN receives an Application request to use a service of the associated Security Domain the OPEN
shall:
    x    Locate the Application's entry in the GlobalPlatform Registry,
    x    Retrieve the associated Security Domain.
If an associated Security Domain is present, the entry for the associated Security Domain shall be located and the
Application's request for service forwarded to this Security Domain.
The associated Security Domain shall be in the PERSONALIZED Life Cycle State in order for its services to be
usable.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
76                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

6.7       Security Management
As described in Section 6.1 - Card Manager Overview, the OPEN is at the center of the security scheme and is
responsible for controlling access to and executing all of the most trusted services on the card. In its role as
administrator of the complete card, the OPEN shall also implement security monitoring and control functions in
order to ensure card security and integrity during runtime execution. These functions are active at all times in the
card regardless of which Application is currently selected. These functions shall include the following:
     x   Application locking,
     x   Card locking,
     x   Card termination
The OPEN may also provide the following function:
     x   Optional tracing and event logging.
The OPEN is responsible for the security and the controls regarding the loading, the installation, the extradition,
and the deletion of Card Content.
The OPEN shall:
     x   Verify the Load File Data Block Hash,
     x   Request the verification of the Delegated Management Token,
     x   Request the generation of the Delegated Management Receipt,
     x   Request the verification of the Load File Data Block Signature.


6.7.1      Application Locking
The Card Issuer has a mechanism to disable the continued execution status of an on-card Application. This
mechanism may be invoked from within the OPEN based on exceptions handled by the OPEN or from the use of
externally invoked commands. The Card Issuer is the only entity that may initiate the locking of an Application.

Runtime Behavior
On receipt of a request to lock an Application (using a SET STATUS command received by the Issuer Security
Domain), the OPEN shall:
     x   Check that an entry for the Application being locked is present in the GlobalPlatform Registry,
     x   Set the Application Life Cycle State to LOCKED,
     x   Keep a record of the previous Application Life Cycle State to ensure that the Card Issuer can only
          transition the Application back to this previous state.
An Application being locked that is currently selected on a logical channel shall remain the currently selected
Application on that logical channel until the end of the Application Session though its Application Life Cycle
State is set to LOCKED.
Once the Application Life Cycle State is set to LOCKED, the Application shall not be selectable implicitly or
explicitly on any logical channel.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            77

If the locked Application has the Default Selected privilege, the Issuer Security Domain shall act as the Default
Selected Application until the Application is unlocked.
If at a later stage the Application is unlocked, its Default Selected privilege shall get reinstated.
Application Locking Flow
Figure 6-7 is an example of locking an Application:

                                             Host                     Issuer Security Domain                 OPEN

                                                 SELECT Issuer Security Domain
           SELECT
                                                        SELECT Response


                                                Optional Authentication
                                                       Process

                                                          SET STATUS                                  set Application Life
                                                                                                        Cycle State to
      SET STATUS                                                                                           LOCKED
                                                     SET STATUS Response


                                                                                          Unspecified
                                                       APDU Interface                      interface

                                     Figure 6-7: Application Locking Flow


6.7.2      Card Locking
Once the card Life Cycle State is CARD_LOCKED, all Applications except the Issuer Security Domain shall be
disabled. Due to the severity of this action, the card locking shall only be allowed under the most stringent
conditions and shall only be performed with the proper security mechanisms and authorizations.
Card locking requests may originate from two sources:
Internal source— either the OPEN, the Issuer Security Domain, or a privileged Application may initiate card
locking requests from within the card. Internal requests are likely to occur in response to certain card runtime
situations. For example, the OPEN or an Application with the necessary privilege may initiate the card locking
process as a response to a perceived security threat based on data collected from velocity checking data.
Off-card source— explicit card locking requests may be initiated by APDU commands sent by the Card Issuer to
the Issuer Security Domain or by an authorized representative to an Application with the card lock privilege.

Runtime Behavior
On receipt of an instruction from the Issuer Security Domain or a privileged Application instructing the OPEN to
lock the card, the OPEN shall:
    x   Check within the GlobalPlatform Registry that the Application requesting the locking of the card has the
         required card locking privilege,
    x   Check that the current card Life Cycle State is SECURED,




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
78                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

     x   Set the card Life Cycle State to CARD_LOCKED.
Applications that are currently selected on any logical channel shall remain the currently selected Applications on
their respective logical channels until the end of their respective Application Sessions. As soon as the current
Application Session on a Supplementary Logical Channel ends, the logical channel on which the Application was
selected is closed. Once all the Supplementary Logical Channels are closed the Basic Logical Channel becomes
the only available interface. As soon as the current Application Session on the Basic Logical Channel ends, the
Issuer Security Domain is the only selectable Application.
Attempts to modify Card Content are denied from the instant the card transitions to the CARD_LOCKED Life
Cycle State.

Card Locking Flow
Figure 6-8 is an example of locking the card:

                                          Host                       Issuer Security Domain                  OPEN

                                                 SELECT Issuer Security Domain
          SELECT
                                                      SELECT Response

                                                     Optional
                                               Authentication Process

                                                         SET STATUS                                       set card Life
                                                                                                         Cycle State to
     SET STATUS                                                                                         CARD_LOCKED
                                                    SET STATUS Response


                                                                                            Unspecified
                                                      APDU Interface                         interface

                                         Figure 6-8: Card Locking Flow


6.7.3      Card Termination
In the card Life Cycle State TERMINATED, all communication to the card besides the GET DATA command
processed by the Issuer Security Domain shall be disabled. Due to the severity of this action, the card termination
shall only be allowed under the most stringent conditions and shall only be performed with the proper security
mechanisms and authorizations.
The decision to terminate a card may either be triggered by an internal card event that violates a policy of the
Card Issuer or may be invoked externally by the Card Issuer:
Internal source— either the OPEN, the Issuer Security Domain, or a privileged Application may initiate a card
termination request from within the card. An internal card termination request is likely to occur in response to
certain card runtime situations.
Off-card source— explicit card termination requests can be initiated by APDU commands sent by the Card
Issuer to the Issuer Security Domain or by an authorized representative to an Application with the card
termination privilege.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            79

Runtime Behavior
On receipt of a SET STATUS command or an instruction from a privileged Application instructing the OPEN to
terminate the card, the OPEN shall:
    x   Check within the GlobalPlatform Registry that the Application requesting the termination of the card has
         the required card termination privilege,
    x   Set the card Life Cycle State to TERMINATED from its current state.
Applications that are currently selected on any logical channel shall remain the currently selected Applications on
their respective logical channels until the end of their respective Application Sessions. As soon as the current
Application Session on a Supplementary Logical Channel ends, the logical channel on which the Application was
selected is closed. Once all the Supplementary Logical Channels are closed the Basic Logical Channel becomes
the only available interface. As soon as the current Application Session on the Basic Logical Channel ends, no
Applications are selectable, the Issuer Security Domain is always implicitly selected on the Basic Logical
Channel and only the GET DATA command is processed on this channel.
As the transition to the TERMINATED Life Cycle State can be due to the detection of a severe security threat,
the security policy of the Issuer may require additional behavior such as closing the current Card Session by
performing an internal card reset.
Card Content management requests are denied from the instant the card transitions to the TERMINATED Life
Cycle State.
Terminate Card Flow
Figure 6-9 is an example of terminating the card:

                                          Host                       Issuer Security Domain               OPEN

                                                 SELECT Issuer Security Domain
         SELECT
                                                       SELECT Response

                                                       Optional
                                                 Authentication Process

                                                          SET STATUS                                    set card Life
                                                                                                       Cycle State to
     SET STATUS                                                                                        TERMINATED

                                                    SET STATUS Response


                                                                                        Unspecified
                                                       APDU Interface                    interface

                                        Figure 6-9: Terminate Card Flow


6.7.4      Operational Velocity Checking
The OPEN shall be implemented with a velocity checking security mechanism. For the purpose of this document,
“velocity checking” is defined as the active monitoring, handling and management of security sensitive activities
on the card.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
80                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

These activities may include, but are not limited to the following:
     x   Content installation,
     x   Card exceptions,
     x   Application exceptions.
Typically, velocity checking is used to counter security attacks that use repeated attempts in their schemes. These
attempts can be from internal (on-card) or external (off-card) entities. Velocity checking is implemented to track
the number of consecutive failures in each of the related management and security events.

6.7.4.1    Content Loading and Installation
The OPEN may keep track of the number of unsuccessful consecutive attempts of the Card Content load and
installation process by a particular Application and the total number of such attempts by all Applications. Actions
may include such defensive measures as the locking or termination of the card.

6.7.4.2    Exceptions
Velocity checking may be implemented in cases in which the OPEN generates exceptions. However, it does not
have to be implemented such that each individual exception is handled separately. A trace buffer and event log
may be used to complement velocity checking.
For example, an implementation of the Issuer Security Domain may enable velocity checking to enforce strict
APDU command sequencing for card and application management operations (e.g., Card Content loading and
installation). The OPEN may also enable velocity checking against repeated failed attempts by an Application to
allocate additional memory beyond its allowed limit that is stored in the GlobalPlatform Registry. The OPEN
may choose to lock an Application that is exhibiting such behavior.


6.7.5      Tracing and Event Logging
Tracing and event logging functions may be enabled. These functions shall be implemented according to a Card
Issuer's policy requirements, and are therefore considered extensions to the Issuer Security Domain.


6.7.6      Securing Content Loading and Installation
The following section details the security features that shall be available during Card Content loading and
installation. The responsibility of ensuring that these controls are present and correct rests with the OPEN.

6.7.6.1    Load File Data Block Hash
The Load File Data Block Hash is a redundancy check across the whole Load File Data Block to be transferred to
the card and is present as a field in the INSTALL [for load] command. Typically it should be a hash of the
complete Load File Data Block. Mandating of the Load File Data Block Hash is only required when Delegated
Management loading occurs or when a DAP Block is present in a Load File. The Load File Data Block Hash may
be present but is not required when the loading occurs through the Issuer Security Domain and no DAP Blocks
are required to be present in the Load File.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            81

The OPEN, when receiving the complete Load File Data Block, should perform the same function as the off-card
entity and compare its own result with the Load File Data Block Hash previously received during the processing
of the INSTALL [for load] command.
See Appendix B.2.1 - Secure Hash Algorithm (SHA-1) for more details.
If the Load File Data Block Hash received by the card does not match the Load File Data Block Hash generated
on card, any reference to the Executable Load File shall be discarded.

6.7.6.2    Tokens
Tokens relate specifically to Delegated Management and more detail is provided in Section 7.6 - Delegated
Management. The Card Issuer provides a Token to the Application Provider performing a Delegated Management
function.
During Delegated Management, Card Content management requests are transferred to the OPEN from a Security
Domain that has the Delegated Management privilege.
The OPEN, on receiving a request from a Security Domain with Delegated Management privileges, shall request
the Issuer Security Domain to verify the validity of the Token and shall act appropriately if the Issuer Security
Domain cannot verify the Token.

6.7.6.3    Load File Data Block Signature
A Load File may contain one or more DAP (Data Authentication Pattern) Blocks that allow an entity other than
the loading entity to verify the authenticity and the integrity of the Load File Data Block. A DAP Block is
required when a Security Domain with the mandated DAP Verification privilege is present on the card. A DAP
Block is also required when the on-card associated Security Domain has the DAP Verification privilege. Other
DAP Blocks may be present in the Load File and shall be verified by the identified Security Domain(s). The
signature within a DAP Block allows the Application Provider or Controlling Authority to ensure that only
verified content is being loaded to a GlobalPlatform card.
The Security Domain linked to each Load File Data Block Signature shall perform the verification. It is the
responsibility of the OPEN to request that the Security Domain, linked to the Load File Data Block Signature,
verify the signature and to act appropriately if the verification fails.
The verification of each Load File Data Block Signature is required in order to commit an Executable Load File
to memory.


6.8       Issuer Security Domain
The Issuer Security Domain is regarded as the on-card representative of the Card Issuer. As such, the Issuer
Security Domain contains the keys that the Card Issuer will use in support of cryptographic operations for card
management functions, Card Issuer Applications management functions, and the Application Provider
Applications if desired. As an example, these keys could be used for authentication and for cryptographic
operations during the Card Content loading, installation and removal processes, as well as personalization.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
82                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The interface and distinction between the Issuer Security Domain and the OPEN is also not defined by the
GlobalPlatform Specifications (specifically relating to Card Content management, Token verification, and
Receipt generation). It is assumed that the Issuer Security Domain cannot be developed in the same manner as a
typical Security Domain or normal Application. GlobalPlatform, therefore, does not mandate that the Issuer
Security Domain be loaded in the same manner as Applications. The Issuer Security Domain, while viewed by
the GlobalPlatform Registry as an Application, has implementation specific behavior relating to how it becomes
an active entity on the card.
The Issuer Security Domain shall be able to store the following data:
     x   Issuer Identification Number (IIN),
     x   Card Image Number (CIN),
     x   Card Recognition Data,
     x   Issuer Security Domain key information,
     x   Other Card Issuer's proprietary data.
These data shall be available from the card using the GET DATA command.


6.8.1      Issuer Identification Number
The Issuer Identification Number (IIN) may be used by an off-card entity to associate the card to a specific Card
Management System. The IIN typically contains the ISO 7812 defined identification of the Issuer and is carried
by the ISO/IEC 7816-6 tag '42'. The IIN data element is of variable length.


6.8.2      Card Image Number
The Card Image Number (CIN) may be used by a Card Management System to uniquely identify a card within its
card base. It is a unique value, carried by the ISO/IEC 7816 defined tag '45' (Card Issuer's Data), which is
assigned by the Card Issuer (identified itself by the IIN). The CIN data element is of variable length.


6.8.3      Card Recognition Data
Card Management Systems need information about a card before they can start to interact with it. This includes
the kind of card it is, what kinds of command it accepts, and what secure protocol it supports.
Card Recognition Data is the mechanism for providing information about a card, and thus avoiding the vagaries
of trial-and-error.
Card Recognition Data shall be present and contained in a data template (tag '73'). This template shall in turn be
contained in the “Card Data” data object (tag '66'), as defined in ISO/IEC 7816-6. Card Data can be retrieved
using the GET DATA command. (Card Data may also be accessed through the ATR, if a suitable “command to
perform” is included in the ATR historical characters.)
Note that the information provided in Card Recognition Data should be enough to enable initial communication
with the card without resorting to trial and error. Information not essential for this purpose should be supplied
during subsequent interaction with the card.
There is no specific requirement for Card Recognition Data to be updated dynamically by the card, but additional
dynamic data objects are not precluded.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            83

6.8.4      On-Card Key Information
Keys are stored in Mutable Persistent Memory and have the following attributes:
    x   A Key Identifier, which identifies each key within an on-card entity. A key may consist of one or more
         key components, e.g. a symmetric key has only one key component while an asymmetric key has several
         components. All key components share the same Key Identifier. Different Key Identifiers within one on-
         card entity shall be used to differentiate keys, their usage, and their functionality. There is no restriction
         and no pre-defined order in assigning Key Identifiers to keys, including non-sequential Key Identifiers
         within the same entity.
    x   An associated Key Version Number: different key versions within an on-card entity may be used to
         differentiate several instances or versions of the same key. There is no restriction and no pre-defined
         order in assigning Key Version Numbers to keys.
    x   An associated cryptographic algorithm: a specific key is associated with one and only one cryptographic
         algorithm.
    x   A length, for cryptographic algorithms supporting several key (or key component) lengths.
These key attributes together indicate unambiguously to the on-card entity:
    x   The identity,
    x   The intended usage, and
    x   The functionality of cryptographic keys.
The combination of a Key Identifier and a Key Version Number identifies unambiguously a key within an on-
card entity. The key type identifies the cryptographic algorithm and key component. Identifying unambiguously a
key and an algorithm within an entity prevent the misuse of cryptographic functionality.
The Issuer Security Domain manages keys as follows:
    x   A Key Identifier and Key Version Number uniquely reference each key within the on-card entity. In
         other words, each combination Key Identifier / Key Version Number identifies a unique key slot within
         that entity.
    x   Adding a key equates to allocating a new key slot with a new key value, a new Key Identifier, and a new
         Key Version Number.
    x   Replacing a key involves erasing the key slot of the key being replaced, updating the key slot with a new
         key value, and updating the associated Key Version Number. The Key Identifier remains the same.
The off-card key management system shall be aware of the scheme used to identify keys held by the on-card
entity. Key Identifiers and Key Version Numbers may have arbitrary values for the card (e.g. not being
sequential, not starting with '01') and these values may vary from one key management scheme to the next. Off-
card key management schemes are outside the scope of this specification.
Any velocity checking related to a particular keys usage e.g. key try counters and limits are dependent on the
Card Issuer's security policy.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
84                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

6.9       CVM Management
The Card Manager may provide a mechanism for a Cardholder Verification Method (CVM) that may be used by
all Applications on the card. This Specification provides a way for the implementation of a card global Personal
Identification Number (global PIN) service to support Cardholder verification requirements. CVM management
services shall only be accessible to privileged Applications. The CVM verification services may be accessed by
any Application.
If the CVM service is supported, the CVM handler shall:
     x   Reserve memory space for the CVM management,
     x   Provide the CVM services to Applications,
     x   Change the CVM state,
     x   Change the Retry Limit and Retry Counter.


6.9.1      CVM States
The CVM state may be used by an Application to assist in managing PIN related functions. The non-atomic states
of the CVM may be seen within a Card Session. The CVM state, the Retry Limit, and the Retry Counter are
closely related. All CVM state transitions are immediately visible to the Application that caused the transition as
well as to any Applications that may be selected on other logical channels.
The CVM states are:
     x   ACTIVE
     x   INVALID_SUBMISSION
     x   VALIDATED
     x   BLOCKED

6.9.1.1    CVM State ACTIVE
The CVM state shall first become ACTIVE when a privileged Application initializes the CVM value and sets the
Retry Limit. The CVM state may also transition back to ACTIVE from any other CVM state if a privileged
Application unblocks the CVM or changes the CVM value. Changing the CVM value shall also reset the Retry
Counter. At the end of a Card Session the CVM state shall transition back to ACTIVE, except if the CVM state
transitioned to the CVM state BLOCKED during the Card Session. The end of the Card Session shall not affect
the Retry Counter.

6.9.1.2    CVM State INVALID_SUBMISSION
During the CVM verification, the CVM state shall transition to INVALID_SUBMISSION if the CVM
verification fails. The Retry Counter shall be updated.
The CVM state shall remain INVALID_SUBMISSION until:
     x   The Card Session ends,
     x   A valid CVM verification is performed,
     x   An Application resets the CVM state,




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            85

    x    A privileged Application either blocks the CVM or changes the CVM value or CVM Retry Limit,
    x    Subsequent CVM verification(s) fail causing the CVM state to transition to BLOCKED.

6.9.1.3      CVM State VALIDATED
During CVM verification, the CVM state shall transition to VALIDATED and the Retry Counter shall be reset if
the CVM verification is successful.
The CVM state shall remain VALIDATED until:
    x    The Card Session ends,
    x    An invalid CVM verification is performed,
    x    An Application resets the CVM state,
    x    A privileged Application either blocks the CVM, or changes the CVM value or CVM Retry Limit.

6.9.1.4      CVM State BLOCKED
During CVM verification, if the CVM verification fails and the Retry Limit has been reached, the CVM state
shall transition to BLOCKED. The CVM state may also transition to BLOCKED if a privileged Application
initiates this transition. The BLOCKED state shall not transition when the Card Session ends. The CVM state
may only transition from the BLOCKED state back to the ACTIVE state on instruction from a privileged
Application, which either resets (unblocks) the CVM state or changes the CVM value or CVM Retry Limit. The
CVM verification shall always fail in the BLOCKED state.


6.9.2      CVM Format
The 3 following formats are defined for the CVM value:
    x    Format BCD includes only numerical digits, coded on a nibble (4 bits), left justified, and eventually
          padded on the right with an 'F' nibble if necessary (i.e. the number of digits is odd).
    x    Format ASCII includes all displayable characters (alphabetic, numerical, and special), coded on one byte
          and left justified.
    x    Format HEX is equivalent to a transparent mode (“as is”) and includes all binary values coded on one
          byte.
The following rules apply for the CVM format conversion:
    x    No conversion from and to HEX format is valid.
    x    Conversion from BCD format to ASCII format is valid: the numeric nibbles are expanded to the
          corresponding characters coded on one byte and the padding nibble 'F' is deleted (if present).
    x    Conversion from ASCII format to BCD format is valid for numeric characters only: the numeric
          characters coded on one byte are converted to numeric nibbles, padded together in bytes, and a padding
          nibble 'F' is added on the right if necessary.
The internal format for storing the CVM value by the CVM handler is implementation dependent and shall be
transparent to Applications. It shall not preclude any format used by Applications requesting CVM services.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
86                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003


7. Security Domains

7.1       Overview
The Issuer Security Domain contains keys that the Card Issuer uses in support of cryptographic operations for the
Card Issuer's Applications. It is possible to associate Applications owned by an Application Provider to the Issuer
Security Domain. However it is not recommended.
An Application Provider Security Domain (Security Domain) is a special type of Application that is responsible
for managing and providing cryptographic services for keys that are completely separate from, and not under the
control of, the Card Issuer.
These Security Domains are privileged Applications established on a GlobalPlatform card to represent
Application Providers who require a level of key separation from the Card Issuer.
These Security Domains shall contain keys capable of providing support to Applications during personalization.
Security Domain keys may also be used in support of runtime cryptography for Applications.
In addition to the Application privileges, a Security Domain may support three additional privileges that are
referred to as the DAP Verification privilege, the mandated DAP Verification privilege and the Delegated
Management privilege. (These privileges are not available to the Issuer Security Domain.) A Security Domain
may support one or more of these additional privileges.
Mandated DAP Verification allows a Controlling Authority to own a Security Domain that always requires to
authorize a load process. This ensures that only Load File Data Blocks authorized by the Controlling Authority
may be loaded on cards that contain this Security Domain.
DAP Verification allows an Application Provider to own a Security Domain that requires authorizing a load
process. This ensures that when associating a Load File to this Security Domain, the Application Provider must
have authorized the Load File Data Block. This authorization may also serve as a means for a Security Domain to
control the access to some of its services.
Delegated Management allows Application Providers to perform Card Content changes (load, install and
extradite) with pre-authorization from the Card Issuer. Applications Providers can also delete Executable Load
Files and Applications associated to their on-card Security Domains without pre-authorization from the Card
Issuer.
The keys and associated cryptography for all Security Domains including the Issuer Security Domain may be
used for:
     x   Personalization Support: Secure communication support during personalization of an Application
          Provider's Applications,
     x   Runtime Messaging Support: secure communication support during runtime for an Application that does
          not contain its own secure messaging keys.
Security Domains with the DAP Verification privilege are used for:
     x   Verifying a Load File Data Block signature: a specific key within the Security Domain shall be
          identified as a DAP Verification key;




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            87

Security Domains with the Delegated Management privilege can be used for:
    x   Delegated loading,
    x   Delegated installation,
    x   Delegated extradition,
    x   Delegated deletion.
Security Domains are responsible for their own key management. This ensures that Applications and data from
different Application Providers may coexist on the same card without violating the privacy and integrity of each
Application Provider. Security Domains should apply to their own keys the key management principles described
for the Issuer Security Domain (see Section 6.8.4 - On-Card Key Information).
An Issuer Security Domain shall be present on all GlobalPlatform cards to manage the Card Issuer keys and to
optionally provide personalization and cryptographic services to Applications.
A Security Domain is required if Application Provider's Applications are to be personalized using the Application
Provider keys.
A Security Domain may either accept or reject any Card Content extradition request from the OPEN.
During Application installation, indication that the Application has the privileges of a Security Domain is
included in the INSTALL command. (See Section 9.5 - INSTALL Command for a description of the data
elements.)
As GlobalPlatform does not define the interface between a Security Domain and the OPEN (specifically relating
to Delegated Management and DAP Verification), the assumption is made that a Security Domain cannot be
developed in the same manner as a normal Application. GlobalPlatform therefore does not mandate that Security
Domains be loaded in the same manner as Applications. It is assumed however that installation of a Security
Domain is similar to Application installation with the additional setting of the relevant Security Domain
privileges.


7.2      Security Domain Services
Appendix A.2 - GlobalPlatform on a Java Card provides the Java Card™ implementation of the following
interfaces.
Appendix A.3 - Application API Interface on Windows Powered Smart Card provides the Windows Powered
Smart Card implementation of the following interfaces.
Appendix D - Secure Channel Protocol '01' and Appendix E - Secure Channel Protocol '02' provide more details
on Secure Channel Protocols implementing the following interfaces.


7.2.1      Application Access to Security Domain Services
Applications have the ability to access the services of their associated Security Domain. By using these services,
the Application may rely on cryptographic support from the Security Domain to ensure confidentiality and
integrity during personalization and runtime. The Security Domain services defined in this Specification are
generic and shall encompass the following possibilities.
    x   Initiating a Secure Channel,
    x   Verifying an off-card entity,




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
88                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

     x   Creating a Secure Channel upon successful verification of an off-card entity,
     x   Providing a method of mutual authentication between the card and an off-card entity,
     x   Unwrapping a command received within a Secure Channel,
     x   Verifying the integrity when unwrapping,
     x   Obtaining the original data in the case of confidentiality when unwrapping,
     x   Controlling the sequence of APDU commands,
     x   Decrypting a secret data block,
     x   Closing a Secure Channel upon request,
     x   Destroying any secret created by the act of setting up a Secure Channel.
Depending on the specific Secure Channel Protocol supported, the Security Domain services may also encompass
the possibility of:
     x   Wrapping a response sent within a Secure Channel (adding integrity and/or encrypting the original data
          in the case of confidentiality),
     x   Controlling the sequence of APDU responses.
A Security Domain may support the management of multiple Secure Channel Sessions concurrently (i.e.
Applications selected on multiple logical channels each initiating a Secure Channel) or may limit itself to only
managing one Secure Channel Session immaterial of the number of concurrently selected Applications that
attempt to use its services. If a Security Domain does support the management of multiple Secure Channel
Sessions concurrently, it shall be able to differentiate between the multiple Secure Channel Sessions and their
respective logical channels. If a Security Domain does not support the management of multiple Secure Channel
Sessions concurrently, when a request is made to open a Secure Channel Session on a logical channel different
from the current Secure Channel Session, the Security Domain rejects this request to initiate a new Secure
Channel Session.
If a request is made by an Application to use the services of its associated Security Domain on a logical channel
different from the one on which its Secure Channel Session was opened, the Security Domain shall reject this
request.


7.2.2      Security Domain Access to Applications
The Security Domain has the facility to receive a STORE DATA command destined to one of its associated
Applications. The Security Domain pre-processes this command according to the current Secure Channel and
prior to the command being forwarded to the Application.


7.3       Personalization Support
After an Application is installed, the Application may need to obtain its personalization data, including its own
keys and Cardholder-specific data. The Application can utilize the secure communication and key decryption
services of its associated Security Domain to manage the secure loading of this personalization data. This can be
achieved in 2 ways i.e. one being to utilize the runtime messaging support described in Section 7.4 - Runtime
Messaging Support or the other being to utilize the Security Domain's ability to access the Application.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                                89

Using this second method on a card that only supports the Basic Logical Channel allows the Application to be
personalized without the Application being the selected Application. Rather the Security Domain is the selected
Application and the Security Domain receives commands on behalf of the Application. The Security Domain
would pre-process the personalization (STORE DATA) command prior to forwarding the command to the
Application.
Using this second method on a card that supports multiple logical channels differs slightly only in that the
Application could have a multi-selection restriction in which case personalization would fail.
Runtime Behavior
The following runtime behavior requirements apply to the OPEN when a Security Domain pre-processes
Application personalization commands (i.e. the second method). The OPEN shall:
    x   Determine whether the Application being personalized exists within the GlobalPlatform Registry,
    x   Check that the Application being personalized has no multi-selection restrictions,
    x   Check that the currently selected Security Domain is the Security Domain associated with the
         Application being personalized.
Personalization Flow
Figure 7-1 is an example of an Application receiving data from its associated Security Domain during
personalization.

                                       H ost                             S e c urity D om a in        OPE N            App lic a tion


                                                S E LE C T S ecurity D o m ain
             SELECT
                                                    S E LE C T respo nse




                                                    O ptional
                                            A uthentication P rocess

                                                           IN S T A LL
     IN S TA L L [for
   p erson alization ]                               IN S T A LL respo nse




                                                       STORE DATA
                                                                           secure m essaging
                                                                              unwrapping
     S TO R E D A TA                                                                             pro cess data

                                                                                                                   A pplication
                                                                                                                 personalization
                                                 S T O R E D A T A respo nse




                                                  A P D U Inte rfa c e                               GP API



           Figure 7-1: Application Personalization through Associated Security Domain




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
90                            GlobalPlatform Card Specification 2.1.1                                    03/25/2003

7.4      Runtime Messaging Support
Security Domains may provide runtime support for secure communication to their associated Applications.
Instead of loading additional communication keys into an Application, the Application Provider may choose to
use the associated Security Domain services for all Application communication throughout the life of the
Application.
Runtime Messaging Flow
Figure 7-2 is an example of an Application using the services of its associated Security Domain:

                               Host                                Application                        Security Domain



                                            SELECT Application
           SELECT
                                             SELECT Response


                                                                              initiate Secure Channel Session and
                                      Authentication Process                        authenticate off-card entity



                                          Application specific APDU

                                                                                          unwrapping

      Application
                                                                      Application
     Specific APDU                                                   Functionality


                                     Application specific APDU response


                                         Application specific APDU

                                                                                         unwrapping

      Application                                                     Application
     Specific APDU                                                                          decrypt
                                                                     Functionality


                                    Application specific APDU response



                                            APDU Interface                                 GP API

                                     Figure 7-2: Runtime Messaging Flow




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            91

7.5      DAP Verification
If the Application Provider does not have a Security Domain capable of Delegated Management to load
application code to the card, it may rely on the loading services of the Card Issuer or a third party (Controlling
Authority or Application Provider) that has the Delegated Management privilege on the card. A Controlling
Authority may require that all Application code to be loaded to the card shall be verified by the Security Domain
of the Controlling Authority.
The Application Provider may require a check or the Controlling Authority may mandate a check of application
code integrity and authenticity before the application code is loaded, installed and made available to the
Cardholder. The DAP Verification privilege for a Security Domain detailed in this Specification is to provide this
service on behalf of an Application Provider. The mandated DAP Verification privilege provides this service on
behalf of a Controlling Authority.
Verification of a Load File Data Block Signature is required when one or more DAP Blocks are present in the
Load File. Each DAP Block contains the identifier of a Security Domain and a Load File Data Block Signature.
The OPEN shall perform the controls and verifications described in Section 6.4.1 - Card Content Loading and
Installation.
The OPEN shall send the Load File Data Block Hash, the Load File Data Block Signature and the AID of the
Load File to the linked Security Domain for verification.
It is the Security Domain's responsibility to inform the OPEN whether the actual signature is valid or not. In the
Life Cycle State LOCKED, the Security Domain shall always inform the OPEN that the signature is invalid.
The presence of a DAP Block within the Load File implies that the owner of the Security Domain identified in the
DAP Block verified off-card the content of the Load File Data Block. The Load File Data Block Hash, signed to
create the Load File Data Block Signature, creates this link between the Load File Data Block, the Security
Domain and its owner.
Security Domains with DAP Verification privileges shall know the key(s) required to verify a Load File Data
Block Signature.


7.6      Delegated Management
The design of the GlobalPlatform takes into account the possibility that the Card Issuer may not necessarily want
to manage all Card Content changes, especially when the Card Content does not belong to the Card Issuer.
The concept of Delegated Management defined in this Specification gives the Card Issuer the possibility of
empowering partnered Application Providers the ability to initiate approved and pre-authorized Card Content
changes (loading, installing or extraditing).
This approval, which is central to the concept of Delegated Management, ensures that only Card Content changes
that the Card Issuer has authorized will be accepted and processed by the OPEN. This delegation of control in the
Card Content changes gives the Application Provider more flexibility in managing its Application.
The following functions shall be supported in Delegated Management:
    x   Delegated loading (requires a pre-authorization)
    x   Delegated installation (requires a pre-authorization)
    x   Delegated extradition (requires a pre-authorization)




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
92                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

     x   Delegated deletion (no pre-authorization required)
Delegated Management is not allowed when the card Life Cycle State is CARD_LOCKED.


7.6.1      Delegated Loading
Delegated loading allows an Application Provider to establish a Secure Channel, for transferring Load Files
directly to its Security Domain.
The load process comprises one INSTALL [for load] command and one or more LOAD commands all of which
are processed by the Security Domain. The Security Domain then passes the load request and Load File
information to the OPEN for additional verification and processing.
The Load Token allows the OPEN, via the Issuer Security Domain verification, to ensure that the Card Issuer
authorized the load process and the loading of the content of the Load File Data Block.
The Load Token implies that the Card Issuer pre-authorized the data required for the delegated load process. The
pre-authorized data includes most of the INSTALL [for load] command and the Load File Data Block Hash. The
Load File Data Block Hash links the Token to the actual Load File Data Block.
The response to the last LOAD command identifies the end of the load process. Following the completion of the
load process, an optional Load Receipt is returned to the Security Domain performing the Delegated Management
operation and shall be transmitted by the Security Domain to the off-card entity.
The Application Provider may then forward the Load Receipt to the Card Issuer as a proof that the loading
process was successfully performed. The purpose of the optional Load Receipt is to assist the Card Issuer in
keeping its Card Management System synchronized with its card base.
Runtime Behavior
The OPEN shall provide the following additional services (see Section 6.4.1.1 - Card Content Loading for basic
requirements) during the delegated loading process:
     x   Check that the Life Cycle of the Security Domain performing the load is in the state of
          PERSONALIZED,
     x   Check that the Security Domain performing the load has the Delegated Management privilege,
     x   Request the Issuer Security Domain to verify the Load Token,
     x   On completion of the load procedure the OPEN shall:
              Request the Issuer Security Domain to generate a Load Receipt.


7.6.2      Delegated Installation
Delegated Installation allows an Application Provider to establish a Secure Channel, for installing an Application
from an Executable Load File that is associated to the Application Provider's Security Domain.
The installation process comprises one INSTALL [for install] command processed by the Security Domain. The
Security Domain then passes the install request to the OPEN for additional verification and processing.
The Install Token allows the OPEN, via the Issuer Security Domain verification, to ensure that the Card Issuer
authorized the installation process.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            93

The Install Token implies that the Card Issuer pre-authorized the data required for the delegated installation
process. The pre-authorized data includes most of the INSTALL [for install] command.
The response to the INSTALL [for install] command identifies the end of the installation process. Following the
completion of the installation process, an optional Install Receipt is returned to the Security Domain performing
the Delegated Management operation and shall be transmitted by the Security Domain to the off-card entity.
The Application Provider may then forward the Install Receipt to the Card Issuer as a proof that the installation
process was successfully performed. The purpose of the optional Install Receipt is to assist the Card Issuer in
keeping its Card Management System synchronized with its card base.
Runtime Behavior
The OPEN shall provide the following additional services (see Section 6.4.1.2 - Card Content Installation for
basic requirements) during the delegated installation process:
    x   Check that the Life Cycle of the Security Domain performing the installation is in the state of
         PERSONALIZED,
    x   Check that the Security Domain performing the installation has the Delegated Management privilege,
    x   Check that the Security Domain performing the installation is the Security Domain associated with the
         Executable Module from which the Application is being installed,
    x   Request the Issuer Security Domain to verify the Install Token,
    x   On completion of the install procedure the OPEN shall:
              Request the Issuer Security Domain to generate an Install Receipt.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
94                            GlobalPlatform Card Specification 2.1.1                                      03/25/2003

Delegated Loading and Installation Flow
The processes of delegated loading and delegated installation may occur in a single Application Session where an
Application is loaded and then installed immediately. Alternatively, the delegated loading and delegated
installation processes may occur in separate Card Sessions.
Figure 7-3 is an example of loading and installing an Application on the card through a Security Domain with the
Delegated Management privilege.


                                                                                           Issuer              Security
            Host                                   Security                                                  Domain with
                                                   Domain               OPEN              Security
                                                                                          Domain            DAP verification

                         SELECT Security Domain
  SELECT
                             SELECT response


                             Optional
                       Authentication Process
                             INSTALL [for load]
                                                                  validate request
  INSTALL                                                                                 validate Load
                                                                                              Token
                            INSTALL response
                                 LOAD [0]                                                                    verify Load File
                                                                                                               Data Block
     LOAD                                                                                                       Signature
                             LOAD response

                                 LOAD [n]
     LOAD
                             LOAD response

                               LOAD [last]                       verify Load File
                                                               Data Block Hash
                                                              create and register
                                                               Executable Load
     LOAD                                                     File and Executable
                                                                     Modules           generate optional
                                                                                         Load Receipt
                             LOAD response

                           INSTALL [for install]                 validate request
                                                                                        validate Install
                                                                                             Token
     INSTALL                                                    install and register
                                                                    Application
                                                                                       generate optional
                                                                                        Install Receipt
                              INSTALL response
                                                                             Unspecified               Unspecified
                                  APDU
                                Interface
                                                                              interface                 interface

                               Figure 7-3: Delegated Loading and Installation




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            95

7.6.3      Delegated Extradition
Delegated Extradition allows an Application Provider to establish a Secure Channel for extraditing one of its
Applications. The extradition may apply at any time during the Application Life Cycle.
The extradition process comprises one INSTALL [for extradition] command processed by the Security Domain.
The Security Domain then passes the extradition request to the OPEN for additional verification and processing.
The Extradition Token allows the OPEN, via the Issuer Security Domain verification, to ensure that the Card
Issuer authorized the extradition process.
The Extradition Token implies that the Card Issuer pre-authorized the data required for the delegated extradition
process. The pre-authorized data includes most of the INSTALL [for extradition] command.
The response to the INSTALL [for extradition] command identifies the end of the extradition process. Following
the completion of the extradition process, an optional Extradition Receipt is returned to the Security Domain
performing the Delegated Management operation and shall be transmitted by the Security Domain to the off-card
entity.
The Application Provider may then forward the Extradition Receipt to the Card Issuer as a proof that the
extradition process was successfully performed. The purpose of the optional Extradition Receipt is to assist the
Card Issuer in keeping its Card Management System synchronized with its card base.
Runtime Behavior
The OPEN shall provide the following additional services (see Section 6.4.3 - Content Extradition for basic
requirements) during the delegated extradition process:
    x   Check that the Life Cycle of the Security Domain performing the extradition is in the state of
         PERSONALIZED,
    x   Check that the Security Domain performing the extradition has the Delegated Management privilege,
    x   Request the Issuer Security Domain to verify the Extradition Token,
    x   On completion of the extradition procedure the OPEN shall:
              Request the Issuer Security Domain to generate an Extradition Receipt.


7.6.4      Delegated Deletion
The Application Provider may instruct the OPEN to delete its associated Applications and Executable Load Files.
The OPEN shall honor the deletion request without pre-authorization from the Card Issuer, i.e. no Token is
required. The DELETE command is used for deleting Applications and Executable Load Files.
The delegated deletion process comprises one DELETE command processed by the Security Domain. The
Security Domain then passes the deletion request to the OPEN for additional verification and processing.
The response to the DELETE command identifies the end of the deletion process. Following the completion of
the deletion process, an optional Delete Receipt is returned to the Security Domain performing the Delegated
Management operation and shall be transmitted by the Security Domain to the off-card entity.
The Application Provider may then forward the Delete Receipt to the Card Issuer as a proof that the deletion
process was successfully performed. The purpose of the optional Delete Receipt is to assist the Card Issuer in
keeping its Card Management System synchronized with its card base.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
96                            GlobalPlatform Card Specification 2.1.1                                  03/25/2003

Runtime Behavior
The OPEN shall provide the following additional services (see Section 6.4.2 - Content Removal for basic
requirements) during the delegated deletion process:
     x   Check that the Life Cycle of the Security Domain performing the deletion is in the state of
          PERSONALIZED,
     x   Check that the Security Domain performing the deletion has the Delegated Management privilege,
     x   Check that the Security Domain performing the delete is the Security Domain associated with the
          Executable Load File or Application being deleted. When simultaneously deleting an Executable Load
          File and all its related Applications, check that the Security Domain performing the delete is the Security
          Domain associated with the Executable Load File and each of the Applications being deleted.
     x   On completion of the deletion procedure the OPEN shall:
              Request the Issuer Security Domain to generate a Delete Receipt.
Delegated Deletion Flow
Figure 7-4 is an example of deleting an Application or Executable Load File on the card through a Security
Domain with the Delegated Management privilege:

                           Host                       Security Domain                                  Issuer Security
                                                                                        OPEN
                                                                                                           Domain


                                   SELECT Security Domain
      SELECT
                                      SELECT Response


                                      Optional
                                Authentication Process

                                           DELETE                                    verify request
      DELETE                                                                         delete content
                                                                                                       generate optional
                                                                                                        Delete Receipt
                                       DELETE Response



                                    APDU Interface           Unspecified Interface         Unspecified Interface


                                         Figure 7-4: Delegated Deletion

7.7       Delegated Management Tokens and Receipts and DAP
          Verification
This Section defines the mechanisms, data elements and the format of Tokens and Receipts. It also describes the
mechanisms and the data elements required for DAP Verification.
The algorithm for Token signatures is defined in Appendix B.3 - Public Key Cryptography Scheme 1 (PKCS#1).
Tokens may be generated for use on multiple cards, depending on the Card Issuer's security policy




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                      GlobalPlatform Card Specification 2.1.1                                                      97

7.7.1       Load Token
The Load Token allows for the verification of the load process prior to actually processing the INSTALL [for
load] command. The OPEN shall request the Issuer Security Domain to verify the Load Token.
The Load Token is a signature on most of the INSTALL [for load] command including the Load File Data Block
Hash. The Token is appended to the INSTALL [for load] command.
The Load File Data Block Hash is included in the calculation to ensure that the Load File Data Block that has
been approved by the generation of a Load Token is the same Load File Data Block that is subsequently received
by the OPEN through the series of LOAD commands that follow the INSTALL [for load] command.
Once the complete Load File has been received, the OPEN shall verify that the Load File Data Block is valid
using the Load File Data Block Hash. If the Load File Data Block Hash is not valid the OPEN shall abort the load
process at this stage.
Figure 7-5 details the Load Token calculation performed by the Card Issuer.



                                                                 len, Load File
                          len, Load File     len, Security                         len, Load
    INSTALL    P1,P2,Lc                                            Data Block                       Load Token
                               AID           Domain AID                             Params
                                                                      Hash



                                                                                                                      Issuer Token
                                                                                                 Token Calculation
                                                                                                                     Calculation Key




                                            Figure 7-5 Load Token Calculation


7.7.2       Load Receipt
If the Card Issuer's security policy requires the generation of Receipts, the Load Receipt provides confirmation
from the card that a successful load has occurred through the delegated loading process. The Load Receipt is
comprised of data related to the delegated load process including Card Unique Data and generated by the Issuer
Security Domain. The Receipt is included in the response message for the last LOAD command issued in a
sequence of LOAD commands to the Security Domain.
Figure 7-6 details the Load Receipt calculation performed by the Issuer Security Domain.


 len, Confirmation    len, Card      len, Load File          len, Security
                                                                                     Load Receipt
      Counter        Unique Data          AID                Domain AID




                                                                                                        Issuer Security Domain
                                                                                  Receipt Calculation
                                                                                                        Receipt Generation Key




                                           Figure 7-6: Load Receipt Calculation




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
98                                 GlobalPlatform Card Specification 2.1.1                                                 03/25/2003

7.7.3         Install and Extradition Tokens
The Install Token allows for the verification of the installation process prior to actually processing the INSTALL
[for install] or [for make selectable] command. The Extradition Token allows for the verification of the
extradition process prior to actually processing the INSTALL [for extradition] command. The OPEN shall request
the Issuer Security Domain to verify the Install and Extradition Tokens. The Install and Extradition Tokens are a
signature of the following fields within an INSTALL command and is appended to the INSTALL command. The
same Token applies to the INSTALL [for install] command, the INSTALL [for make selectable] command and
the INSTALL [for extradition] command.
Figure 7-7 details the Install and Extradition Tokens calculation performed by the Card Issuer.


                         len, Executable len, Executable len, Instance        len,    len, Install
 INSTALL      P1,P2,Lc                                                                                 Install Token
                          Load File AID    Module AID         AID          Privileges Params




                                                                                                                             Issuer Token
                                                                                                     Token Calculation
                                                                                                                            Calculation Key




                                  Figure 7-7: Install//Extradition Token Calculation


7.7.4         Install Receipt
If the Card Issuer's security policy requires the generation of Receipts, the Install Receipt provides confirmation
from the card that a successful installation has occurred through the delegated installation process. The Install
Receipt is comprised of data related to the delegated installation process including Card Unique Data generated
by the Issuer Security Domain. An Install Receipt is returned in the response message to the INSTALL [for
install] command and the INSTALL [for install and make selectable] command sent to the Security Domain. An
Install Receipt is not returned in the response message to the INSTALL [for make selectable] command or the
INSTALL [for personalization] command.
Figure 7-8 details the Install Receipt calculation performed by the Issuer Security Domain.
.


     len, Confirmation   len, Card Unique     len, Load File   len, Application
                                                                                            Install Receipt
          Counter              Data                AID               AID




                                                                                                                       Issuer Security Domain
                                                                                         Receipt Calculation
                                                                                                                       Receipt Generation Key




                                            Figure 7-8: Install Receipt Calculation




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                        GlobalPlatform Card Specification 2.1.1                                                   99

7.7.5        Extradition Receipt
If the Card Issuer's security policy requires the generation of Receipts, the Extradition Receipt provides
confirmation from the card that a successful extradition has occurred through the delegated extradition process.
The Extradition Receipt is comprised of data related to the delegated extradition process including Card Unique
Data generated by the Issuer Security Domain. The Extradition Receipt is returned in the response message to the
INSTALL [for extradition] command issued to the Security Domain.
Figure 7-9 details the Extradition Receipt calculation performed by the Issuer Security Domain.


len, Confirmation    len, Card    len, extradited len, old Security len, new Security     Extradition
     Counter        Unique Data   Application AID   Domain AID         Domain AID          Receipt




                                                                                           Receipt       Issuer Security Domain
                                                                                          Calculation    Receipt Generation Key




                                    Figure 7-9: Extradition Receipt Calculation


7.7.6        Delete Receipt
If the Card Issuer's security policy requires the generation of Receipts, the Delete Receipt provides confirmation
from the card that a successful deletion has occurred through the delegated deletion process. The Delete Receipt
is comprised of data related to the delegated deletion process including Card Unique Data generated by the Issuer
Security Domain. The Delete Receipt is returned in the response message to the DELETE command issued to the
Security Domain.
Figure 7-10 details the Delete Receipt calculation performed by the Issuer Security Domain.


               len, Confirmation len, Card Unique    len, Deleted             Delete Receipt
                    Counter            Data               AID




                                                                                 Receipt         Issuer Security Domain
                                                                                Calculation      Receipt Generation Key




                                       Figure 7-10: Delete Receipt Calculation


7.7.7        Load File Data Block Hash
The Load File Data Block Hash provides integrity of the Load File Data Block following receipt of the complete
Load File Data Block. The OPEN shall verify the integrity of the Load File Data Block prior to creating an
Executable Load File.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
100                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The Load File Data Block Hash is a message digest of the Load File Data Block. The Load File Data Block Hash
is appended to the INSTALL [for load] command.
Figure 7-11 details the Load File Data Block Hash calculation performed by the Issuer Security Domain, an
Application Provider and a Controlling Authority.


                           Load File Data       Load File Data Block
                               Block                    Hash




                                                  Message Digest
                                                    Calculation




                            Figure 7-11: Load File Data Block Hash Calculation


7.7.8      Load File Data Block Signature (DAP Verification)
The Load File Data Block Signature provides verification of the Load File Data Block prior to commencing with
the processing of the actual Load File Data Block. The OPEN shall request the Security Domain linked to the
Load File Data Block Signature to verify the signature.
The Load File Data Block Signature is a signature of the Load File Data Block Hash. Each Load File Data Block
Signature is combined with its linked Security Domain AID in the TLV structured DAP Block. DAP Blocks are
positioned in the beginning of the Load File.
Figure 7-12 details the Load File Data Block Signature calculation performed by an Application Provider or
Controlling Authority.


                           Load File Data        Load File Data Block
                            Block Hash                Signature




                                                     Signature          Application Provider DAP
                                                     Calculation             Calculation Key




                         Figure 7-12: Load File Data Block Signature Calculation




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          101


8. Secure Communication
The GlobalPlatform documentation broadly defines the notion of secure communication over and above that
defined in ISO specifications. Specific mention is made of secure messaging for APDU commands; an optional
authentication process is implied in most of the flow diagrams and Application access to Security Domain
services implies that the ability to create a Secure Channel Session exists. This Chapter defines the general rules
that apply to all Secure Channel Protocols. Applications that utilize the services of Security Domains can use the
Secure Channel Protocol supported by their associated Security Domains.
These protocols provide a means by which the Issuer Security Domain, a Security Domain, or an Application
may communicate with an off-card entity within a logically secure environment.
Logical channels facilitate the possibility of more than one of the above off-card entities communicating
concurrently with multiple Applications on the card, each within its own logically secure environment. It is the
responsibility of the Security Domain owner to define whether this is possible or not.


8.1      Secure Channel
The Secure Channel provides a secure communication channel between a card and an off-card entity during a
Application Session.
A Secure Channel Session is divided into three sequential phases:
    x   Secure Channel Initiation – when the on-card Application and the off-card entity have exchanged
         sufficient information enabling them to perform the required cryptographic functions. The Secure
         Channel Session initiation always includes the authentication of the off-card entity by the on-card
         Application.
    x   Secure Channel Operation – when the on-card Application and the off-card entity exchange data
         within the cryptographic protection of the Secure Channel Session. The Secure Channel services offered
         may vary from one Secure Channel Protocol to the other.
    x   Secure Channel Termination – when either the on-card Application or the off-card entity determines
         that no further communication is required or allowed via an established Secure Channel Session.
The 3 levels of security provided by the Secure Channel are defined in Section 4.3.2 - Secure Communication.
A further level of security applies to sensitive data (e.g. secret keys) that shall always be transmitted as
confidential data.


8.2      Explicit / Implicit Secure Channel
A Secure Channel Session is open after a successful initiation, including the authentication of the off-card entity
by the on-card Application. A Secure Channel Session is terminated after the last successful communication
within the same Secure Channel Session.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
102                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

8.2.1       Explicit Secure Channel Initiation
Initiating a Secure Channel Session may be achieved by the off-card entity using appropriate APDU command(s)
or by the on-card Application using the appropriate API. This method is the explicit Secure Channel creation.
Appropriate APDU commands allow the off-card entity to instruct the card what level of security is required for
the current Secure Channel Session (integrity and/or confidentiality). They also give the off-card entity the
possibility of selecting the keys to be used.


8.2.2       Implicit Secure Channel Initiation
The Secure Channel Session is initiated by the on-card Secure Channel Protocol handler, directly or through an
API, when receiving the first APDU command that contains a cryptographic protection. The Secure Channel
Protocol handler implicitly knows the required level of security. The Secure Channel Protocol handler may
implicitly know which keys are to be used or may have been previously instructed by the off-card entity using
appropriate APDU command(s) prior to initiating the Secure Channel Session.


8.2.3       Secure Channel Termination
Termination of the Secure Channel Session can be achieved by the on-card Application using the appropriate API
or by the off-card entity using the appropriate APDU command.
Termination of the Secure Channel Session occurs when one of the following conditions are met:
      x   The on-card Application receives the first APDU command with an erroneous cryptographic protection;
      x   The on-card Application receives an APDU command without the required cryptographic protection set
           up during Secure Channel Session initiation;
      x   The on-card Application Session is terminated - for instance when another Application is selected (i.e.
           the Application Session ends) on the same logical channel. It may be the responsibility of the
           Application to initiate the termination of the Secure Channel Session when this occurs;
      x   The associated logical channel is explicitly closed;
      x   The card is reset or powered off (i.e. the Card Session ends).
A Secure Channel Session on a logical channel is never terminated in favor of a new Secure Channel Session
being initiated on another logical channel.


8.3        Direct / Indirect Handling of a Secure Channel Protocol
There are two ways for the on-card Application to handle the Secure Channel Protocol.
      x   Direct - The Application owns its Secure Channel key set and fully implements the protocol: an
           example is Security Domains.
      x   Indirect – The Application uses the Security Domain services to handle the Secure Channel Protocol.
           This allows the Application using these services to be coded independently from the Secure Channel
           Protocol supported by the card.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          103

8.4      Entity Authentication
Off-card entity authentication is achieved through the process of initiating a Secure Channel Session and provides
assurance to the card that it is communicating with an authenticated entity. If any step in the authentication
process fails, the process shall be restarted.
Authentication of the off-card entity is only provided for a limited time, a Secure Channel Session, and is valid
only for the messages within that Secure Channel. This Secure Channel Session relates to the establishment and
termination of a Secure Channel. If the Secure Channel Session is closed for any reason the off-card entity shall
no longer be considered authenticated.


8.5      Secure Messaging
Secure messaging allows a sending entity to add confidentiality and/or integrity and authentication to the
composition of an APDU message prior to the message being transmitted to a receiving entity:
    x   Integrity of an APDU command sent to the card or confidentiality of the command message and
         integrity of an APDU command sent to the card.
    x   Integrity of the sequence of APDU commands sent to the card within a Secure Channel Session
    x   Optionally, depending on the Secure Channel Protocol, confidentiality and/or integrity of an APDU
         response message sent by the card, and integrity of the sequence of responses within a Secure Channel
         Session.
In the context of secure messaging, message integrity also provides data origin authentication.


8.6      Secure Channel Protocol Identifier
The Secure Channel Protocol identifies which particular secure communication protocol and set of security
services are implemented in a Security Domain. The following values are assigned to the Secure Channel
Protocol identifier:
    x   '00' – Not available
    x   '01' – Secure Channel Protocol 1 defined in Appendix D Secure Channel Protocol '01'
    x   '02' – Secure Channel Protocol 2 defined in Appendix E Secure Channel Protocol '02'
    x   '03' to '7F' – Reserved for Future Use by GlobalPlatform
    x   '80' to 'EF' – Reserved for use by individual schemes registered by GlobalPlatform
    x   'F0' to 'FF' – Reserved for proprietary use and not registered by GlobalPlatform
The Secure Channel Protocol '01' is backward compatible with the Open Platform Card Specification version
2.0.1'.
The Secure Channel Protocol '02' includes services in addition to those provided by Secure Channel Protocol '01'
as well as optimizing the operation of some services compared to Secure Channel Protocol '01'.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
104                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003




                                              Part IV
                                               APDU
                                             Command
                                             Reference




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
      03/25/2003                    GlobalPlatform Card Specification 2.1.1                                            105


      9. APDU Command Reference
This chapter details the GlobalPlatform APDU commands that may be implemented. The commands are listed
alphabetically.
Table 9-1 summarizes the APDU commands that shall be supported by the Issuer Security Domain and the
requirements for support of these APDU commands by other Security Domains. When logical channels are
supported, the MANAGE CHANNEL command is only processed by the OPEN and no Security Domain support is
required for this command.

        Command               OP_READY   INITIALIZED   SECURED  CARD_LOCKED TERMINATED
                                 DM           DM         DM          DM         DM
                             ISD     SD ISD       SD ISD     SD ISD      SD ISD     SD
                                 SD           SD          SD         SD         SD
DELETE
Executable Load File
DELETE
Executable Load File
and related
Application(s)
DELETE Application            9                    9                   9
DELETE Key
GET DATA                      9      9      9      9     9      9      9      9     9       9                      9
GET STATUS                    9                    9                   9                    9
INSTALL [for load]
INSTALL [for install]
(*)                           9      9             9     9             9      9
INSTALL [for make
selectable] (*)               9      9             9     9             9      9
INSTALL [for
extradition]
INSTALL [for
personalization]
LOAD
PUT KEY                       9                    9                   9
SELECT                        9      9      9      9     9      9      9      9     9       9
SET STATUS                    9                    9                   9                    9
STORE DATA                    9                    9                   9
                   Table 9-1: Authorized GlobalPlatform Commands per Card Life Cycle State
      Legend of Table 9-1:
  ISD: Issuer Security Domain.
  DM SD: Application Provider Security Domain with Delegated Management privileges.
  SD: Application Provider Security Domain without Delegated Management privileges.
  9 : Support required.
  Blank cell: Support optional.
      Striped cell: Support prohibited.




      Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
      The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
      information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
      prohibited.
  106                             GlobalPlatform Card Specification 2.1.1                                03/25/2003

  (*) Note: The support of the combined [for install and make selectable] options within the same INSTALL
  command is also required
  Table 9-2 summarizes the minimum security level required for the APDU commands.

                                      Command                     Minimum Security Level
                            DELETE                              Secure Channel initiation
                            GET DATA                            None
                            GET STATUS                          Secure Channel initiation
                            INSTALL                             Secure Channel initiation
                            LOAD                                Secure Channel initiation
                            MANAGE CHANNEL                      Not applicable
                            PUT KEY                             Secure Channel initiation
                            SELECT                              Not applicable
                            SET STATUS                          Secure Channel initiation
                            STORE DATA                          Secure Channel initiation
               Table 9-2: Minimum Security Requirements for GlobalPlatform Commands


  9.1        General Coding Rules
  In all the following tables, an 'x' in a cell means a value that the card shall ignore. If the cell is reserved for future
  use (RFU), the bit should be set to zero.
  The following details the coding rules for:
        x   The Life Cycle States,
        x   The Application Privileges,
        x   The general errors returned in the APDU responses,
        x   The class byte of the APDU commands.
        x   The key type

  9.1.1       Life Cycle Status Coding
The Executable Load File Life Cycle is coded on one byte as described in the following table:

                       b8    b7     b6     b5    b4     b3    B2     b1             Meaning
                        0     0       0     0     0      0     0      1     LOADED
                              Table 9-3: Executable Load File Life Cycle Coding
  The Application Life Cycle has a bit-oriented coded value on one byte as described in the following table.
  Note: the application has free use of bits 4-7, and the coding of these bits is beyond the scope of this
  specification.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
03/25/2003                        GlobalPlatform Card Specification 2.1.1                                      107

                   b8    b7      b6     b5    b4   b3    b2      b1                  Meaning
                   0        0     0      0    0    0     1        1        INSTALLED
                   0        X     X      X    X    1     1        1        SELECTABLE
                   1        X     X      X    X    X     1        1        LOCKED
                                        Table 9-4: Application Life Cycle Coding
The Security Domain Life Cycle has a bit-oriented coded value on one byte as described in the following table:

                   b8    b7      b6     b5    b4   b3    b2      b1                  Meaning
                   0        0     0      0    0    0     1        1        INSTALLED
                   0        0     0      0    0    1     1        1        SELECTABLE
                   0        0     0      0    1    1     1        1        PERSONALIZED
                   1        0     0      0    X    X     1        1        LOCKED
                                      Table 9-5: Security Domain Life Cycle Coding
The allowed Application and Security Domain Life Cycle transitions are described in Chapter 5 - Life Cycle
Models.
The Issuer Security Domain inherits the card Life Cycle State that has a bit-oriented coded value on one byte as
described in the following table:

              b8        b7      b6      b5    b4    b3    b2         b1                Meaning
               0        0        0       0     0    0        0        1     OP_READY
               0        0        0       0     0    1        1        1     INITIALIZED
               0        0        0       0     1    1        1        1     SECURED
               0        1        1       1     1    1        1        1     CARD_LOCKED
               1        1        1       1     1    1        1        1     TERMINATED
                                Table 9-6: Issuer Security Domain Life Cycle Coding
The allowed card Life Cycle transitions are described in Chapter 5 - Life Cycle Models.


9.1.2      Application Privileges Coding
Application Privileges are coded on one byte as described in the following table (See Section 6.6.2.4 -
Application Privileges for additional details):

                   b8    b7      b6     b5    b4   b3    b2      b1                  Meaning
                   1        X     X      X    X    X     X       X        Security Domain
                   1        1     X      X    X    X     X       0        DAP Verification
                   1        X     1      X    X    X     X       X        Delegated Management
                   X        X     X      1    X    X     X       X        Card lock
                   X        X     X      X    1    X     X       X        Card terminate
                   X        X     X      X    X    1     X       X        Default Selected
                   X        X     X      X    X    X     1       X        CVM management
                   1        1     X      X    X    X     X       1        Mandated DAP Verification
                                             Table 9-7: Application Privileges




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
108                            GlobalPlatform Card Specification 2.1.1                                 03/25/2003

An Application may support one or more of these Application privileges.
The Application Privileges individual bits have the following meaning:
b8=1 indicates that the Application is a Security Domain.
b7=1 indicates that the Security Domain has DAP Verification capability.
b6=1 indicates that the Security Domain has Delegated Management privileges.
b5=1 indicates that the Application has the privilege to lock the card.
b4=1 indicates that the Application has the privilege to terminate the card.
b3=1 indicates that the Application has the Default Selected privilege.
b2=1 indicates that the Application has CVM management privileges.
b1=1 indicates that the Security Domain has mandated DAP Verification capability.

9.1.3       General Error Conditions
The following table describes the error conditions that may be returned by any command:

                          SW1      SW2                           Meaning
                            '64'    '00'    No specific diagnosis
                            '67'    '00'    Wrong length in Lc
                            '68'    '81'    Logical channel not supported or is not active
                            '69'    '82'    Security status not satisfied
                            '69'    '85'    Conditions of use not satisfied
                           '6A'     '86'    Incorrect P1 P2
                           '6D'     '00'    Invalid instruction
                           '6E'     '00'    Invalid class
                                      Table 9-8: General Error Conditions


9.1.4       Class Byte Coding
The class byte of all GlobalPlatform commands shall conform to ISO/IEC 7816-4 and shall be coded according to
the following table:

                           CLA                               Meaning
                            '00'     Command defined in ISO/IEC 7816
                            '80'     Proprietary command
                            '84'     Proprietary command with secure messaging
                                           Table 9-9: CLA Byte Coding
Note that the class byte values defined in the above table and subsequent sections of this chapter as well as in
Appendices D and E assume a logical channel number of zero (i.e. are valid for the Basic Logical Channel). Class
byte bits b1 and b2 may be set to define the required logical channel number according to ISO/IEC 7816;
      x   A class byte with bits 1 and 2 set to 00 indicates receipt of the command on the Basic Logical Channel.
      x   A class byte with bits 1 and 2 set to 01 (1), 10 (2) or 11 (3) indicates receipt of the command on a
           Supplementary Logical Channel.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          109

Note: In this version of the Specification only MACs are defined for message integrity.


9.1.5      APDU Command and Response Data
All GlobalPlatform commands comply with ISO/IEC 7816 short message lengths i.e. Lc byte coded on one byte.
All GlobalPlatform command messages (including the APDU header) are limited to 255 bytes in length.


9.1.6      Key Type Coding
The key type is coded on one byte according to the following table:

                  Value                                         Meaning
              '00'-'7F'        Reserved for private use
              '80'             DES – mode (EBC/CBC) implicitly known
              '81'-'9F'        RFU (symmetric algorithms)
              'A0'             RSA Public Key - public exponent e component (clear text)
              'A1'             RSA Public Key - modulus N component (clear text)
              'A2'             RSA Private Key - modulus N component
              'A3'             RSA Private Key - private exponent d component
              'A4'             RSA Private Key - Chinese Remainder P component
              'A5'             RSA Private Key - Chinese Remainder Q component
              'A6'             RSA Private Key - Chinese Remainder PQ component
              'A7'             RSA Private Key - Chinese Remainder DP1 component
              'A8'             RSA Private Key - Chinese Remainder DQ1 component
              'A9'-'FE'        RFU (asymmetric algorithms)
              'FF'             Not Available
                                          Table 9-10: Key Type Coding


9.1.7      Optional Receipts in Delegated Management Response Messages
If a Delegated Management Card Content APDU command contains an optional confirmation containing a
Receipt, the confirmation shall be structured according to the following table:

                                 Length                     Data Element
                               1               Length of Receipt
                               0-n             Receipt
                               1               Length of Confirmation Counter
                               2               Confirmation Counter
                               1               Length of Card Unique Data
                               1-n             Card Unique Data
                                      Table 9-11: Confirmation Structure
Note: Card Unique Data is the concatenation without delimiters of the IIN and the CIN.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
110                              GlobalPlatform Card Specification 2.1.1                               03/25/2003




9.2         DELETE Command

9.2.1            Definition and Scope
The DELETE command is used to delete a uniquely identifiable object such as an Executable Load File, an
Application, optionally an Executable Load File and its related Applications or a key. In order to delete an object,
the object shall be uniquely identifiable by the selected Application, Security Domain or Issuer Security Domain.


9.2.2            Command Message
The DELETE command message is coded according to the following table:

                 Code                Value                                     Meaning
          CLA                 '80' or '84'
          INS                 'E4'                   DELETE
          P1                  '00'                   Reference control parameter P1
          P2                  'xx'                   Reference control parameter P2
          Lc                  'xx'                   Length of data field
          Data                'xxxx…'                TLV coded objects (and MAC if present)
          Le                  '00'
                                    Table 9-12: DELETE Command Message

9.2.2.1          Reference Control Parameter P1
Reference control parameter P1 shall always be set to '00'.

9.2.2.2          Reference Control Parameter P2
The reference control parameter P2 indicates whether the object in the data field is being deleted or whether the
object in the data field and its related objects are being deleted. It shall be coded according to the following table:

   b8        b7       b6    b5      b4       b3    b2      b1                          Meaning
      0          0      0    0       0       0      0       0     Delete object
      1          0      0    0       0       0      0       0     Delete object and related object
                            Table 9-13: DELETE Reference Control Parameter P2

9.2.2.3          Data Field Sent in the Command Message
The data field of the DELETE command message shall contain the TLV coded name(s) of the object to be
deleted.
The identity of the Application or Executable Load File to delete shall be specified using the tag for an AID ('4F')
followed by a length and the AID of the Application or Executable Load File. When simultaneously deleting an
Executable Load File and all its related Applications, only the identity of the Executable Load File shall be
provided.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                      GlobalPlatform Card Specification 2.1.1                                        111

Deleting a key shall be specified using the following tags:

                    Key management                    Tag      Length                    Value
           Delete a Key Identifier                  'D0'      '01'          Key Identifier
           Delete a Key Version Number              'D2'      '01'          Key Version Number
                        Table 9-14: DELETE [key] Command Message Data Field
A single key is deleted when both the Key Identifier ('D0') and the Key Version Number ('D2') are provided in the
DELETE command message data field.


9.2.3      Response Message
A data field shall always be returned in the response message. The content of the data field is only relevant in the
case of Delegated Management i.e. if a Security Domain with the Delegated Management privilege is deleting an
Application or Executable Load File, a Receipt may be present in the data field depending on the security policy
of the Card Issuer.

9.2.3.1    Data Field Returned in the Response Message
If the Issuer Security Domain processes the DELETE command or if a key is being deleted, a single byte of '00'
shall be returned indicating that no additional data is present.
For a DELETE command, indicating an Application or an Executable Load File, being issued to a Security
Domain with the Delegated Management privilege, the data field may contain the confirmation of the delete
procedure. The overall length of the response message shall not exceed 256 bytes.
The following table describes the structure of the DELETE response data field.

          Presence          Length in Bytes                                      Name
      Mandatory           1                           Length of delete confirmation
      Conditional         0-n                         Delete confirmation (see Section 9.1.7)
                                    Table 9-15: DELETE Response Data Field

9.2.3.2    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
one of the following error conditions.

                           SW1            SW2                          Meaning
                             '65'           '81'       Memory failure
                            '6A'            '88'       Referenced data not found
                            '6A'            '82'       Application not found
                            '6A'            '80'       Incorrect values in command data
                                     Table 9-16: DELETE Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
112                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003


9.3        GET DATA Command

9.3.1       Definition and Scope
The GET DATA command is used to retrieve a single data object. Reference control parameters P1 and P2
coding is used to define the specific data object tag. The data object may contain information pertaining to a key.


9.3.2       Command Message
The GET DATA command message is coded according to the following table:

               Code                   Value                                    Meaning
             CLA           '00', '80' or '84'
             INS           'CA'                            GET DATA
             P1            'xx'                            '00' or high order tag value
             P2            'xx'                            Low order tag value
             Lc            'xx'                            Not present or length of MAC
             Data          'xxxx…'                         MAC if present
             Le            '00'
                                 Table 9-17: GET DATA Command Message

9.3.2.1     CLA Byte
A value '00' defines the GET DATA command with the ISO/IEC 7816-4 structure.
A value '80' or '84' defines the GlobalPlatform structure of the GET DATA command.

9.3.2.2     Parameter P1 and P2
Parameters P1 and P2 define the tag of the data object to be read.
The Issuer Security Domain shall support at least the following data object tags:
      x   Tag '42': Issuer Identification Number
      x   Tag '45': Card Image Number
      x   Tag '66': Card Data
      x   Tag 'E0': Key Information Template
      x   Tag 'C1': Sequence Counter of the default Key Version Number
If the card supports Delegated Management and the Issuer’s security policy requires the presence of Receipts,
then the Issuer Security Domain shall also support the following additional data object tag:
      x   Tag 'C2': Confirmation Counter
An Application Provider Security Domain shall support at least the following data object tags:
      x   Tag 'E0': Key Information Template
      x   Tag 'C1': Sequence Counter of the default Key Version Number




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          113

9.3.2.3    Data Field Sent in the Command Message
The data field of the GET DATA command message shall be empty unless a MAC is required.


9.3.3      Response Message

9.3.3.1    Data Field Returned in the Response Message
For a GlobalPlatform type GET DATA command, the GET DATA response data field shall contain the TLV
coded data object referred to in reference control parameters P1 and P2 of the command message.
For an ISO type GET DATA command, the GET DATA response data field shall contain only the value of the
TLV coded data object referred to in reference control parameters P1 and P2 of the command message.
When retrieving key information for the currently selected Application, the key information is returned in the
template 'E0' where each Key Information Data is introduced by the tag 'C0' and is structured as follows:

                    Parameter                          Length                           Coding
   Key Identifier                                    1 Byte        0-255
   Key Version Number                                1 Byte        0-255
   Key type of first (or only) key component         1 Byte        See Section 9.1.6 - Key Type Coding
   Length of first (or only) key component           1 Byte        1-255
   …                                                 …             …
   Key type of last key component                    1 Byte        See Section 9.1.6 - Key Type Coding
   Length of last key component                      1 Byte        1-255
                                  Table 9-18: Key Information Data Structure

9.3.3.2    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
the following error condition.

                             SW1        SW2                        Meaning
                           '6A'        '88'        Referenced data not found
                                   Table 9-19: GET DATA Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
114                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003




9.4       GET STATUS Command

9.4.1      Definition and Scope
The GET STATUS command is used to retrieve Issuer Security Domain, Executable Load File, Executable
Module, Application or Security Domain Life Cycle status information according to a given match/search criteria.
GET STATUS is the complementary command to SET STATUS.


9.4.2      Command Message
The GET STATUS command message shall be coded according to the following table.

                    Code              Value                              Meaning
                     CLA            '80' or '84'
                     INS                'F2'           GET STATUS
                      P1                'xx'           Reference control parameter P1
                      P2                'xx'           Reference control parameter P2
                      Lc                'xx'           Search criteria (and MAC if present)
                      Le                '00'
                               Table 9-20: GET STATUS Command Message

9.4.2.1    Reference Control Parameter P1
Reference control parameter P1 is used to select a subset of statuses to be included in the response message.
The following values of the reference control parameter may apply:
'80' – Issuer Security Domain only. In this case the search criteria is ignored and the Issuer Security Domain
information is returned.
'40' – Applications and Security Domains only.
'20' – Executable Load Files only.
'10' – Executable Load Files and their Executable Modules only.
Other values for this reference control parameter may be assigned in the future.
The ability to differentiate a Security Domain from an Application is achieved via the Application Privileges.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                      GlobalPlatform Card Specification 2.1.1                                        115




9.4.2.2    Reference Control Parameter P2
The reference control parameter P2 controls the number of consecutive GET STATUS command and indicates
the format of the response message. It shall be coded according to the following table.

   b8      b7      b6      b5      b4      b3      b2      b1                           Meaning
    X       X       X       X       X       X                     RFU
                                                    X       0     Get first or all occurrence(s)
                                                    X       1     Get next occurrence(s)
                                                    0       X     Response data structure according to Table 9-22
                                                                  and Table 9-24
                                                    1       X     Response data structure according to Table 9-23
                        Table 9-21: GET STATUS Reference Control Parameter P2
The get next occurrence indicator shall be rejected if no prior GET STATUS [get first or all occurrence(s)] was
received within the current Application Session.
When retrieving the status of the Issuer Security Domain only, the get next occurrence indicator shall be rejected.

9.4.2.3    Data Field Sent in the Command Message
The GET STATUS command message data field contains the TLV coded search qualifier(s).
The tag '4F' shall be used to indicate the Application Identifier (AID). It shall be possible to search for all the
occurrences that match the selection criteria according to the reference control parameter P1 using a search
criteria of '4F' '00'.
It shall be possible to search for all Applications with the same RID.


9.4.3      Response Message

9.4.3.1    Data Field Returned in the Response Message
Based upon the search criteria of the GET STATUS command data field and the selection criteria of reference
control parameter P1 and P2, multiple occurrences of the data structure in the following tables may be returned.

           Length           Value                                      Meaning
           1            'xx'               Length of AID
           1-n          'xxxx…'            AID
           1            'xx'               Life Cycle State
           1            'xx'               Application Privileges
  Table 9-22: Issuer Security Domain, Application and Executable Load File Information Data




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
116                                GlobalPlatform Card Specification 2.1.1                             03/25/2003

                 Tag               Length                        Value                            Presence
          'E3'                   Variable        GlobalPlatform Registry related data
                 '4F'            1-n             AID
                 '9F70'          '01'            Life Cycle State
                 'C5'            '01'            Application Privileges                         Conditional
                  '84'           1-n             First or only Executable Module AID            Conditional
                    …            ...             …                                              …
                  '84'           1-n             Last Executable Module AID                     Conditional
                                   Table 9-23: GlobalPlatform Registry Data (TLV)
In Table 9-23, the Application Privileges field shall be present for the Issuer Security Domain, Security Domains
and Applications and shall be absent for Executable Load Files.
In Table 9-23, the Executable Modules are only present if reference control parameter P1 indicates Executable
Load Files and their Executable Modules only.

            Length               Value                                  Meaning
            1             'xx'                 Length of Executable Load File AID
            1-n           'xxxx…'              Executable Load File AID
            1             'xx'                 Executable Load File Life Cycle State
            1             '00'                 Application Privileges
            1             'xx'                 Number of associated Executable Modules
            1             'xx'                 Length of Executable Module AID
            1-n           'xxxx…'              Executable Module AID
            …             …                    …
            1             'xx'                 Length of Executable Module AID
            1-n           'xxxx…'              Executable Module AID
             Table 9-24: Executable Load File and Executable Module Information Data
The Issuer Security Domain, Security Domain, Application and Executable Load File Life Cycle State and the
Application Privileges are coded according to the general coding rules as defined in Section 9.1 - General Coding
Rules.

9.4.3.2    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
The command may return the following warning condition to indicate that a subsequent GET STATUS [get next
occurrence(s)] may be issued to retrieve additional data:

                           SW1           SW2                       Meaning
                          '63'         '10'       More data available
                                   Table 9-25: GET STATUS Warning Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          117



This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
one of the following error conditions.

                         SW1         SW2                           Meaning
                       '6A'        '88'        Referenced data not found
                       '6A'        '80'        Incorrect values in command data
                                 Table 9-26: GET STATUS Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
118                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003




9.5       INSTALL Command

9.5.1      Definition and Scope
The INSTALL command is issued to a Security Domain to initiate or perform the various steps required for Card
Content management.


9.5.2      Command Message
The INSTALL command message shall be coded according to the following table.

                      Code                  Value                              Meaning
               CLA                   '80' or '84'
               INS                   'E6'                    INSTALL
               P1                    'xx'                    Reference control parameter P1
               P2                    '00'                    Reference control parameter P2
               Lc                    'xx'                    Length of data field
               Data                  'xxxx…'                 Install data (and MAC if present)
               Le                    '00'
                                  Table 9-27: INSTALL Command Message

9.5.2.1    Reference Control Parameter P1
The reference control parameter P1 of the INSTALL command is coded according to the following table.

          b8     b7    b6    b5    b4    b3     b2      b1                      Meaning
                        1     0     0     0         0   0    For personalization
                        0     1     0     0         0   0    For extradition
                        0     0     1     X         0   0    For make selectable
                        0     0     X     1         0   0    For install
                        0     0     0     0         1   0    For load
           X     X                                           RFU
                   Table 9-28: INSTALL Command Reference Control Parameter P1
b6 to b1 shall be coded as follows:
b6 = 1 indicates that the currently selected Security Domain shall personalize one of its associated Applications
and a subsequent STORE DATA command is to be expected
b5 = 1 indicates that the Application shall be extradited.
b4 = 1 indicates that the Application shall be made selectable. This applies to an Application being installed or an
Application that is already installed.
b3 = 1 indicates that the Application shall be installed.
b2 = 1 indicates that the Load File shall be loaded. A subsequent LOAD command is to be expected.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          119

A combination of the [for install] and [for make selectable] options may apply.

9.5.2.2     Reference Control Parameter P2
The reference control parameter P2 shall always be set to '00'.

9.5.2.3     Data Field Sent in the Command Message
The data field of the command message contains LV coded data. The LV coded data is represented without
delimiters.

9.5.2.3.1    Data Field for INSTALL [for load]
The following table details the INSTALL [for load] command data field.

                  Presence             Length in Bytes                             Name
              Mandatory              1                          Length of Load File AID
              Mandatory              5-16                       Load File AID
              Mandatory              1                          Length of Security Domain AID
              Conditional            0-16                       Security Domain AID
              Mandatory              1                          Length of Load File Data Block Hash
              Conditional            0-n                        Load File Data Block Hash
              Mandatory              1                          Length of load parameters field
              Conditional            0-n                        Load parameters field
              Mandatory              1                          Length of Load Token
              Conditional            0-n                        Load Token
                            Table 9-29: INSTALL [for load] Command Data Field
The Load File Data Block Hash and Load Token are mandatory for Delegated Management. The Load File Data
Block Hash is mandatory if the Load File contains one or more DAP Blocks. In all other cases, the Load File
Data Block Hash is optional and may be verified by the card.
The Load File AID and the load parameters shall be consistent with the information contained in the Load File
Data Block (if any).




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
120                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003




9.5.2.3.2    Data Field for INSTALL [for install]
The following table details the INSTALL [for install] command data field.

                  Presence             Length in Bytes                             Name
              Mandatory              1                          Length of Executable Load File AID
              Mandatory              5-16                       Executable Load File AID
              Mandatory              1                          Length of Executable Module AID
              Mandatory              5-16                       Executable Module AID
              Mandatory              1                          Length of Application AID
              Mandatory              5-16                       Application AID
              Mandatory              1                          Length of Application Privileges
              Mandatory              1                          Application Privileges
              Mandatory              1                          Length of install parameters field
              Mandatory              2-n                        Install parameters field
              Mandatory              1                          Length of Install Token
              Conditional            0-n                        Install Token
                          Table 9-30: INSTALL [for install] Command Data Field
The Install Token is mandatory for Delegated Management. The Install Token shall not be present if Delegated
Management is not used.
The Executable Module AID is the AID of the Executable Module previously loaded. The Executable Module
shall be present within an Executable Load File.
GlobalPlatform cards use the instance AID to indicate the AID with which the installed Application will be
selected.
The presence of the Application Privileges is required. If an Application is only being installed and not made
selectable with the same INSTALL command the Default Selected privilege cannot be set.
The instance AID, the Application Privileges and the Application Specific Parameters shall be made known to the
Application.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          121




9.5.2.3.3    Data Field for INSTALL [for make selectable]
The following table details the INSTALL [for make selectable] command data field.

                  Presence             Length in Bytes                             Name
              Mandatory              1                          Length = '00'
              Mandatory              1                          Length = '00'
              Mandatory              1                          Length of Application AID
              Mandatory              5-16                       Application AID
              Mandatory              1                          Length of Application Privileges
              Mandatory              1                          Application Privileges
              Mandatory              1                          Length = '00'
              Mandatory              1                          Length of Install Token
              Conditional            0-n                        Install Token
                   Table 9-31: INSTALL [for make selectable] Command Data Field
If the Default Selected privilege is set in the Application Privileges field, the GlobalPlatform Registry shall be
updated according to the rules defined in Section 6.6.2.4 - Application Privileges. Any other privilege set in the
Application Privileges field is ignored by the card.
The Install Token is mandatory for Delegated Management for an INSTALL [for make selectable] command.


9.5.2.3.4    Data Field for INSTALL [for extradition]
The following table details the INSTALL [for extradition] command data field.

                  Presence             Length in Bytes                             Name
              Mandatory              1                          Length of Security Domain AID
              Mandatory              5-16                       Security Domain AID
              Mandatory              1                          Length = '00'
              Mandatory              1                          Length of Application AID
              Mandatory              5-16                       Application AID
              Mandatory              1                          Length = '00'
              Mandatory              1                          Length = '00'
              Mandatory              1                          Length of Extradition Token
              Conditional            0-n                        Extradition Token
                       Table 9-32: INSTALL [for extradition] Command Data Field
The Security Domain AID indicates to which Security Domain this Application is being extradited. The Security
Domain to which this Application is currently associated is the currently selected Application.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
122                             GlobalPlatform Card Specification 2.1.1                                03/25/2003




9.5.2.3.5    Data Field for INSTALL [for personalization]
The following table details the INSTALL [for personalization] command data field.

                  Presence             Length in Bytes                             Name
              Mandatory              1                          Length = '00'
              Mandatory              1                          Length = '00'
              Mandatory              1                          Length of Application AID
              Mandatory              5-16                       Application AID
              Mandatory              1                          Length = '00'
              Mandatory              1                          Length = '00'
              Mandatory              1                          Length = '00'
                      Table 9-33: INSTALL [for personalization] Command Data Field


9.5.2.3.6    INSTALL [for load] and INSTALL [for install] Parameters
The load and install parameters fields are TLV structured values including optional System Specific Parameters
and Application Specific Parameters. While the presence of the System Specific Parameters is optional for both
loading and installation, even if they are present, it is not required that the system take heed of these i.e. their
presence shall be anticipated but the content may be ignored.
The following table identifies the possible tags for use in the load parameters field:

                      Tag          Length                Value (Name)                      Presence
               'EF'                Variable     System Specific Parameters                 Conditional
                         'C6'         2         Non volatile code space limit               Optional
                         'C7'         2         Volatile data space limit                   Optional
                         'C8'         2         Non volatile data space limit               Optional
                                       Table 9-34: Load Parameter Tags
The presence of tags 'C6', 'C7', or 'C8', in the INSTALL [for load] command indicates the minimum size of the
resources that are requested to be available on the card. This indication enables the OPEN to reject the load
request if the remaining card resources are insufficient for either the load or a subsequent installation.
The following table identifies the possible tags for use in the install parameters field:

                      Tag          Length                Value (Name)                      Presence
               'C9'                Variable     Application Specific Parameters            Mandatory
               'EF'                Variable     System Specific Parameters                 Conditional
                         'C7'         2         Volatile data space limit                   Optional
                         'C8'         2         Non volatile data space limit               Optional
                                       Table 9-35: Install Parameter Tags




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          123

When present in the INSTALL [for install] command, the information contained in tag 'C9' (length + data) shall
be passed to the Application being installed. The presence of tags 'C7' or 'C8' in the INSTALL [for install]
command indicates the maximum size of card resources allocated to the Application. This information may be
used by the OPEN to validate the Application's resources requests.


9.5.3      Response Message
A data field shall always be returned in the response message. The content of the data field is only relevant in the
case of Delegated Management i.e. if an INSTALL [for install], INSTALL [for install and make selectable] or
INSTALL [for extradition] command is being issued to a Security Domain with the Delegated Management
privilege, a Receipt may be present in the data field depending on the security policy of the Card Issuer.

9.5.3.1    Data Field Returned in the Response Message
If the Issuer Security Domain processes the INSTALL command, a single byte of '00' shall be returned indicating
that no additional data is present.
If an INSTALL [for load] command, an INSTALL [for make selectable] command alone or an INSTALL [for
personalization] command is being issued to a Security Domain with the Delegated Management privilege, a
single byte of '00' shall also be returned indicating that no additional data is present.
For INSTALL [for install], INSTALL [for install and make selectable] and INSTALL [for extradition] commands
being issued to a Security Domain with the Delegated Management privilege, the data field may contain the
confirmation of the install procedure. The overall length of the response message shall not exceed 256 bytes.
The following table describes the structure of the INSTALL response data field.

                  Presence             Length in Bytes                             Name
              Mandatory              1                          Length of install confirmation
              Conditional            0-n                        Install confirmation (see Section 9.1.7)
                                   Table 9-36: INSTALL Response Data Field

9.5.3.2    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
one of the following error conditions.

                             SW1        SW2                        Meaning
                            '65'       '81'        Memory failure
                            '6A'       '80'        Incorrect parameters in data field
                            '6A'       '84'        Not enough memory space
                            '6A'       '88'        Referenced data not found
                                    Table 9-37: INSTALL Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
124                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003




9.6       LOAD Command

9.6.1      Definition and Scope
This section defines the structure of the Load File transmitted in the LOAD command data field for loading a
Load File. The ICC internal handling or storage of the Load File is beyond the scope of this Specification.
Multiple LOAD commands may be used to transfer a Load File to the card. The Load File is divided into smaller
components for transmission. Each LOAD command shall be numbered starting at '00'. The LOAD command
numbering shall be strictly sequential and increments by one. The card shall be informed of the last block of the
Load File.
After receiving the last block of the Load File, the card shall execute the internal processes necessary for the Load
File and any additional processes identified in the INSTALL [for load] command that preceded the LOAD
commands.


9.6.2      Command Message
The LOAD command message is coded according to the following table.

                   Code                      Value                               Meaning
            CLA                    '80' or '84'
            INS                    'E8'                       LOAD
            P1                     'xx'                       Reference control parameter P1
            P2                     'xx'                       Block number
            Lc                     'xx'                       Length of data field
            Data                   'xxxx..'                   Load data (and MAC if present)
            Le                     '00'
                              Table 9-38: LOAD Command Message Structure
The overall length of the command message shall not exceed 256 bytes.

9.6.2.1    Reference Control Parameter P1
The following table describes the coding of the reference control parameter P1 indicating whether the block
contained in the command message is one in a sequence of blocks or the last block in the sequence.

          b8     b7    b6    b5    b4    b3       b2   b1                       Meaning
          0                                                 More blocks
          1                                                 Last block
                 X     X     X     X     X        X    X    RFU
                      Table 9-39: LOAD Command Reference Control Parameter P1

9.6.2.2    Reference Control Parameter P2 – Block Number
Reference control parameter P2 contains the block number, and shall be coded sequentially from '00' to 'FF'.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          125

9.6.2.3    Data Field Sent in the Command Message
The data field of the command message contains a portion of the Load File.
A complete GlobalPlatform Load File is structured as defined in the following table:

                            Tag          Length                     Value (Name)
                     'E2'                Variable    DAP Block
                                  '4F'   5-16        Security Domain AID
                                  'C3'   Variable    Load File Data Block Signature
                       :                      :                          :
                       :                      :                          :
                     'E2'                Variable    DAP Block
                                  '4F'   5-16        Security Domain AID
                                  'C3'   Variable    Load File Data Block Signature
                     'C4'                Variable    Load File Data Block
                                          Table 9-40: Load File Structure
The data objects defined in Table 9-40 shall be coded according to ASN.1 Basic Encoding Rules.
A DAP Block is optional within a Load File unless the associated Security Domain has the DAP Verification
privilege or a Security Domain with the mandated DAP Verification privilege is present.
A Load File may contain multiple DAP Blocks; each DAP Block being introduced by tag 'E2' and preceding the
Load File Data Block.


9.6.3      Response Message
A data field shall always be returned in the response message. The content of the data field is only relevant in the
case of Delegated Management i.e. if a last LOAD command is being issued to a Security Domain with the
Delegated Management privilege, a Receipt may be present in the data field depending on the security policy of
the Card Issuer.

9.6.3.1    Data Field Returned in the Response Message
If the LOAD command does not contain the last block in the sequence, a single byte of '00' shall be returned
indicating that no additional data is present.
If the Issuer Security Domain processes the LOAD command containing the last block in the sequence, a single
byte of '00' shall be returned indicating that no additional data is present.
For a LOAD command containing the last block in the sequence being issued to a Security Domain with the
Delegated Management privilege, the data field may contain the confirmation of the load procedure. The overall
length of the response message shall not exceed 256 bytes.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
126                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003



The following table describes the structure of the LOAD response data field.

                  Presence             Length in bytes                             Name
              Mandatory              1                          Length of load confirmation
              Conditional            0-n                        Load confirmation (see Section 9.1.7 )
                                    Table 9-41: LOAD Response Data Field

9.6.3.2    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
one of the following error conditions.

                             SW1        SW2                        Meaning
                            '65'       '81'        Memory failure
                            '6A'       '84'        Not enough memory space
                                      Table 9-42: LOAD Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          127




9.7       MANAGE CHANNEL Command

9.7.1      Definition and Scope
The MANAGE CHANNEL command is processed by the OPEN on cards that are aware of logical channels. It is
used to open and close Supplementary Logical Channels. The Basic Logical Channel (channel number zero) can
never be closed.


9.7.2      Command Message
The MANAGE CHANNEL command message shall be coded according to the following table.

                    Code              Value                              Meaning
                     CLA                '00'           ISO/IEC 7816-4 command
                     INS                '70'           MANAGE CHANNEL
                      P1                'xx'           Reference control parameter P1
                      P2                'xx'           Reference control parameter P2
                      Lc                               Not present
                      Le                               '00' if P1 = '00' and not present if P1 = '80'
                           Table 9-43: MANAGE CHANNEL Command Message

9.7.2.1    Reference Control Parameter P1
Reference control parameter P1 is used to indicate whether a Supplementary Logical Channel is being opened or
closed.
The following values of the reference control parameter may apply:
'80' – Close the Supplementary Logical Channel identified in reference control parameter P2.
'00' – Open the next available Supplementary Logical Channel.

9.7.2.2    Reference Control Parameter P2
If a Supplementary Logical Channel is being closed (reference control parameter P1 is '80'), the reference control
parameter P2 identifies the Supplementary Logical Channel to be closed (i.e. '01', '02' or '03').
If a Supplementary Logical Channel is being opened (reference control parameter P1 is '00'), the reference control
parameter P2 indicates that the next available Supplementary Logical Channel is being opened (i.e. '00').

9.7.2.3    Data Field Sent in the Command Message
The data field of the command message is not present.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
128                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

9.7.3       Response Message

9.7.3.1     Data Field Returned in the Response Message
The data field of the response message is only present if a Supplementary Logical Channel is being opened.
Depending on the number of logical channels supported by the card, the following values of the data field of the
response message may apply:
'01', '02' or '03' – Supplementary Logical Channel opened.

9.7.3.2     Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
The command may return the following warning:

                            SW1      SW2                           Meaning
                       '62'         '00'       Logical Channel already closed
                            Table 9-44: MANAGE CHANNEL Warning Conditions
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
one of the following error conditions.

           SW1        SW2                                          Meaning
          '68'       '82'         Secure messaging not supported
          '6A'       '81'         Function not supported e.g. card Life Cycle State is CARD_LOCKED
                              Table 9-45: MANAGE CHANNEL Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          129


9.8       PUT KEY Command

9.8.1      Definition and Scope
The PUT KEY command is used to either:
    x    Replace an existing key with a new key: The new key has the same or a different Key Version Number
          but the same Key Identifier as the key being replaced;
    x    Replace multiple existing keys with new keys: The new keys have the same or a different Key Version
          Number (identical for all new keys) but the same Key Identifiers as the keys being replaced;
    x    Add a single new key: The new key has a different combination Key Identifier / Key Version Number
          than that of the existing keys;
    x    Add multiple new keys: The new keys have different combinations of Key Identifiers / Key Version
          Number (identical to all new keys) than that of the existing keys;
When the key management operation requires multiple PUT KEY commands, chaining of the multiple PUT KEY
commands is recommended to ensure integrity of the operation.
In this version of the Specification the public values of asymmetric keys are presented in clear text.


9.8.2      Command Message
The PUT KEY command message is coded according to the following table:

                  Code              Value                                  Meaning
              CLA             '80' or '84'
              INS             'D8'                  PUT KEY
              P1              'xx'                  Reference control parameter P1
              P2              'xx'                  Reference control parameter P2
              Lc              'xx'                  Length of data field
              Data            'xxxx..'              Key data (and MAC if present)
              Le              '00'
                                  Table 9-46: PUT KEY Command Message
The overall length of the command message shall not exceed 256 bytes.

9.8.2.1    Reference Control Parameter P1
Reference control parameter P1 defines a Key Version Number and whether more PUT KEY commands will
follow this one.
The Key Version Number identifies a key or group of keys that is already present on the card. A value of '00'
indicates that a new key or group of keys is being added. (The new Key Version Number is indicated in the data
field of the command message).
The Key Version Number is coded from '01' to '7F'.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
130                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The reference control parameter P1 of the PUT KEY command message is coded according to the following
table:

           b8     b7     b6      b5     b4      b3      b2      b1                      Meaning
           0                                                           Last (or only) command
           1                                                           More PUT KEY commands
                 *     *       *       *       *       *       *       Key Version Number
                           Table 9-47: PUT KEY Reference Control Parameter P1

9.8.2.2        Reference Control Parameter P2
Reference control parameter P2 defines a Key Identifier and whether one or multiple keys are contained in the
data field.
When one key is contained in the command message data field, reference control parameter P2 indicates the Key
Identifier of this key. When multiple keys are contained in the command message data field, reference control
parameter P2 indicates the Key Identifier of the first key in the command data field. Each subsequent key in the
command message data field has an implicit Key Identifier that is sequentially incremented by one, starting from
this first Key Identifier.
The Key Identifier is coded from '00' to '7F'.
The reference control parameter P2 of the PUT KEY command message is coded according to the following
table:

           b8     b7     b6      b5     b4      b3      b2      b1                      Meaning
       0                                                               Single key
       1                                                               Multiple keys
                 *     *       *       *       *       *       *       Key Identifier
                           Table 9-48: PUT KEY Reference Control Parameter P2

9.8.2.3        Data Field Sent in the Command Message


9.8.2.3.1       Format 1
The command message data field contains a new Key Version Number (coded from '01' to '7F') followed by one
or multiple key data fields as represented in the following diagram (with optionally a second and third keys):

                        New version number

                                           key data field (implicit key id P2+0)

                                           key data field (implicit key id P2+1)

                                           key data field (implicit key id P2+2)


                                   Table 9-49: Key Version Number Diagram




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          131

The new Key Version Number defines either:
    x   The version number of a new key or group of keys to be created on the card (Key Version Number
         indicated in P1 is set to zero); or
    x   The version number of a new key or group of keys that will replace an existing key or group of keys
         (Key Version Number indicated in P1 is different from zero).
If the data field contains multiple keys, the keys all share the same Key Version Number and the sequence in the
command data field reflects the incremental sequence of the Key Identifiers.
The key data field is structured according to the following table:

                                  Length                          Meaning
                              1                   Key type
                              1                   Length of key or key component
                              Variable: 1-n       Key or key component data value
                              1                   Length of key check value
                              Variable: 0-n       Key check value (if present)
                                            Table 9-50: Key Data Field


9.8.2.3.2    Format 2
Reserved for Future Use


9.8.2.3.3    Processing rules
When replacing keys, the new keys shall be presented to the card in the same format as they are already present
on the card: in other words, it is not possible to change the size and the associated cryptographic algorithm of an
existing key slot.
When using this command to load or replace secret or private keys, the key values shall be encrypted and the
reference of the encrypting key and algorithm to be used is known implicitly according to the current context.
Public key values may be presented in clear text.
When chaining is used to load or replace a key comprised of more than one component, the subsequent
commands must refer to the same Key Identifier and the same Key Version Number as the first PUT KEY
command used for the first key component. A key component shall not be split across two PUT KEY commands.
If the data field contains multiple keys or key components, the card must handle the multiple keys or key
components in an atomic manner. When PUT KEY commands are chained (i.e. bit b8 of P1 set to 1), the card
must handle the multiple key components transferred in the chain of PUT KEY commands (until and including
the first PUT KEY command with bit 8 of P1 = 0) in an atomic manner.
The PUT KEY command creates or updates the Key Information Data structured as in Table 9-18 and contained
in the tag 'C0'.
The modulus component of a RSA key should be the first key component.
It is the responsibility of the receiving on-card entity to verify the key check value when present.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
132                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

9.8.3       Response Message

9.8.3.1     Data Field Returned in the Response Message


9.8.3.1.1    Format 1
The data field of the response message contains in clear text the Key Version Number followed by the key check
value(s) not preceded by a length, if any, as presented in the command message data field. The personalization
server may use the returned Key Version Number and key check value(s) to verify the correct loading of the
key(s).


9.8.3.1.2    Format 2
Reserved for Future Use

9.8.3.2     Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
one of the following error conditions.

                  SW1                SW2                                Meaning
              '65'            '81'            Memory failure
              '6A'            '84'            Not enough memory space
              '6A'            '88'            Referenced data not found
              '94'            '84'            Algorithm not supported
              '94'            '85'            Invalid key check value
                                      Table 9-51: PUT KEY Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          133




9.9       SELECT Command

9.9.1      Definition and Scope
The SELECT command is used for selecting an Application. The OPEN only processes SELECT commands
indicating the SELECT [by name] option. All other options shall be passed to the selected Application.


9.9.2      Command Message
The SELECT command is coded according to the following table:

                   Code                       Value                              Meaning
            CLA                    '00'                       ISO/IEC 7816-4 command
            INS                    'A4'                       SELECT
            P1                     'xx'                       Reference control parameter P1
            P2                     'xx'                       Reference control parameter P2
            Lc                     'xx'                       Length of AID
            Data                   'xxxx..'                   AID of Application to be selected
            Le                     '00'
                                   Table 9-52: SELECT Command Message

9.9.2.1    Reference Control Parameter P1
Reference control parameter P1 shall be coded according to the following table.

          b8     b7    b6    b5    b4    b3     b2    b1                        Meaning
                                         1                  Select by name
                            Table 9-53: SELECT Reference Control Parameter P1

9.9.2.2    Reference Control Parameter P2
Reference control parameter P2 shall be coded according to the following table.

          b8     b7    b6    b5    b4    b3     b2    b1                        Meaning
                                                0     0     First or only occurrence
                                                1     0     Next occurrence
                            Table 9-54: SELECT Reference Control Parameter P2

9.9.2.3    Data Field Sent in the Command Message
The data field of the command shall contain the AID of the Application to be selected. The Lc and data field of
the SELECT command may be omitted if the Issuer Security Domain is being selected. In this case, Le shall be
set to '00' and the command is a case 2 command according to ISO/IEC 7816-4.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
134                            GlobalPlatform Card Specification 2.1.1                                 03/25/2003

9.9.3      Response Message

9.9.3.1    Data Field Returned in the Response Message
The SELECT response data field consists of information specific to the selected Application.
The coding of the File Control Information for the Issuer Security Domain and Security Domains shall be
according to the following table.

                   Tag                                Description                               Presence
            '6F'                 File Control Information (FCI template)                      Mandatory
                    '84'         Application / file AID                                       Mandatory
                   'A5'          Proprietary data                                             Mandatory
                       '73'      Security Domain Management Data (see Appendix
                                                                                              Optional
                                 F for detailed coding)
                      '9F6E'     Application production life cycle data                       Optional
                      '9F65'     Maximum length of data field in command message              Mandatory
                                       Table 9-55: File Control Information

9.9.3.2    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
The command may return the following warning condition when the Issuer Security Domain is being selected.

                     SW1         SW2                               Meaning
                    '62'       '83'        Card Life Cycle State is CARD_LOCKED
                                      Table 9-56: SELECT Warning Condition
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
one of the following error conditions.

          SW1        SW2                                           Meaning
        '68'        '82'       Secure messaging not supported
        '6A'        '81'       Function not supported e.g. card Life Cycle State is CARD_LOCKED
        '6A'        '82'       Selected Application / file not found
                                      Table 9-57: SELECT Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          135


9.10 SET STATUS Command

9.10.1 Definition and Scope
The SET STATUS command shall be used to modify the card Life Cycle State or the Application Life Cycle
State.


9.10.2 Command Message
The SET STATUS command message is coded according to the following table.

                     Code                   Value                              Meaning
              CLA                    '80' or '84'
              INS                    'F0'                    SET STATUS
              P1                     'xx'                    Status type
              P2                     'xx'                    State control
              Lc                     'xx'                    Length of data field
              Data                   'xxxxx…'                AID of Application (and MAC if present)
              Le                                             Not present
                                Table 9-58: SET STATUS Command Message

9.10.2.1 Reference Control Parameter P1 - Status Type
The status type of the SET STATUS command message indicates if the change in the Life Cycle State applies to
the Issuer Security Domain or an Application. Security Domains other than the Issuer Security Domain are
considered as Applications in this context. The status type shall be coded according to the following table.

 b8     b7      b6     b5      b4     b3     b2      b1                              Meaning
1       0                                                  Indicate Issuer Security Domain
0       1                                                  Indicate Application
               X       X      X      X       X      X      RFU
                                    Table 9-59: SET STATUS – Status Type

9.10.2.2 Reference Control Parameter P2 - State Control
The state control of the SET STATUS command message indicates the state transition required and shall be
coded according to Section 9.1.1 - Life Cycle Status Coding.
For transitions to a higher Life Cycle State, only the bit indicating the Life Cycle State to which the Issuer
Security Domain or the Application shall transition shall be set.
For the Issuer Security Domain (card), the parameter shall be coded according to Table 9-6 and abide by the
transitioning rules as diagrammed in Figure 5-1.
For a Security Domain setting its own Life Cycle State using this command, the only possible transition is to the
PERSONALIZED state: The parameter shall be coded according to Table 9-5.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
136                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

For an Application setting its own Life Cycle State using this command, the parameter shall be coded according
to Table 9-4 and abide by the transitioning rules as diagramed in Figure 5-2.
For the Card Issuer setting the Life Cycle State of an Application or Security Domain, the only possible
transitions are to the LOCKED state and subsequently back to the previous state. The only relevant bit of this
parameter would therefore be bit 8 (all other bits are ignored):
x    b8 = 1 indicates a transition to the LOCKED state
x    b8 = 0 indicates a transition (from LOCKED) back to the previous state.
A request to transition the Issuer Security Domain, a Security Domain, or an Application to its current Life Cycle
State shall be rejected.

9.10.2.3 Data Field Sent in the Command Message
The data field shall contain the AID of the Application. If reference control parameter P1 is '80' the content of the
command data field shall be ignored.


9.10.3 Response Message

9.10.3.1 Data Field Returned in the Response Message
The data field of the response message shall not be present.

9.10.3.2 Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
one of the following error conditions.

                             SW1        SW2                        Meaning
                           '6A'        '80'        Incorrect values in command data
                           '6A'        '88'        Referenced data not found
                                  Table 9-60: SET STATUS Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          137


9.11 STORE DATA Command

9.11.1 Definition and Scope
The STORE DATA command is used to transfer data to an Application or the Security Domain processing the
command.
The Issuer Security Domain or Security Domain determines if the command is intended for itself or an
Application depending on a previously received command. If a preceding command was an INSTALL [for
personalize] command, the STORE DATA command is destined for an Application.
Multiple STORE DATA commands transfer data to the Application or Security Domain by breaking the data into
smaller components for transmission. Each STORE DATA command is numbered starting at '00'. The STORE
DATA command numbering shall be strictly sequential and increments by one. The Security Domain shall be
informed of the last block.


9.11.2 Command Message
The STORE DATA command message shall be coded according to the following table.

                      Code                      Value                          Meaning
               CLA                      '80' or '84'
               INS                      'E2'                  STORE DATA
               P1                       'xx'                  Reference control parameter P1
               P2                       'xx'                  Block number
               Lc                       'xx'                  Length of data field
               Data                     'xxxxx…'              Application data and MAC (if present)
               Le                                             Not present
                               Table 9-61: STORE DATA Command Message
The overall length of the command message shall not exceed 256 bytes.

9.11.2.1 Reference Control Parameter P1
Reference control parameter P1 shall be coded according to the following table.

          b8     b7    b6    b5    b4      b3    b2     b1                       Meaning
           0                                                 More blocks
           1                                                 Last block
                 X     X      X     X      X      X     X    RFU
                       Table 9-62: STORE DATA Reference Control Parameter P1

9.11.2.2 Reference Control Parameter P2 - Block number
Reference control parameter P2 shall contain the block number coded sequentially from '00' to 'FF'. The Security
Domain shall check the sequence of commands.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
138                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

9.11.2.3 Data Field Sent in the Command Message
The data field shall contain data in a format expected by the Security Domain or the Application. If the data is
intended for an Application, this data, except the MAC (if present), shall be transparent to the Security Domain.
The Issuer Security Domain shall support at least the following TLV coded data objects:
      x   Issuer Identification Number (tag '42')
      x   Card Image Number (tag '45')

      x Issuer Security Domain AID (tag '4F')
      x   Card Data (tag '66')


9.11.3 Response Message

9.11.3.1 Data Field Returned in the Response Message
The data field of the response message shall not be present.

9.11.3.2 Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
the following error condition.

                             SW1         SW2                       Meaning
                           '6A'        '80'       Incorrect values in command data
                                  Table 9-63: STORE DATA Error Condition




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          139




                                            Appendices




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
140                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003


A. GlobalPlatform API
This section contains both the API required for backwards compatibility with Open Platform 2.0.1’ Java Cards as
well as GlobalPlatform 2.1 Java Cards. Over time the Open Platform 2.0.1’ API will be deprecated but in the
short term, implementations intended to support Applications coded to this previous API shall contain both the
old API as well as the new API.
The following is a list of changes between the Open Platform 2.0.1’ API and the GlobalPlatform 2.1 API:
The package naming has changed.
   x    The CVM methods have been expanded and moved into an optional interface.
   x    The management of Secure Channels has been modified in an attempt to make it more generic and
         support multiple Secure Channel Protocols.
   x    A new sharable interface has been added in order to support Security Domains ability to pre-process data
         on behalf of an Application.
The deprecated API and new API both access the same objects where applicable. While this may seem obvious
for methods that have the same name across both classes (e.g. setATRHistBytes(),
setCardContentState() and getCardContentState()) it shall also be noted as for example that an
application that uses the update() method in the new API to change the value of the global PIN will affect the
same global PIN of an application that uses the setPIN() method in the deprecated API to verify the global
PIN.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                     GlobalPlatform Card Specification 2.1.1                                         141




A.1 Deprecated Open Platform Java Card API


Open Platform Specific


Open Platform and the definition of the Card Manager integrate with the standard Java Card™ 2.1 specifications
with the following minor exceptions.
Installation
The Java Card JCRE specification defines the parameters for the Applet.install() method to identify the following
information:
x    the Application Specific Parameters.
The Open Platform requires the parameters for the Applet.install() method to identify the following information:

x    the instance AID;
x    the Application Privileges; and,
x    the Application Specific Parameters.

This requirement does not require a change to the API but rather to the Runtime Environment (in this case the
Card Manager) and the expectation of an Open Platform Application.

The install() method parameter fields identify the above information retrieved from the INSTALL (for install)
command in the following format:

x    a buffer containing the following consecutive LV coded data;
      x   length of the instance AID;
      x   the instance AID;

      x   length of the Application Privileges;
      x   the Application Privileges;
      x   length of Application Specific Parameters; and

      x   the Application Specific Parameters.
 x    an offset within the buffer pointing to the length of the instance AID; and
 x    a length indicating the total length of the above data.
The application is required to utilize the instance AID as a parameter when invoking the Java Card register( byte[]
bArray, short bOffset, byte bLength) method.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
142                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

Selection
Open Platform does not require the Applet.select() method to return any other value but true. In addition if the
select() method does fail, an ‘6999’ response code is not expected from an Open Platform card and there should
not be a scenario that causes no application to be selected (i.e. if no other application can be selected, the Card
Manager is the selected application).

Cryptographic Algorithm
Open Platform cards supporting RSA cryptography require support for an additional algorithm not defined in the
Java Card™ API specification. This additional algorithm will fulfill the requirement identified in section Error!
Reference source not found. ‘Cryptographic support’.
The RSA_NO_PAD algorithm is required in the javacardx.crypto.cipher class.



Application Programmer Interface
The following package details an example of the API required for an Open Platform 2.0.1’ card or a
GlobalPlatform 2.1 card that intends to be backwards compatible with Open Platform 2.0.1’ Applications.


Invocation of Open Platform methods
Some Open Platform methods require the application invoking the method to be the selected application at the
time the method is invoked. These are primarily the methods that require the Card Manager to locate the invoking
application’s entry in the registry.

This restriction applies directly to the install() method of the application which is restricted in the Open Platform
methods it can invoke.

The following is a list of methods that can be invoked from the install() method:
x    getTriesRemaining;
x    getCardManagerState; and

x    verifyPin.
All other Open Platform methods can only be invoked when the application is the selected application. This of
course also relates to all Security Domain methods which, while in themselves, do not require the location of the
application’s entry in the registry, do need to be preceded by the getSecurityDomain() method.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          143


Package Index
Other Packages
·     package openplatform




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
144                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003


package openplatform
      Interface Index
·     ProviderSecurityDomain

      Class Index
·     OPSystem




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          145


Class Hierarchy
class java.lang.Object
·     class openplatform.OPSystem
·     interface openplatform.ProviderSecurityDomain




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
  146                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

  Interface openplatform.ProviderSecurityDomain

  public abstract interface ProviderSecurityDomain


  This defines the interface of a privileged system class that represents an Application Provider on a card. The class
  implementing this interface shall be declared a Shareable Interface Object (see the JCRE document in Java
  Card™ 2.1). This class offers cryptographic services, key management services, runtime messaging support, and
  secure loading services to applets from the same Application Provider. Prior to using this interface, an
  Application is required to obtain a handle to it's associated Security Domain by invoking the
  OPSystem.getSecurityDomain() method.



                                               Method Summary
Void                           closeSecureChannel(byte channel)
                               This method is used to close a Secure Channel.
Boolean                        decryptVerifyKey (byte channel, APDU apdu, short offset)
                               This method is used to decrypt and verify a new key.
Byte                           openSecureChannel (APDU apdu)
                               This method opens a Secure Channel.
Void                           unwrap (byte channel, APDU apdu) This method is used to process an APDU
                               buffer received within a Secure Channel.
Void                           verifyExternalAuthenticate (byte channel, APDU apdu)
                               This method is used to authenticate an off-card entity.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          147



 Method Detail




closeSecureChannel
public void closeSecureChannel(byte channel)


This method is used to close the Secure Channel that was previously opened with the openSecureChannel()
method specifically to erase any secure information relating to the Secure Channel.


Parameters:
channel - byte




decryptVerifyKey
public boolean decryptVerifyKey(byte channel,
                                      APDU apdu,
                                      short offset)


This method is used to decrypt and verify a key received by the Application within a Secure Channel.


Parameters:
channel - byte Secure Channel number
apdu – APDU The APDU handle
offset - short Offset within the APDU buffer where the key set data field can be retrieved.


Returns:
TRUE if a key has been verified, FALSE otherwise.




openSecureChannel
public byte openSecureChannel(APDU apdu)




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
148                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003



This method opens a Secure Channel for an Application and returns the newly opened channel number. The
supplied APDU shall contain the command used to retrieve data from the card that will be used by the off-card
entity to authenticate the card.
This method prepares the response to this command within the APDU. The Security Domain that the applet
belongs to is responsible for the channel number allocation.


Parameters:
apdu - APDU


Returns:
channel number




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          149




unwrap

public void unwrap(byte channel,
                     APDU apdu)


This method is used to process the APDU content after receiving it from an off-card entity and within a Secure
Channel. The processing is according to the requirements for integrity and confidentiality that are established
when a Secure Channel is opened. The resultant APDU contains the command as if it where received outside of a
Secure Channel.


Parameters:
channel - byte
apdu - APDU




verifyExternalAuthenticate


public void verifyExternalAuthenticate(byte channel,
                                           APDU apdu)


This method is used to authenticate the off-card entity by verifying the contents of the APDU command.


Parameters:
channel - byte
apdu - APDU




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
  150                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003


  Class openplatform.OPSystem
  java.lang.Object
    |
    +---- openplatform.OPSystem


  public final class OPSystem


  extends Object


  The OPSystem class exposes a subset of the behavior of the Card Manager to the outside world. It extends the
  functionality of the JCRE 2.1 API by providing card management services to Applications. It implements and
  enforces a Card Issuer's security policies. This class provides the functionality of a runtime environment running
  at the JCRE 'system' (privileged) context. The details of the JCRE 'system' context implementation are left to the
  implementer. This class's public interface is composed of static methods visible to all applets importing the Open
  Platform package. This is a 'singleton' class (only one instance is created for the lifetime of the card).

                                                Field Summary
Static byte          APPLET_BLOCKED
                     Application Life Cycle State indicating the Application is BLOCKED = 0x7F
Static byte          APPLET_PERSONALIZED
                     Application Life Cycle State indicating the Application is PERSONALIZED = 0x0F
Static byte          APPLET_SELECTABLE
                     Application Life Cycle State indicating the Application is SELECTABLE = 0x03
Static byte          CARD_INITIALIZED
                     Card Manager Life Cycle State indicating the Card Manager is INITIALIZED = 0x07
Static byte          CARD_SECURED
                     Card Manager Life Cycle State indicating the Card Manager is SECURED = 0x0F
Static byte          CARD_LOCKED
                     Card Manager Life Cycle State indicating the Card Manager is CARD_LOCKED =
                     0x7F
Static byte          CARD_OP_READY
                     Card Manager Life Cycle State indicating the Card Manager is OP_READY = 0x01




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
  03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          151



                                               Method Summary
Static byte                  getCardContentState()
                             This method returns the Life Cycle State of the selected Application.
Static byte                  getCardManagerState()
                             This method returns the Life Cycle State of the Card Manager.
Static                       getSecurityDomain()
ProviderSecurityDomain       This method returns a handle to the Application's associated Security Domain.
Static byte                  getTriesRemaining()
                             This method returns the PIN tries remaining for the CVM.
Static boolean               lockCardManager()
                             This method allows an applet to lock the card.
Static boolean               setATRHistBytes (byte [] buffer, short bOffset, byte bLength)
                             This method sets the historical bytes contained in the ATR
                             (Answer To Reset).
Static boolean               setCardContentState(byte state)
                             This method allows an Application to change its own life cycle
                             state.
Static boolean               setPin(APDU apdu, short offset)
                             This method is used to initialize the CVM
Static Boolean               terminateCardManager()
                             This method allows an Application to terminate the card.
Static boolean               verifyPin(APDU apdu, short offset)
                             This method allows an Application to check the validity of a
                             PIN.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
152                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003



Field Detail

APPLET_SELECTABLE

public static final byte APPLET_SELECTABLE


The applet has reached the Life Cycle State of SELECTABLE and is available to receive SELECT commands
from outside the card.


APPLET_SELECTABLE = 0x07



APPLET_PERSONALIZED

public static final byte APPLET_PERSONALIZED


The applet has been loaded with Application specific data and has transitioned itself to the Life Cycle State of
PERSONALIZED.


APPLET_PERSONALIZED = 0x0F



APPLET_BLOCKED

public static final byte APPLET_BLOCKED


The Application, due to some off-card or internal event, has transitioned itself to the Life Cycle State of
BLOCKED.


APPLET_BLOCKED = 0x7F




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          153

CARD_OP_READY

public static final byte CARD_OP_READY


The card is in the Open Platform state of OP_READY.


CARD_OP_READY = 0x01



CARD_INITIALIZED

public static final byte CARD_INITIALIZED


The Card Manager is in the Life Cycle State of INITIALIZED.


INITIALIZED = 0x07



CARD_SECURED

public static final byte CARD_SECURED


The Card Manager is in the Life Cycle State of SECURED.


CARD_SECURED = 0x0F



CARD_LOCKED

public static final byte CARD_LOCKED


The Card Manager has transition to the Life Cycle State of CARD_LOCKED.


CARD_LOCKED = 0x7F




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
154                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

Method Detail

getCardContentState

public static byte getCardContentState()


This method returns the Life Cycle State of the selected Application. The Card Manager locates the AID of the
selected Application in the GlobalPlatform Registry and returns the Life Cycle State.


Returns:
Life cycle state


See Also:
APPLET_SELECTABLE, APPLET_PERSONALIZED,
APPLET_BLOCKED



getCardManagerState

public static byte getCardManagerState()


This method returns the current Life Cycle State for the Card Manager.


Returns:
Life cycle state


See Also:
CARD_OP_READY, CARD_INITIALIZED, CARD_ SECURED,
CARD_LOCKED




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          155



getSecurityDomain

public static ProviderSecurityDomain getSecurityDomain()


This method returns the handle of the Application's associated Security Domain. The Card Manager locates the
AID of the selected Application in the GlobalPlatform Registry and determines the Application's associated
Security Domain.


Returns:
ProviderSecurityDomain



getTriesRemaining

byte public static getTriesRemaining()


This method returns the PIN tries remaining for the CVM.


Returns:
PIN tries remaining.



lockCardManager

public static boolean lockCardManager()


This method allows an applet to lock the card. If the calling applet has been authorized to perform this operation
and the operation is successful, this method returns TRUE. The Card Manager locates the AID of the selected
Application in the GlobalPlatform Registry and determines if the Application has the required privilege.


Returns:
TRUE if Card Manager locked, FALSE otherwise




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
156                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

setATRHistBytes

public static boolean setATRHistBytes (byte[] buffer,
                                            short bOffset,
                                                byte bLength)


This method sets the historical bytes contained in the ATR (Answer To Reset). The sequence of bytes will be set
on a subsequent power-up or reset. Only the “default selected” Application may invoke this method. The Card
Manager locates the AID of the selected Application in the GlobalPlatform Registry and determines if the
Application has the required privilege.


Parameters:


buffer – byte[] Array containing the ATR historical bytes.


bOffset – short Offset within the buffer where ATR historical bytes begin.


bLength – byte Length of the ATR historical bytes in the buffer.


Returns:
TRUE if ATR bytes set, FALSE otherwise.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                     GlobalPlatform Card Specification 2.1.1                                         157

setCardContentState

public static boolean setCardContentState(byte state)


This is used by an Application to transition its own Life Cycle State. The Card Manager locates the AID of the
selected Application in the GlobalPlatform Registry and changes the Application's Life Cycle State. The Card
Manager is not responsible for enforcing any Application specific Life Cycle State transition rules.


Parameters:
state – transition to this state.


Returns:
TRUE if the operation is successful, FALSE otherwise


See Also:
APPLET_SELECTABLE, APPLET_PERSONALIZED,
APPLET_BLOCKED




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
158                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

setPin

public static boolean setPin(APDU apdu,
                                     short pOffset)


This method is used to change the value of the CVM. The length of the PIN is retrieved from the PIN structure.
The Card Manager locates the AID of the selected Application in the GlobalPlatform Registry and determines if
the Application has the required privilege. If the PIN is changed, the PIN try counter shall be reset.


Parameters:
apdu - APDU
pOffset – identifies the location of starting byte of a structure containing the
PIN information.


Returns:
TRUE if the PIN value was changed, FALSE otherwise.




terminateCardManager

public static boolean terminateCardManager()


This method allows an applet to terminate the card. If the calling applet has been authorized to perform this
operation and the operation is successful, this method does not return to the calling Application. The Card
Manager locates the AID of the selected Application in the GlobalPlatform Registry and determines if the
Application has the required privilege.


Returns:
FALSE if the operation was not performed.



verifyPin

public static boolean verifyPin(APDU apdu,




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          159

                                       short pOffset)


This method allows an Application to request the Card Manager to compare a PIN block with the CVM. If the
comparison is successful, the retry counter shall be reset. If the comparison is unsuccessful, the retry counter shall
be updated.


Parameters:
apdu - APDU
offset – identifies the location of starting byte of a structure containing the
PIN information.


Returns:
TRUE if the comparison was successful, FALSE otherwise.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
    160                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003




    A.2 GlobalPlatform on a Java Card
    GlobalPlatform Specific Requirements
    In order to ensure the highest level of interoperability of GlobalPlatform implementations, GlobalPlatform also
    adopts the order defined in Section 6.2 - Installation of the Java Card™ 2.1.1 Virtual Machine Specification and
    Java Card™ 2.2 Virtual Machine Specification.
    The following minor modifications to the standard functionality defined in the Java Card™ 2.1.1 Runtime
    Environment (JCRE) Specifications and the Java Card™ 2.1.1 Application Programming Interface exist in a
    GlobalPlatform implementation. Some of these issues are no longer relevant if complying with the Java Card™
    2.2 specifications.

    GlobalPlatform package AID
    Each GlobalPlatform package AID will be a concatenation of a RID and a PIX. The AID value of the Java Card
    Export File for the new GlobalPlatform API (identical for both GlobalPlatform 2.1 and 2.1.1) based on the RID
    specified in Appendix F - GlobalPlatform Data Values and Card Recognition Data is 'A00000015100'.

    Installation
    In Section 3.1 - The Method install of the Java Card™ 2.1.1 Runtime Environment (JCRE) Specifications,
    the parameters passed to the method are defined to be initialization parameters from the contents of the incoming
    byte array parameter.
    In the definition of the install method of the Class Applet of the Java Card™ 2.1.1 Application Programming
    Interface, the install parameters to be supplied must be in the format defined by the applet.
    This specification expands on this requirement and further defines the content of the install parameters. This
    expansion affects both the implementation of an OPEN and the behavior of a Java Card applet developed for a
    GlobalPlatform card. It does not affect the definition of the install method of the Class Applet of the Java
    Card™ 2.1.1 Application Programming Interface specification.
    The install parameters shall identify the following data, present in the INSTALL [for install] command (see
    Section 9.5.2.3.2 - Data Field for INSTALL [for install]):

    ·     The instance AID,

    ·     The Application Privileges and,

    ·     The Application Specific Parameters1.


    The OPEN is responsible for ensuring that the parameters (bArray, bOffset and bLength) contain the
    following information:


1
 While the APDU command contains install parameters representing TLV coded system and application specific parameters, the
application only requires knowledge of the Application Specific Parameters i.e. only LV of the TLV coded structure ‘C9’ are
present as parameters.




    Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
    The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
    information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
    prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          161

The array, bArray, shall contain the following consecutive LV coded data:

·     Length of the instance AID,

·     The instance AID,

·     Length of the Application Privileges,

·     The Application Privileges,

·     Length of the Application Specific Parameters and,

·     The Application Specific Parameters.

The byte, bOffset, shall contain an offset within the array pointing to the length of the instance AID.
The byte, bLength, shall contain a length indicating the total length of the above-defined data in the array.
The applet is required to utilize the instance AID as a parameter when invoking the register (byte []
bArray, short bOffset, byte bLength) method of the Class Applet of the Java Card™ 2.1.1
Application Programming Interface specification.

T=0 Transmission Protocol
GlobalPlatform cards are intended to be functional in the widest range of environments (i.e. Card Acceptance
Devices). Currently the Java Card™ 2.1.1 Runtime Environment (JCRE) Specifications and the Java Card™ 2.2
Runtime Environment (JCRE) Specifications describe the behavior for case 2 commands (when using the T=0
protocol) in contradiction to EMV 2000. GlobalPlatform mandates that the JCRE shall handle this case of
command in accordance with ISO/IEC 7816: An applet receiving a case 2 command builds the response and
invokes the appropriate API to output the data. If the data is less than the data expected by the terminal, the
OPEN will store the data and output a 6Cxx response code and wait for the CAD to re-issue the command with
the correct length. When the re-issued command is received the JCRE will manage the outputting of the stored
data.

Atomicity
Unless otherwise specified all internal persistent objects of the GlobalPlatform API must conform to a transaction
in progress.
All operations performed by this API, except the Application.processData() method shall be executed
atomically. Objects used to enforce the implementation of velocity checking shall not conform to a transaction in
progress.

Logical channels
The following logical channel restrictions apply to Java Card™ 2.2 (see the Java Card™ 2.1.1 Runtime
Environment (JCRE) Specifications for more detail):
Selection of an Application on a logical channel as defined in Section 6.3 - Command Dispatch will be
unsuccessful if this same Application, or any other Application instantiated from code in the same package from
which the Application being selected was instantiated, is currently selected on another logical channel but the
application code does not implement the MultiSelectable interface.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
162                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

Changing context from a Security Domain to an Application as defined in Section 7.3 - Personalization Support
will be unsuccessful if this same Application, or any other Application instantiated from code in the same
package from which the Application being personalized was instantiated, is currently selected on another logical
channel but the application code does not implement the MultiSelectable interface.
An Application that has the Default Selected privilege and is intended for a card that supports Supplementary
Logical Channels should implement the MultiSelectable interface.
GlobalPlatform only defines the assignment of logical channel numbers by the card. Optionally and as defined in
Java Card 2.2, a card may also support assignment of logical channel numbers by the terminal.

Cryptographic Algorithms
GlobalPlatform cards supporting RSA cryptography shall support key sizes not defined as constants in the Key
Builder class. More specifically support for key sizes being a multiple of 4 bytes (32 bits), and being within the
allowed key lengths defined by the implementation, shall be available.

Level of trust
The Java Card 2.1.1 specifications assume that the RID of the AID of packages, applets and instances will be
utilized to ensure a level of trust between these entities. In Section 4.2.2 - AID Usage of the Java Card™ 2.1.1
Application Programming Interface it is defined that the RID of an AID of a component must match the RID of
the AID of the package and in the definition of the register (byte [] bArray, short bOffset,
byte bLength) method of the Java Card™ 2.1.1 Application Programming Interface specification it is
defined that an exception must be thrown if the RID portion of the AID bytes in the bArray parameter does not
match the RID portion of the Java Card name of the applet.
From a real world implementation point of view, mandating that the RID of the instance AID must be the same as
the RID of the component from which it was instantiated, is not practical. GlobalPlatform implementations shall
not mandate that there be any link through the AID of an instance to its original package. It does however assume
that all applications in the same package have a level of trust.

Invocation of GlobalPlatform methods
The Application Programming Interface defined herein is accessible to any Java Card applet developed with the
intention of being present on a GlobalPlatform card. One limitation does exist relating to the constructor of the
applet and to the install() method of the Class Applet of the Java Card™ 2.1.1 Application Programming
Interface and the Java Card™ 2.2 Application Programming Interface. As this specification does not define
exactly when the instance of an applet becomes an entry in the card’s GlobalPlatform Registry, an applet
developer can only assume that this has occurred following the successful completion of the install method. To
ensure interoperability, GlobalPlatform API methods that require access to the GlobalPlatform Registry entry of
the applet invoking the method, shall not be invoked from within the constructor or install() method.
The following is a list of methods that may be invoked from within the constructor or the install() method:

·     getCardState, and

      getCVM.
The required behavior of the card in the event that an Application incorrectly invokes a method of the
org.globalplatform.GPSystem class other than those listed above is undefined. For example, an exception may be
thrown and the processing of the install() method may be aborted.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          163

Class Hierarchy
 x   class java.lang.Object

           o    interface org.globalplatform.Application

           o    interface org.globalplatform.SecureChannel

           o    class org.globalplatform.GPSystem

           o    interface org.globalplatform.CVM




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
 164                             GlobalPlatform Card Specification 2.1.1                                03/25/2003

 org.globalplatform
 Interface Application


 public interface Application extends javacard.framework.Shareable
 This defines the interface that represents an applet method accessible through the OPEN to the Application's
 associated Security Domain. This interface must be implemented by the Applet class that will use the additional
 functionality that allows a Security Domain to pass data to the applet.



 Method Summary
  void        processData(byte[] baBuffer, short sOffset, short sLength)
                   This method processes Application specific data received from another entity on the card.




 Method Detail
processData
public void processData(byte[] baBuffer,
                           short sOffset,
                           short sLength)

         This method processes Application specific data received from another entity on the card. If this other
         entity is the Application's associated Security Domain, this data is the APDU buffer.
         Notes:
         x     During the invocation the Java Card VM performs a context switch.
         x     The applet is responsible for managing the atomicity of its own data.
         x     As this method can be invoked by a Security Domain immaterial of the Application Life Cycle State, it
                is the responsibility of the applet to ensure that its current Life Cycle State is valid for this operation.
         x     As the applet is not the selected Application, it should not use the CLEAR_ON_DESELECT when
                creating transient arrays.
         Parameters:
                baBuffer - the source byte array containing the data expected by the applet. This buffer must be
                global.
                sOffset - starting offset within source byte array.
                sLength - length of data.
         Throws:
                   exceptions thrown are Application specific.




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          165



org.globalplatform
Interface SecureChannel

public interface SecureChannel extends javacard.framework.Shareable
This class defines an interface to be used by an Application that may want to delegate the handling of entity
authentication and APDU security to its associated Security Domain. This interface is designed to offer
interoperability to the Application in that it requires no knowledge of the mechanisms used to perform the
authentication or of the scheme used for APDU security and shall allow an Application to interface correctly with
a Security Domain immaterial of the mechanisms or schemes used. Prior to using this interface, an Application is
required to obtain a handle to its associated Security Domain by invoking the
GPSystem.getSecureChannel() method. The SecureChannel Interface shall only be exposed through
the GPSystem.getSecureChannel() method.
In all cases where the Application passes the APDU buffer as a parameter to the Security Domain, the class byte
of the APDU shall not be modified. This ensures that the Security Domain knows the logical channel number. If
the card supports logical channels, it is the responsibility of the Security Domain to correctly manage the logical
channel information when processing the APDU.
The byte value returned by the getSecurityLevel() method is a bit map indicating whether entity
authentication has occurred and what level of security will be applied when invoking the wrap() and
unwrap() methods. This byte value is coded according to the following table. Note that more than one security
level may be set.

              b8       b7     b6      b5      b4      b3      b2     b1            Meaning
              1                                                              AUTHENTICATED
                                                             1               C_DECRYPTION
                                                                     1       C_MAC
                             1                                               R_ENCRYPTION
                                     1                                       R_MAC
              0       0      0       0       0       0       0       0       NO_SECURITY_LEVEL

                          Table A-1: GlobalPlatform on a Java Card: Security Level



Field Summary
static byte       AUTHENTICATED
                      Entity authentication has occurred (0x80).

static byte       C_DECRYPTION
                      The unwrap method will decrypt incoming command data (0x02).

static byte       C_MAC
                     The unwrap method will verify the MAC on an incoming command (0x01).




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
 166                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

 static byte      NO_SECURITY_LEVEL
                      Entity Authentication has not occurred (0x00).

 static byte      R_ENCRYPTION
                      The wrap method will encrypt the outgoing response data (0x20).

 static byte      R_MAC
                     The wrap method will generate a MAC for outgoing response data (0x10).




 Method Summary
  short      decryptData(byte[] baBuffer, short sOffset, short sLength)
                  This method is used to decrypt data located in the input buffer.

  short      encryptData(byte[] baBuffer, short sOffset, short sLength)
                  This method is used to encrypt data located in the input buffer.

  byte       getSecurityLevel()
                   This method is used to determine whether the Security Domain has performed authentication and
                   to determine what level of security will be applied by the wrap() and unwrap() methods.

  short      processSecurity(javacard.framework.APDU apdu)
                  Processes security related APDU commands.

  void       resetSecurity()
                   This method is used to reset information relating to the current Secure Channel Session.

  short      unwrap(byte[] baBuffer, short sOffset, short sLength)
                 This method is used to process and verify the secure messaging of an incoming command
                 according to the security level.

  short      wrap(byte[] baBuffer, short sOffset, short sLength)
                  This method is used to apply additional security processing to outgoing response data and status
                  words according to the security level.




 Field Detail
AUTHENTICATED
public static final byte AUTHENTICATED

          Entity authentication has occurred (0x80).




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
 03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          167

       Note:

       x     Entity authentication and the level of security that will be applied by the wrap and unwrap methods
              are not necessarily related. A Security Domain, by default, could verify the MAC on any command
              passed as a parameter in the unwrap() method without entity authentication previously having
              occurred


C_DECRYPTION
public static final byte C_DECRYPTION

       The unwrap method will decrypt incoming command data (0x02).

       Note:

       x     Command data decryption could be indicated along with entity authentication and one or more levels
              of security.


C_MAC
public static final byte C_MAC

       The unwrap method will verify the MAC on an incoming command (0x01).

       Note:

       x     MAC verification could be indicated along with entity authentication and one or more levels of
              security e.g. a value of '03' indicates that while entity authentication has not occurred, the unwrap()
              method will decrypt the command data of incoming commands and verify the MAC on incoming
              commands.


R_ENCRYPTION
public static final byte R_ENCRYPTION

       The wrap method will encrypt the outgoing response data (0x20).

       Note:

       x     Response data encryption could be indicated along with entity authentication and one or more levels
              of security.


R_MAC
public static final byte R_MAC

       The wrap method will generate a MAC for the outgoing response data (0x10).




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
  168                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

        Note:

        x    MAC generation could be indicated along with entity authentication and one or more levels of
              security e.g. a value of '91' indicates that entity authentication has occurred and that the unwrap()
              method will verify the MAC on incoming commands and that the wrap() method will generate a
              MAC on outgoing response data


NO_SECURITY_LEVEL
public static final byte NO_SECURITY_LEVEL

        Entity authentication has not occurred (0x00).

        Notes:
        x    Entity authentication and the level of security that will be applied by the wrap and unwrap methods
              are not necessarily related. A Security Domain, by default, could verify the MAC on any command
              passed as a parameter in the unwrap() method without entity authentication previously having
              occurred.
        x    The wrap and unwrap methods will not apply any cryptographic processing to command or
              response data.



  Method Detail
processSecurity
public short processSecurity(javacard.framework.APDU apdu)
                          throws javacard.framework.ISOException

        Processes security related APDU commands.
        This method is used by an applet to process APDU commands that possibly relate to the security
        mechanism used by the Security Domain. As the intention is to allow an Application to be associated with a
        Security Domain without having any knowledge of the security mechanisms used by the Security Domain,
        the applet assumes that APDU commands that it does not recognize are part of the security mechanism and
        will be recognized by the Security Domain. The applet can either invoke this method prior to determining if
        it recognizes the command or only invoke this method for commands it does not recognize.

        Notes:
        x    The method is responsible for receiving the data field of commands that are recognized.
        x    The applet is responsible for recognizing commands that the method refused to process ('6E00' and
              '6D00').
        x    The applet is responsible for outputting status words returned due to the processing of instructions
              recognized by the method.
        x    If response data is present, this data will be placed in the APDU buffer at offset
              ISO7816.OFFSET_CDATA. The return code indicates the length and the applet is responsible for
              outputting this data.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
 03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          169

       Parameters:
                 apdu - the incoming APDU object
       Returns:
                 the number of bytes to be output
       Throws:
                javacard.framework.ISOException - with the following reason codes (other security
                mechanism related status words may be returned):
                x ISO7816.SW_CLA_NOT_SUPPORTED if class byte is not recognized by the method.
                x ISO7816.SW_INS_NOT_SUPPORTED if instruction byte is not recognized by the method.


wrap
public short wrap(byte[] baBuffer,
                   short sOffset,
                   short sLength)
           throws java.lang.ArrayIndexOutOfBoundsException,
                   javacard.framework.ISOException.

       This method is used to apply additional security processing to outgoing response data and status words
       according to the security level of the current Secure Channel Session.

       Notes:
       x     The applet is able to ensure that the security level it requires (R_MAC, R_ENCRYPTION) will be
              applied by invoking the getSecurityLevel() method.
       x     The getSecurityLevel() method invocation may also indicate that entity authentication
              (AUTHENTICATED) has previously occurred.
       x     If NO_SECURITY_LEVEL is indicated, this method will do no processing.
       Parameters:
              baBuffer - the source of the data to be wrapped. This buffer must be global.
              sOffset - the offset within the source buffer of the data to wrap
              sLength - the length of the data to wrap
       Returns:
                 new length of wrapped data
       Throws:
                 javacard.framework.ISOException – if security mechanism related status words might
                 be returned
                 java.lang.ArrayIndexOutOfBoundsException - if wrapping would cause access of
                 data outside array bounds


unwrap
public short unwrap(byte[] baBuffer,
                    short sOffset,
                    short sLength)
              throws javacard.framework.ISOException




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
 170                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

       This method is used to process and verify the secure messaging of an incoming command according to the
       security level of the current Secure Channel Session.

       Notes:
       x    The applet is able to query what level of security will be assumed (C_MAC, C_DECRYPTION) to be
             present by the Security Domain by invoking the getSecurityLevel() method.
       x    The getSecurityLevel() method invocation may also indicate that entity authentication
             (AUTHENTICATED) has previously occurred.
       x    If NO_SECURITY_LEVEL or AUTHENTICATED only is indicated, this method will not attempt any
             secure messaging processing on the incoming command and the incoming command will remain as is
             within the incoming APDU object. The returned length of the “unwrapped” data is set to the value of
             the sLength parameter.
       x    If the class byte does not indicate secure messaging (according to ISO/IEC 7816-4), this method will
             not attempt any secure messaging processing on the incoming command and the incoming command
             will remain as is within the incoming APDU object. When complying with the security policies of the
             Secure Channel Protocol, the returned length of the “unwrapped” data is set to the value of the
             sLength parameter otherwise a security error is returned.
       x    The applet is responsible for receiving the data field of the command.
       x    Correct secure messaging processing of the unwrap() will result in the incoming command being
             reformatted within the incoming APDU object with all data relating to the secure messaging removed.
             A reformatted case 1 or case 2 command will include an Lc byte set to zero.
       x    If R_MAC is indicated in the current security level of the Secure Channel Session, once secure
             messaging processing of the incoming command has successfully completed, R-MAC computation on
             the reformatted command (i.e. after all the data relating to secure messaging has been removed) will
             be initiated. If no secure messaging processing was required for the incoming command, R-MAC
             computation will be initiated on the unmodified incoming command, appended with a Lc byte of zero
             in event of a case 1 or case 2 command.
       x    Incorrect processing of the unwrap() will result in the information relating to the current Secure
             Channel being reset.
       Parameters:
                 baBuffer - the source of the data to be wrapped. This buffer must be global
                 sOffset - the offset within the source buffer of the data to unwrap
                 sLength - the length of the data to unwrap
       Returns:
                 the length of the unwrapped data i.e. the length of the command data
       Throws:
                 javacard.framework.ISOException - with the following reason code (other security
                 mechanism related status words may be returned):
                 x ISO7816.SW_SECURITY_STATUS_NOT_SATISFIED if secure messaging verification
                    failed.
                 x ISO7816.SW_CLA_NOT_SUPPORTED if class byte is not recognized by the method.


decryptData
public short decryptData(byte[] baBuffer,
                            short sOffset,
                            short sLength)
                    throws javacard.framework.ISOException




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
 03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          171


       This method is used to decrypt data located in the input buffer.

       Notes:
       x     The Security Domain implicitly knows the key used for decryption.
       x     The Security Domain is implicitly aware of any padding that may be present in the decrypted data
              according to the Secure Channel Protocol and the eventual padding is discarded.
       x     The clear text data replaces the ciphered data within the byte array.
       x     The applet is responsible for checking the integrity of the decrypted data.
       Parameters:
                 baBuffer - the source byte array. This buffer must be global.
                 sOffset - offset within the source byte array to start the decryption.
                 sLength - the number of bytes to decrypt.
       Returns:
       The length of the clear text data.
       Throws:
                 javacard.framework.ISOException - with the following reason codes:
                 x ISO7816.SW_SECURITY_STATUS_NOT_SATISFIED if a Secure Channel Session has
                    not been opened.
                 x ISO7816.SW_WRONG_LENGTH if the length of data to be decrypted is not valid.


encryptData
public short encryptData(byte[] baBuffer,
                            short sOffset,
                            short sLength)
                    throws java.lang.ArrayIndexOutOfBoundsException
                            javacard.framework.ISOException

       This method is used to encrypt data located in the input buffer.

       Notes:
       x     The Security Domain is implicitly aware of any padding that must be applied to the clear text data
              prior to encryption according to the Secure Channel Protocol.
       x     The Security Domain implicitly knows the key used for encryption.
       x     The ciphered data replaces the clear text data within the byte array.
       Parameters:
              baBuffer - the source byte array. This buffer must be global.
              sOffset - offset within the source byte array to start the encryption.
              sLength - the number of bytes to encrypt.
       Returns:
                 The length of the encrypted data.
       Throws:
                 java.lang.ArrayIndexOutOfBoundsException - if enciphering would cause access
                 outside array bounds.




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
  172                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

                   javacard.framework.ISOException - with the following reason code:
                   x ISO7816.SW_SECURITY_STATUS_NOT_SATISFIED if a Secure Channel Session has
                      not been opened.


resetSecurity
public void resetSecurity()

        This method is used to reset all information relating to the current Secure Channel Session.

        Notes:
        x    Applets using the services of a Security Domain, must invoke this method in the
              Applet.deselect() method.
        x    The Security Domain will reset all information relating to the current Secure Channel Session i.e. all
              Secure Channel session keys, state information and security level information will be erased.
        x    This method shall not fail if no Secure Channel Session information is present.


getSecurityLevel
public byte getSecurityLevel()

        This method is used to determine whether the Security Domain has performed authentication and to
        determine what level of security will be applied by the wrap() and unwrap() methods.

        Notes:
        x    Applets must invoke this method to ensure that application specific security requirements have been
              previously met or will be enforced by the Security Domain.
        x    More than one level of security may be active and these may change during a Secure Channel Session
              e.g. an R_MAC session may be initiated during a C_MAC session
        Returns:
              NO_SECURITY_LEVEL(0x00), indicating that entity authentication has not occurred and that the
              wrap() and unwrap() methods will not apply any cryptographic processing to command or
              response data, or a bitmap of the security level as follows:
              x    AUTHENTICATED (0x80): Entity authentication has occurred.
              x    C_MAC (0x01): The unwrap() method will verify the MAC on an incoming command.
              x    R_MAC (0x10): The wrap() method will generate a MAC for outgoing response data.
              x    C_DECRYPTION (0x02): The unwrap() method will decrypt incoming command data.
              x    R_ENCRYPTION (0x20): The wrap() method will encrypt the outgoing response data.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
  03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          173



  org.globalplatform
  Class GPSystem

java.lang.Object
  |
  +-org.globalplatform.GPSystem


  public class GPSystem extends java.lang.Object
  The System class exposes a subset of the behavior of the OPEN to the outside world. The OPEN implements and
  enforces a Card Issuer's security policy relating to these services. This OPEN class provides functionality at the
  same level as the JCRE i.e. the "system" context with special privileges. This class's public interface is composed
  of static methods visible to all applets importing the globalplatform package.



  Field Summary
  static byte    APPLICATION_INSTALLED
                     The current applet context is in the Life Cycle State of INSTALLED (0x03).

  static byte    APPLICATION_SELECTABLE
                     The current applet context is in the Life Cycle State of SELECTABLE (0x07).

  static byte    CARD_INITIALIZED
                    The card is in the Life Cycle State of INITIALIZED (0x07).

  static byte    CARD_LOCKED
                    The card is in the Life Cycle State of CARD_LOCKED(0x7F).

  static byte    CARD_OP_READY
                    The card is in the Life Cycle State of OP_READY (0x01).

  static byte    CARD_SECURED
                    The card is in the Life Cycle State of SECURED (0x0F).

  static byte    CARD_TERMINATED
                    The card is in the Life Cycle State of TERMINATED (0xFF).

  static byte    CVM_GLOBAL_PIN
                    Indicates that the CVM interface required is a global PIN (0x11).

  static byte    SECURITY_DOMAIN_PERSONALIZED
                     The current Security Domain is in the Life Cycle State of PERSONALIZED (0x0F).




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
 174                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003




 Method Summary
                                    static byte     getCardContentState()
                                                          This method returns the Life Cycle State of the current
                                                          applet context.

                                    static byte     getCardState()
                                                         This method returns the Life Cycle State for the card.

            static org.globalplatform.CVM           getCVM(byte bCVMIdentifier)
                                                         This method returns a handle to the CVM interface.

  static org.globalplatform.SecureChannel           getSecureChannel()
                                                          This method returns a handle to the SecureChannel interface.

                               static boolean       lockCard()
                                                         This method locks the card.

                               static boolean       setATRHistBytes(byte[] baBuffer, short sOffset, byte bLength)
                                                         This method sets the historical bytes of the ATR (Answer
                                                         To Reset) string.

                               static boolean       setCardContentState(byte bState)
                                                          This method sets the Application specific Life Cycle State
                                                          of the current applet context.

                                static boolean      terminateCard()
                                                         This method terminates the card.



 Field Detail
APPLICATION_INSTALLED
public static final byte APPLICATION_INSTALLED

       The current applet context is in the Life Cycle State of INSTALLED (0x03).
       Note:
       x   The Life Cycle State INSTALLED could be indicated along with another Application specific Life
            Cycle State e.g. a value of (0x07) indicates that the applet has been made selectable.


APPLICATION_SELECTABLE
public static final byte APPLICATION_SELECTABLE




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
 03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          175


       The current applet context is in the Life Cycle State of SELECTABLE (0x07).
       Note:
       x   The Life Cycle State SELECTABLE could be indicated along with another Application specific Life
            Cycle State.


SECURITY_DOMAIN_PERSONALIZED
public static final byte SECURITY_DOMAIN_PERSONALIZED

       The current Security Domain is in the Life Cycle State of PERSONALIZED (0x0F).


CARD_OP_READY
public static final byte CARD_OP_READY

       The card is in the Life Cycle State of OP_READY (0x01).


CARD_INITIALIZED
public static final byte CARD_INITIALIZED

       The card is in the Life Cycle State of INITIALIZED (0x07).


CARD_SECURED
public static final byte CARD_SECURED

       The card is in the Life Cycle State of SECURED (0x0F).


CARD_LOCKED
public static final byte CARD_LOCKED

       The card is in the Life Cycle State of CARD_LOCKED (0x7F).


CARD_TERMINATED
public static final byte CARD_TERMINATED

       The card is in the Life Cycle State of TERMINATED (0xFF).


CVM_GLOBAL_PIN
public static final byte CVM_GLOBAL_PIN




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
  176                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003


        Indicates that the CVM interface required is a global PIN (0x11).



  Method Detail
getCardContentState
public static byte getCardContentState()

        This method returns the Life Cycle State of the current applet context.
        Notes:
            x This method shall not be invoked from the Applet.install() method.
            x The OPEN locates the entry of the current applet context in the GlobalPlatform Registry and
               retrieves the Life Cycle State.
        Returns:
                  the Life Cycle State of the current applet context.
        See Also:
                  APPLICATION_INSTALLED, APPLICATION_SELECTABLE,
                  SECURITY_DOMAIN_PERSONALIZED


getCardState
public static byte getCardState()

        This method returns the Life Cycle State for the card.

        Returns:
                  the Life Cycle State of the card
        See Also:
                  CARD_OP_READY, CARD_INITIALIZED, CARD_SECURED, CARD_LOCKED,
                  CARD_TERMINATED


getCVM
public static org.globalplatform.CVM getCVM(byte bCVMIdentifier)

        This method returns a handle to the CVM interface.

        Parameters:
                  bCVMIdentifier - identifies the required CVM interface.
        Returns:
                  the CVM interface object reference.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
  03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          177

        See Also:
                  CVM_GLOBAL_PIN


getSecureChannel
public static org.globalplatform.SecureChannel getSecureChannel()

        This method returns a handle to the SecureChannel interface.
        Notes:
            x This method shall not be invoked from the Applet.install() method.
            x The OPEN locates the entry of the current applet context in the GlobalPlatform Registry to
               determine the Application's associated Security Domain.
        Returns:
                  the SecureChannel interface object reference.


lockCard
public static boolean lockCard()

        This method locks the card.
        Notes:
            x This method shall not be invoked from the Applet.install() method.
            x The OPEN locates the entry of the current applet context in the GlobalPlatform Registry and
               verifies that the Application has the card lock privilege.
        Returns:
                  true if card locked, false otherwise


terminateCard
public static boolean terminateCard()

        This method terminates the card.
        Notes:
            x This method shall not be invoked from the Applet.install() method.
            x The OPEN locates the entry of the current applet context in the GlobalPlatform Registry and
               verifies that the Application has the card terminate privilege.
        Returns:
                  true if card terminated, false otherwise




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
 178                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

setATRHistBytes
public static boolean setATRHistBytes(byte[] baBuffer,
                                           short sOffset,
                                           byte bLength)

       This method sets the historical bytes of the ATR (Answer To Reset) string. The sequence of bytes will be
       visible on a subsequent power-up or reset.
       Notes:
           x This method shall not be invoked from the Applet.install() method.
           x The OPEN locates the entry of the current applet context in the GlobalPlatform Registry and
              verifies that the Application has the Default Selected privilege.
           x The OPEN is responsible for synchronizing the length of historical bytes in Format Character T0
              of the ATR.
       Parameters:
                 baBuffer - the source byte array containing the ATR historical bytes. Must be a global array.
                 sOffset - offset of the ATR historical bytes within the source byte array.
                 bLength - the number of historical bytes.
       Returns:
                 true if ATR bytes set, false if the Application does not have the required privilege


setCardContentState
public static boolean setCardContentState(byte bState)

       This method sets the Application specific Life Cycle State of the current applet context. Application
       specific Life Cycle States range from 0x07 to 0x7F as long as the 3 low order bits are set.
       Notes:
           x This method shall not be invoked from the Applet.install() method.
           x The OPEN shall reject any transition request to the Life Cycle States INSTALLED or LOCKED.
           x The OPEN locates the entry of the current applet context in the GlobalPlatform Registry and
              modifies the value of the Life Cycle State.
       Parameters:
                 bState - the application specific state.
       Returns:
                 true if the operation is successful, false otherwise
       See Also:
                 SECURITY_DOMAIN_PERSONALIZED,




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          179

org.globalplatform
Interface CVM

public interface CVM extends javacard.framework.Shareable
This defines the interface of a privileged system class that represents a Cardholder Verification Method. This
class offers basic Cardholder Verification Method services (e.g. CVM verification, CVM state interrogation) to
any of the Applications present on the card, while some of the services (e.g. unblock CVM, change CVM value)
are restricted to Applications with the privilege to change the CVM values. Prior to using this interface, an
Application is required to obtain a handle to the CVM services by invoking the GPSystem.getCVM() method.



Field Summary
static short     CVM_FAILURE
                    The CVM value comparison failed (-1).

static short     CVM_SUCCESS
                    The CVM value comparison was successful (0).

static byte      FORMAT_ASCII
                    The CVM value is formatted as ASCII bytes (0x01).

static byte      FORMAT_BCD
                     The CVM value is formatted as numerical digits, coded on a nibble (4 bits) and left justified
                     (0x02).

static byte      FORMAT_HEX
                    The CVM value is formatted as hexadecimal (binary) data (0x03).




Method Summary
boolean        blockState()
                    This method sets the state of the CVM to BLOCKED.

    byte       getTriesRemaining()
                    This method returns the number of tries remaining for the CVM.

boolean        isActive()
                     This method indicates whether the CVM is present and activated.

boolean        isBlocked()
                     This method indicates whether the CVM is currently BLOCKED.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
 180                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

  boolean      isSubmitted()
                    This method indicates whether an attempt has been made to compare the CVM value.

  boolean      isVerified()
                     This method indicates whether a successful comparison of the CVM value has occurred (CVM
                     state of VALIDATED).

  boolean      resetState()
                     This method resets the state of the CVM to ACTIVE.

  boolean      resetAndUnblockState()
                     This method resets the state of the CVM from BLOCKED to ACTIVE.

  boolean      setTryLimit(byte bTryLimit)
                    This method sets the maximum number of tries for the CVM.

  boolean      update(byte[] baBuffer, short sOffset, byte bLength, byte bFormat)
                    This method changes the value of the CVM.

    short      verify(byte[] baBuffer, short sOffset, byte bLength, byte bFormat)
                     This method compares the CVM value with the value passed as a parameter.




 Field Detail
CVM_SUCCESS
public static final short CVM_SUCCESS

       The CVM value comparison was successful (0).


CVM_FAILURE
public static final short CVM_FAILURE

       The CVM value comparison failed (-1).


FORMAT_ASCII
public static final byte FORMAT_ASCII

       The CVM value is formatted as ASCII bytes (0x01).

       Note:

                x    If the CVM value is stored in a format other than ASCII, it is the responsibility of the interface
                      to convert to the expected format.




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
  03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          181



FORMAT_BCD
public static final byte FORMAT_BCD

        The CVM value is formatted as numerical digits, coded on a nibble (4 bits) and left justified (0x02).

        Note:
                 x    If the CVM value is stored in a format other than BCD, it is the responsibility of the interface
                       to convert to the expected format.
                 x    If the length of the CVM value is uneven, the right most nibble of the CVM value shall be high
                       values ('F').


FORMAT_HEX
public static final byte FORMAT_HEX

        The CVM value is formatted as hexadecimal (binary) data (0x03).

        Note:

        x     If the CVM value is stored in a format other than HEX, it is the responsibility of the interface to
               convert to the expected format.




  Method Detail
isActive
public boolean isActive()

        This method indicates whether the CVM is present and activated. If active the CVM could be in any one of
        the following states: ACTIVE, INVALID_SUBMISSION, VALIDATED or BLOCKED).

        Returns:
                  true if the CVM state is (at least) ACTIVE, false otherwise (i.e. does not exist).


isSubmitted
public boolean isSubmitted()

        This method indicates whether an attempt has been made to compare the CVM value.

        Note:

        x     This method does not differentiate whether the CVM value has been successfully verified or not i.e.
               CVM states of VALIDATED or INVALID_SUBMISSION.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
  182                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

         Returns:
                  true if the CVM state is (at least) INVALID_SUBMISSION, false otherwise.


isVerified
public boolean isVerified()

         This method indicates whether a successful comparison of the CVM value has occurred (CVM state of
         VALIDATED).
         Returns:
                  true if the CVM state is VALIDATED, false otherwise.


isBlocked
public boolean isBlocked()

         This method indicates whether the CVM is currently BLOCKED.
         Returns:
                  true if the CVM state is BLOCKED, false otherwise.


getTriesRemaining
public byte getTriesRemaining()

         This method returns the number of tries remaining for the CVM. This indicates the number of times the
         CVM value can be incorrectly presented prior to the CVM reaching the state of BLOCKED.
         Returns:
                  Tries remaining.


update
public boolean update(byte[] baBuffer,
                        short sOffset,
                        byte bLength,
                        byte bFormat)

         This method changes the content of the CVM value.

         Notes:
         x   The OPEN locates the entry of the current applet context in the GlobalPlatform Registry and verifies
              that the Application has the CVM management privilege.
         x   The applet is responsible for identifying the format of the CVM value.
         x   The CVM Retry Counter is reset when changing the CVM value.
         x   The CVM state is reset to ACTIVE when changing the CVM value.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
  03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          183

        x     Data presented always replaces the previous data regardless of its format or length. The CVM
               handler shall remember the format, length, and value of the CVM data. The CVM handler may (or
               may not) do editing checks on the data and reject the CVM update if the data fails the editing checks
               (e.g. reject data that is presented as BCD that is not numerical).
        Parameters:
                  baBuffer - the source byte array containing the CVM value. This buffer must be global.
                  sOffset - the offset of the CVM value within source byte array
                  bLength - the length of the CVM value
                  bFormat - the format of the CVM value
        Returns:
                  true if the CVM value was changed, false otherwise.


resetState
public boolean resetState()

        This method resets the state of the CVM to ACTIVE.

        Notes:
        x     The state of the CVM can only be set to ACTIVE from the states INVALID_SUBMISSION or
               VALIDATED.
        x     The state of the CVM cannot be set to ACTIVE from the state BLOCKED.
        Returns:
                  true if the CVM state was reset, false otherwise.


blockState
public boolean blockState()

        This method sets the state of the CVM to BLOCKED.

        Note:

        x     The OPEN locates the entry of the current applet context in the GlobalPlatform Registry and verifies
               that the application has the CVM management privilege.
        Returns:
                  true if the CVM state was set to BLOCKED, false otherwise.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
  184                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

resetAndUnblockState
public boolean resetAndUnblockState()

         This method resets the state of the CVM from BLOCKED to ACTIVE.

         Notes:
         x   The OPEN locates the entry of the current applet context in the GlobalPlatform Registry and verifies
              that the application has the CVM management privilege.
         x   The CVM Retry Counter is reset when unblocking the CVM.
         Returns:
                  true if the CVM state was reset to ACTIVE, false otherwise.


setTryLimit
public boolean setTryLimit(byte bTryLimit)

         This method sets the Retry Limit for the CVM.

         Notes:
         x   The OPEN locates the entry of the current applet context in the GlobalPlatform Registry and verifies
              that the application has the CVM management privilege.
         x   The CVM Retry Counter is reset when setting the maximum number of tries
         x   The CVM state is reset to ACTIVE when setting the maximum number of tries.
         Parameters:
                  bTryLimit - the Retry Limit for the CVM.
         Returns:
                  true if the Retry Limit was set, false otherwise.


verify
public short verify(byte[] baBuffer,
                      short sOffset,
                      byte bLength,
                      byte bFormat)

         This method compares the stored CVM value with the CVM value passed as a parameter.

         Notes:
         x   If the value passed as a parameter is not in the same format as the CVM is stored, the value passed as
              a parameter must be converted prior to comparing.
         x   If HEX format is presented for CVM verification and ASCII or BCD format was used for updating the
              CVM value, the comparison fails.
         x   If HEX format is presented for CVM verification and HEX format was used for updating the CVM
              value, the comparison succeeds when the length and the data value match exactly.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          185

      x   If BCD or ASCII format is presented for CVM verification and HEX format was used for updating the
           CVM value, the comparison fails.
      x   If ASCII format is presented for CVM verification and BCD format was used for updating the CVM
           value, the comparison fails if the ASCII characters presented for verification are not all numerical
           (zero to nine). If all the ASCII characters are numerical, format conversion occurs and the comparison
           succeeds when the length and the data value match exactly.
      x   If BCD format is presented for CVM verification and ASCII format was used for updating the CVM
           value, the comparison fails if the CVM value contains non-numerical ASCII characters. If the CVM
           value contains only numerical ASCII characters, format conversion occurs and the comparison
           succeeds when the length and the data value match exactly.
      x   If the comparison is successful, the Retry Counter must be reset and the CVM state must be set to
           VALIDATED.
      x   If the comparison is unsuccessful, the Retry Counter must be updated and the CVM state must be set to
           INVALID_SUBMISSION.
      x   The Retry Counter object and the CVM states VALIDATED and INVALID_SUBMISSION shall not
           conform to a transaction in progress, i.e. they shall not revert to a previous value if a transaction in
           progress is aborted.
      x   If the maximum number of tries has been reached, the CVM state must be set to BLOCKED.
      Parameters:
                baBuffer - the source byte array containing the CVM. This buffer must be global.
                sOffset - the offset of the CVM value within source byte array
                bLength - the length of the CVM value
                bFormat - the format of the CVM value
      Returns:
                value indicating whether the comparison was successful or not. Values other than CVM_SUCCESS
                (0) or CVM_FAILURE (-1) are Reserved for Future Use.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
186                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003




A.3 GlobalPlatform on Windows Powered Smart Card
Application API Interface on Windows Powered Smart Card
The OPEN provides an API interface that Applications may use to get services. The OPEN retains the control of
the services and determines whether or not to grant each request.
The following APIs are provided to access OPEN services. They are shown in the standard Visual Basic™
function prototype format.
OpGetCardContentState
Function OpGetCardContentState (ByRef AppState as Byte) as Byte
This API is used to retrieve the Life Cycle State of the currently selected Application. The OPEN locates the AID
of the currently selected Application in the GlobalPlatform Registry, and returns the Life Cycle State
In addition to application specific values, the following predefined values may be returned by this function:
      x   APPLICATION_INSTALLED = &H3
      x   APPLICATION_SELECTABLE = &H7
      x   SECURITY_DOMAIN_PERSONALIZED = &HF
OpSetCardContentState
Function OpSetCardContentState (ByVal state as Byte) as Byte
This API allows the currently selected Application to set its own Life Cycle State.
An Application may use this function in order to change its own Life Cycle State to an application specific value.
OpSetCardState
Function OpSetCardState (ByVal state as Byte) as Byte
This API changes the state of the card to the state specified.
The states may be:
      x   CARD_LOCKED = &H7F
      x   CARD_TERMINATED = &HFF
OPEN locates the registry entry of the currently selected Application and verifies that the application has the
privilege to change the card state to the specified one.
OpGetCardState
Function OpGetCardState (ByRef CardState as Byte) as Byte
This API returns the Life Cycle State of the card
One of the following four states will be returned by this function:
      x   CARD_OP_READY = &H1
      x   CARD_INITIALIZED = &H7




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          187

    x   CARD_SECURED = &HF
    x   CARD_LOCKED = &H7F
OpSetATRHistBytes
Function OpSetATRHistBytes (ATRData() as Byte, ByVal offset as Byte, ByVal length as Byte) as Byte
Paramenters:
    x   ATRData() – Buffer byte array containing the ATR historical bytes.
    x   offset – byte: Offset within the buffer where ATR historical bytes begin.
    x   length – byte Length of the ATR historical bytes in the buffer.
This function sets the Historical Bytes contained in the ATR. The sequence of bytes will be valid within an ATR
on a subsequent reset. This service is granted only if the currently selected Application has the Default Selected
privilege.
An Application may call this function in order to set the value of the Historical Bytes of the ATR. This
functionality is only accessible to the implicitly selectable Application. The Application sets the value of up to 15
Historical Bytes as well as the number of Historical Bytes within the ATR. This function may be invoked at any
time in the life of the Application subsequent to the Application being set to a selectable state with the Default
Selected privilege.
Security Domain API Interface on Windows Powered Smart Card
The following sections describe the API available for an application to obtain services from its associated security
domain. There will be mechanism whereby CLA, INS, P1, P2, and LC can be passed back and forth between an
application and its security domain. In addition, the security domain will be able to pass back a 2 two-byte
ResultCode and a 1 byte CurrentSecurityLevel byte on each call. The CurrentSecurityLevel byte will be encoded
as follows:

              b8      b7      b6      b5      b4      b3      b2     b1            Meaning
             1                                                               AUTHENTICATED
                                                             1               C_DECRYPTION
                                                                     1       C_MAC
                             1                                               R_ENCRYPTION
                                     1                                       R_MAC
             0       0       0       0       0       0       0       0       NO_SECURITY_LEVEL

           Table A-2: GlobalPlatform on Windows Powered Smart Card: Security Level
OpProcessSecureChannel
This function is used by an application to process APDU commands that possibly relate to the security
mechanism used by the Security Domain.
As the intention is to allow an applet to be associated with a Security Domain without having any knowledge of
the security mechanisms used by the Security Domain, the applet assumes that APDU commands that it does not
recognize are part of the security mechanism and will be recognized by the Security Domain.
Note:




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
188                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

 x     The Security Domain will retrieve the data portion of the APDU command from the card input
        communication buffer, and will place any command response data in the card output communication
        buffer.
 x     The application will be responsible to output the ResultCode that was set by the Security Domain.
OpResetSecurity
This function is used to erase any secure information relating to the current secure session that may have been
established.
OpDecryptData
This function is used to decrypt data that an application has placed in the card communication buffer.
Note:
 x     The Security Domain will retrieve the data to be decrypted from the card input communication buffer and
        place the results in the card output communication buffer. The decrypted data will then be retrieved by the
        calling application.
OpUnwrap
This function is used to process and verify the secure messaging of an incoming command.
Note:
 x     If the class byte indicate secures messaging (ISO/IEC 7816-4), the Security Domain will retrieve the data
        portion of the APDU command from the input communication buffer and will place the reformatted APDU
        command data in the output communication buffer. The Security Domain will have reformatted the APDU
        to have all data relating to the secure messaging removed.
 x     The Application is responsible for checking the Result Code set by the Security Domain to verify that the
        Security Domain was able to process the APDU according to the requirements for integrity and
        confidentiality that were specified when the secure channel was established.
 x     If the Security Domain was unable to correctly process the APDU command, the Security Domain will
        have reset all information relating to the current secure session.
OpWrap
This function is used to apply additional security processing to outgoing response data and status words.
Note:
 x     The application must place the data to be wrapped into the card output communication buffer.
OpEncryptData
This function is used to encrypt data that an application has placed in the card communication buffer.
Note:
 x     The Security Domain will retrieve the data to be encrypted from the card input communication buffer and
        place the results in the card output communication buffer. The encrypted data will then be retrieved by the
        calling application.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          189


B. Algorithms (Cryptographic and Hashing)
A GlobalPlatform card may support many types of security functions for use by applications. This section
contains examples of several of the cryptographic algorithms and the hashing method that are possible for
GlobalPlatform.


B.1 Data Encryption Standard (DES)
The Data Encryption Standard (DES) is a symmetric cryptographic algorithm that requires the use of the same
secret key to encrypt and decrypt data. In its simplest form it uses an 8-byte key to encrypt an 8-byte block of data
and the same 8-byte key to decrypt and retrieve the original clear text.
Triple DES uses a compound operation of DES encryption and decryption. DES and triple DES are defined in
FIPS PUB 46-3. Triple DES as used in GlobalPlatform uses keying option 2 as defined in FIPS PUB 46-3.


B.1.1      Encryption/Decryption
For encryption two variants are defined.

B.1.1.1    CBC Mode
Triple DES in CBC mode, as defined in [ANSI X9.52] and [ISO 10116], is used with an Initial Chaining Value
equal to '00 00 00 00 00 00 00 00'.

B.1.1.2    ECB Mode
Triple DES in ECB mode, as defined in [ANSI X9.52] and [ISO 10116], is used.


B.1.2      MACing
The chaining data encryption methods are defined in [IS9797].

B.1.2.1    Full Triple DES MAC
The full triple DES MAC is as defined in [ISO 9797-1] as MAC Algorithm 1 with output transformation 1,
without truncation, and with triple DES taking the place of the block cipher.

B.1.2.2    Single DES Plus Final Triple DES MAC
This is also known as the Retail MAC. It is as defined in [ISO 9797-1] as MAC Algorithm 1 with output
transformation 3, without truncation, and with DES taking the place of the block cipher.


B.2 Hashing Algorithms
A hash is a one-way digest operation over an arbitrary length of data that returns a fixed length hash value. A
hash is not a cryptographic algorithm and it only provides integrity of the data. It does not provide authentication
or confidentiality.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
190                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

B.2.1       Secure Hash Algorithm (SHA-1)
SHA-1 is defined in [ISO 10118-3] and FIPS PUB 180-1.


B.3 Public Key Cryptography Scheme 1 (PKCS#1)
Unlike DES, which uses a shared secret key, public key cryptography employs the use of a Private Key (kept
secret by one entity) and a Public Key. One public key algorithm used for GlobalPlatform is RSA (Rivest /
Shamir / Adleman).
The process of generating an RSA signature involves using the PKCS#1 standard. The signature scheme is RSA
SSA-PKCS1-v1_5 as defined in PKCS#1. This is applied to a digest of the data being signed, generated by the
SHA-1 algorithm. The resultant signature is the same size as the public key modulus. The length of the key
modulus is 1024 bits for this Specification.
The process of verifying a signature uses the public key applied to the signature (providing the hash) and the
comparison of this hash with the hash of the data being verified.


B.4 DES Padding
Unless specified to the contrary, padding prior to performing a DES operation across a block of data is achieved
in the following manner:
      x   Append an '80' to the right of the data block.
      x   If the resultant data block length is a multiple of 8, no further padding is required.
      x   Append binary zeroes to the right of the data block until the data block length is a multiple of 8.
If the data is being padded with the intention of generating a MAC, the padding is discarded following the DES
operation.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          191


C. Secure Content Management
This section defines the different methods that shall be used to secure the changes and/or modifications to the
content of a GlobalPlatform card. At this point in time, these methods are the only ones specified for
GlobalPlatform cards. Depending on the implementation of the card, any subset of these methods may be
supported.


C.1 Keys
In order to perform the Card Content management operations described in the subsequent sub-sections different
keys are required.


C.1.1      Issuer Security Domain Keys
The Issuer Security Domain shall have knowledge of different keys if Delegated Management is supported. These
keys are used to secure the management of the card and its content.

        Key                          Usage                          Length                     Remark
    Token           Token verification (RSA Public Key)           1024 bits       Delegated Management only
    Receipt         Optional Receipt generation (DES)             16 bytes        Delegated Management only
                                   Table C-1: Issuer Security Domain Keys

C.1.1.1    Token key
If the card supports Delegated Management, the Issuer Security Domain shall have a 1024 bit RSA Public Key to
be used to verify a Load, Install, or Extradition Token.

C.1.1.2    Receipt Key
If the card supports Delegated Management and specifically Receipt generation, the Issuer Security Domain shall
have an unambiguously recognized double length DES key to be used to generate Load, Install, Extradition, or
Delete Receipts.


C.1.2      Security Domain Keys
If the Security Domain supports DAP Verification, the Security Domain shall have either a DAP Verification
public key or a DAP Verification DES key that will be used to verify Load File Data Block Signatures.

          Key                               Usage                             Length                  Remark
                          Load File Data Block Signature
 DAP Verification                                                        1024 bits           DAP Verification only
                          verification (RSA Public Key)
                          Load File Data Block Signature
 DAP Verification                                                        16 Bytes            DAP Verification only
                          verification (DES Key)
                                 Table C-2: Additional Security Domain Key




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
192                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

C.2 Load File Data Block Hash
The Load File Data Block Hash is a field that is optionally present in the INSTALL [for load] command. The
purpose of this field is to provide a digest of the Load File Data Block and it is used to ensure that the contents of
the Load File Data Block have not been modified in any way. While the actual hash is not secured in any manner,
it is used in other secure operations that ensure that the Load File Data Block has not been modified and a new
hash generated for the modified data.
This hash is required in the command if Delegated Management loading is occurring and/or the Load File
contains one or more DAP Blocks:
When Delegated Management is occurring the Load Token is a signature of multiple fields including this hash
and is proof that the Card Issuer generated the Token for the Load File Data Block linked to the hash.
If the Load File contains DAP Blocks, DAP Verification is the actual signing of this hash and is proof that the
DAP Block was generated by an entity that verified the content of the Load File Data Block linked to the hash.
The hash present in the INSTALL [for load] command is generated according to Section 6.7.6.1 - Load File Data
Block Hash.
In order for the chain of trust to be complete, the card is responsible for verifying the hash on receipt of the
complete Load File Data Block.
A Security Domain's owner (e.g. a Controlling Authority or an Application Provider) generates a SHA-1 digest
across the complete Load File Data Block. Padding of the data is as defined by the SHA-1. The digest is
generated prior to the Load File Data Block being encapsulated in the TLV structure of the Load File (i.e.
excluding tag 'C4' and its length).


C.3 Tokens
Tokens are used when Delegated Management is being performed and they are public key signatures of the token
data defined in Section 7.7 - Delegated Management Tokens and Receipts and DAP Verification. Tokens are the
proof that the Card Issuer has authorized the Delegated Management operation being performed and they are
generated and verified according to this Appendix.
All cards supporting Delegated Management shall perform token verification and the Issuer Security Domain
shall have knowledge of a token verification public key to perform this verification. The signature scheme for
tokens is as defined in Appendix B.3 - Public Key Cryptography Scheme 1 (PKCS#1).


C.3.1       Load Token
A Card Issuer generates a Load Token. This is a signature authorizing the transmission of application code to the
card.
Generating a Load Token ensures the following:
      x   Only the application code (hash of the Load File Data Block) included in this signature may be loaded to
           the card;
      x   The AID of the Load File Data Block may only be that included in the signature; and,
      x   The Executable Load File (derived from the Load File Data Block) and all Executable Modules within
           the Executable Load File may only be associated with the Security Domain included in the signature.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          193

The Load Token is an RSA signature of the following data that will be included in the actual INSTALL [for load]
command to be transmitted to the card.

                                               Name                              Length
                            Reference control parameter P1                   1
                            Reference control parameter P2                   1
                            Length of the following data fields              1
                            (including the length fields)
                            Load File AID length                             1
                            Load File AID                                    5-16
                            Security Domain AID length                       1
                            Security Domain AID                              0 or 5-16
                            Length of the Load File Data Block Hash          1
                            Load File Data Block Hash                        20
                            Load parameters field length                     1
                            Load parameters field                            Var
                          Table C-3: Data Elements Included in the Load Token
This RSA signature is the encryption (with the token private key) of the SHA-1 message digest of the above data.
Padding of the data is as defined by the SHA-1 and PKCS#1 mechanisms.
The OPEN receives each of the Delegated Management load process commands (INSTALL [for load] command
followed by multiple LOAD commands) from the Security Domain. The Issuer Security Domain (at the request
of the OPEN) is responsible for verifying the Load Token (signature) using the token verification public key. The
OPEN is responsible for ensuring that the hash (Load File Data Block Hash) of the Load File Data Block present
in the INSTALL [for load], command is a valid SHA-1 message digest of the Load File Data Block.


C.3.2      Install Token
A Card Issuer generates an Install Token. This is a signature authorizing the installation to the card of an
Application (Executable Module) contained in a previously loaded file (Executable Load File).
Generating an Install Token ensures the following:
    x   Only the application (Executable Module) included in this signature and present in the Executable Load
         File may be installed on the card;
    x   That only the instance AID included in this signature may be used as the AID to select the instance;
    x   The Application may only be installed with the privileges included in this signature; and,
    x   Only the parameters included in this signature may be used to install the Application.
The Install Token is an RSA signature of the following data that will be included in an INSTALL [for install] or
INSTALL [for make selectable] command.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
194                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

Note: An INSTALL [for install] command may also include the option to make the Application selectable.



                                                 Name                                   Length
                       Reference control parameter P1                                       1
                       Reference control parameter P2                                       1
                       Length of the following data fields (including the                   1
                       length fields)
                       Executable Load File AID length                                      1
                       Executable Load File AID                                           5-16
                       Executable Module AID length                                         1
                       AID within the Executable Load File                                5-16
                       Instance AID length                                                 1
                       Instance AID                                                       5-16
                       Application Privileges length                                        1
                       Application Privileges                                               1
                       Install parameters field length                                      1
                       Install parameters (system and Application) field                  Var
                Table C-4: Data Elements Included in the INSTALL [for Install] Token



                                                 Name                                   Length
                       Reference control parameter P1                                       1
                       Reference control parameter P2                                       1
                       Length of the following data fields (including the                   1
                       length fields)
                       Executable Load File AID length (= '00')                            1
                       Executable Module AID length (= '00')                               1
                       Instance AID length                                                 1
                       Instance AID                                                       5-16
                       Application Privileges length                                       1
                       Application Privileges                                              1
                       Install parameters field length (= '00')                            1
          Table C-5: Data Elements Included in the INSTALL [for make selectable] Token
This RSA signature is the encryption (with the token private key) of the SHA-1 message digest of the above data.
Padding of the data is as defined by the SHA-1 and PKCS#1 mechanisms.
The Security Domain passes the Delegated Management command (INSTALL [for install] or INSTALL [for
make selectable] command) to the OPEN. The Issuer Security Domain is responsible for verifying the Install
Token using the Issuer Security Domain's token verification public key.


C.3.3      Extradition Token
A Card Issuer generates an Extradition Token. This is a signature authorizing the extradition of an Application
from one Security Domain to another.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          195

Generating an Extradition Token ensures the following:
    x   The instance of the Application may only be associated with the Security Domain included in the
         signature;
The Extradition Token is an RSA signature of the following data that will be included in an actual INSTALL [for
extradition] command to be transmitted to the card.

                                               Name                                   Length
                       Reference control parameter P1                             1
                       Reference control parameter P2                             1
                       Length of the following data fields (including the         1
                       length fields)
                       Security Domain AID length                                 1
                       Security Domain AID                                        5-16
                       Length = 0                                                 1
                       Instance AID length                                        1
                       Instance AID                                               5-16
                       Length = 0                                                 1
                       Length = 0                                                 1
                      Table C-6: Data Elements Included in the Extradition Token
This RSA signature is the encryption (with the token private key) of the SHA-1 message digest of the above data.
Padding of the data is as defined by the SHA-1 and PKCS#1 mechanisms.
The Security Domain passes the Delegated Management command (INSTALL [for extradition] command) to the
OPEN. The Issuer Security Domain is responsible for verifying the Extradition Token using the Issuer Security
Domain's token verification public key.


C.4 Receipts
Receipts are also optionally used when Delegated Management is being performed and are DES signatures of the
receipt data defined in Section 7.7 - Delegated Management Tokens and Receipts and DAP Verification. Receipts,
if required by the Card Issuers security principles, are intended to be confirmation for the Card Issuer that a
Delegated Management operation has been successfully completed. They are generated according to this
Appendix.
The card generates Receipts during Delegated Management operations as proof to the Card Issuer that the
operation (load, install, extradition or deletion) was successfully performed.
Cards supporting Delegated Management may generate receipts and in order to achieve this the Issuer Security
Domain would require knowledge of a double length DES receipt key.
Each Receipt is generated using the receipt key, an ICV of binary zeroes and the signature method described in
Appendix B.1.2.2 - Single DES Plus Final Triple DES MAC.
In addition to the receipt key, the Issuer Security Domain also keeps track of a Confirmation Counter. The
Confirmation Counter is a 16-bit value that is incremented by one (1) following each receipt generation. The
Confirmation Counter is initialized to zero. When reaching its maximum value, the Confirmation Counter shall
not be reset to zero. Cards are not required to support counter values beyond 32,767.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
196                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

C.4.1      Load Receipt
The Load Receipt, if used, provides proof to the Card Issuer that the identified Security Domain performed a load
of application code to a specific card.
A Load Receipt is a triple DES signature of the following data:

                                               Name                                   Length
                       Confirmation Counter length                                1
                       Confirmation Counter                                       2
                       Card Unique Data length                                    1
                       Card Unique Data                                           1-n
                       Executable Load File AID length                            1
                       Executable Load File AID                                   5-16
                       Security Domain AID length                                 1
                       Security Domain AID                                        5-16
                         Table C-7: Data Elements Included in the Load Receipt
Prior to generating the signature, the data shall be padded according to B.4 - DES Padding
The signature method, defined in Appendix B.1.2.2 - Single DES Plus Final Triple DES MAC, is applied across
the padded data and the signature along with other required data may be returned as the response message to the
last LOAD command.
The entity performing the Delegated Management function will forward this information to the Card Issuer. The
Card Issuer verifies the Load Receipt using the same above procedure with the additional comparison step.


C.4.2      Install Receipt
The Install Receipt, if used, provides proof to the Card Issuer that the identified Security Domain performed the
installation of an Application on a specific card.
An Install Receipt is a triple DES signature of the following data:

                                               Name                                      Length
                     Confirmation Counter length indicator                          1
                     Confirmation Counter                                           2
                     Card Unique Data length indicator                              1
                     Card Unique Data                                               1-n
                     Executable Load File AID length                                1
                     Executable Load File AID                                       5-16
                     Instance AID length indicator                                  1
                     Instance AID                                                   5-16
                         Table C-8: Data Elements Included in the Install Receipt
Prior to generating the signature the data shall be padded according to B.4 - DES Padding.
The signature method, defined in Appendix B.1.2.2 - Single DES Plus Final Triple DES MAC, is applied across
the padded data and the signature along with other required data may be returned as the response message to the
INSTALL [for install] or the INSTALL [for install and make selectable] command.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          197

The entity performing the Delegated Management function will forward this information to the Card Issuer. The
Card Issuer verifies the Install Receipt using the same above procedure with the additional comparison step.


C.4.3      Delete Receipt
The Delete Receipt, if used, provides proof to the Card Issuer that the identified Security Domain deleted an
Application or Executable Load File from a specific card.
A Delete Receipt is a DES signature of the following data:

                                               Name                                   Length
                       Confirmation Counter length indicator                      1
                       Confirmation Counter                                       2
                       Card Unique Data length indicator                          1
                       Card Unique Data                                           1-n
                       AID length indicator                                       1
                       Application instance or Executable Load File AID           5-16
                        Table C-9: Data Elements Included in the Delete Receipt
Prior to generating the signature the data shall be padded according to B.4 - DES Padding.
The signature method, defined in Appendix B.1.2.2 - Single DES Plus Final Triple DES MAC, is applied across
the padded data and the signature along with other required data may be returned as the response message to the
DELETE command.
The entity performing the Delegated Management function will forward this information to the Card Issuer. The
Card Issuer verifies the Delete Receipt using the same above procedure with the additional comparison step.


C.4.4      Extradition Receipt
The Extradition Receipt, if used, provides proof to the Card Issuer that the identified old Security Domain
extradited an Application to the new Security Domain on a specific card.
An Extradition Receipt is a DES signature of the following data:

                                               Name                                   Length
                       Confirmation Counter length indicator                      1
                       Confirmation Counter                                       2
                       Card Unique Data length indicator                          1
                       Card Unique Data                                           1-n
                       AID length indicator                                       1
                       Old Security Domain AID                                    5-16
                       AID length indicator                                       1
                       Application instance or Executable Load File AID           5-16
                       AID length indicator                                       1
                       New Security Domain AID                                    5-16
                     Table C-10: Data Elements Included in the Extradition Receipt
Prior to generating the signature the data shall be padded according to B.4 - DES Padding.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
198                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The signature method, defined in Appendix B.1.2.2 - Single DES Plus Final Triple DES MAC, is applied across
the padded data and the signature along with other required data may be returned as the response message to the
INSTALL [for extradition] command.
The entity performing the Delegated Management function will forward this information to the Card Issuer. The
Card Issuer verifies the Extradition Receipt using the same above procedure with the additional comparison step.


C.5 DAP Verification
Load File Data Block Signature verification is typically used by an entity other than the Card Issuer or the entity
responsible for loading the application code to the card, to ensure that the Application has been validated.
In order to support DAP Verification, a Security Domain with DAP Verification privileges shall be present on the
card. The Security Domain shall have knowledge of a 1024 bit public key or a 16 byte DES key.
Exactly how the OPEN and Security Domain interface during the DAP Verification process is beyond the scope
of this Specification. However the verification operation mandates that the signature be verified using the
Security Domain's DAP Verification key.


C.5.1      PKC Scheme
An entity generates a signature of the Load File Data Block Hash as defined in Appendix B.3 - Public Key
Cryptography Scheme 1 (PKCS#1), i.e. computing a SHA-1 message digest of the Load File Data Block Hash
and applying the DAP Verification private key to obtain the signature. This RSA signature is the encryption with
the DAP Verification private key of the SHA-1 message digest of the Load File Data Block Hash (i.e. hash of a
hash value). Padding of the data is as defined by SHA-1 and PKCS#1. The signature is provided to any entity
responsible for loading the signed application code to a GlobalPlatform card. The AID of the Security Domain
representing the Controlling Authority along with this 128-byte signature are placed in the Load File as a DAP
Block to be transmitted to the card.


C.5.2      DES Scheme
A Security Domain's owner generates a signature of the Load File Data Block Hash. This signature is a MAC of
the Load File Data Block Hash according to Appendix B.1.2.2 - Single DES Plus Final Triple DES. Padding of
the data is as defined in Appendix B.4 - DES Padding. The signature is provided to any entity responsible for
loading the signed application code to a GlobalPlatform card. The AID of the Security Domain representing the
Security Domain's owner along with this signature are placed in the Load File as a DAP Block to be transmitted
to the card.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          199


D. Secure Channel Protocol '01'
The following section defines the usage of Secure Channel Protocol '01' (SCP01).


D.1 Secure Communication

D.1.1      SCP01 Secure Channel
The 3 levels of security provided by SCP01 are:
Mutual authentication - in which the card and the off-card entity each prove that they have knowledge of the
same secrets;
Integrity and data origin authentication - in which the card ensures that the data being received from the off-
card entity actually came from an authenticated off-card entity in the correct sequence and has not been altered;
and,
Confidentiality - in which data being transmitted from the off-card entity to the card, is not viewable by an
unauthorized entity.
A further level of security applies to sensitive data (e.g. secret keys) that shall always be transmitted as
confidential data.
Only explicit Secure Channel initiation is supported in SCP01. Both implicit and explicit Secure Channel
termination are supported in SCP01.
In SCP01 the card shall support the following implementation options defined by "i" (see Appendix F -
GlobalPlatform Data Values and Card Recognition Data):
    x   "i" = '05': Initiation mode explicit, C-MAC on modified APDU, ICV set to zero, no ICV encryption, 3
         Secure Channel Keys,
    x   "i" = '15': Initiation mode explicit, C-MAC on modified APDU, ICV set to zero, ICV encryption, 3
         Secure Channel Keys.
Implementation option '15' is an enhancement over implementation option '05' and is therefore recommended.


D.1.2      Mutual Authentication
Mutual authentication is achieved through the process of initiating a Secure Channel and provides assurance to
both the card and the off-card entity that they are communicating with an authenticated entity. If any step in the
mutual authentication process fails, the process shall be restarted i.e. new challenges and Secure Channel Session
generated.
The Secure Channel is explicitly initiated by the off-card entity using the INITIALIZE UPDATE and
EXTERNAL AUTHENTICATE commands defined in this section. The Application may pass the APDU to the
Security Domain using the appropriate API e.g. the processSecurity() method of a GlobalPlatform Java Card.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
200                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The explicit Secure Channel initiation allows the off-card entity to instruct the card (see Appendix D.4.2 -
EXTERNAL AUTHENTICATE Command) as to what level of security is required for the current Secure Channel
(integrity and/or confidentiality) and apply this level of security to all the subsequent messages exchanged
between the card and the off-card entity until the end of the Secure Channel Session. It also gives the off-card
entity the possibility of selecting the Key Version Number and Key Identifier to be used (see the INITIALIZE
UPDATE command).
Note: The explicit Secure Channel initiation also allows the card to inform the off-card entity what Secure
Channel Protocol is supported, using the returned Secure Channel Protocol identifier.
The Secure Channel is always initiated (see Appendix D.4.1 - INITIALIZE UPDATE Command) by the off-card
entity by passing a “host” challenge (random data unique to this Secure Channel Session) to the card.
The card, on receipt of this challenge, generates its own “card” challenge (again random data unique to this
Secure Channel Session).
The card, using the host challenge, the card challenge and its internal static keys, creates new secret Secure
Channel session keys and generates a first cryptographic value (card cryptogram) using one of its newly created
Secure Channel session keys (see Appendix D.3.1 - DES Session Keys).
This card cryptogram along with the card challenge, the Secure Channel Protocol identifier, and other data is
transmitted back to the off-card entity.
As the off-card entity should now have all the same information that the card used to generate the card
cryptogram, it should be able to generate the same Secure Channel session keys and the same card cryptogram
and by performing a comparison, it is able to authenticate the card.
The off-card entity now uses a similar process to create a second cryptographic value (host cryptogram) to be
passed back to the card (see Appendix D.4.2 - EXTERNAL AUTHENTICATE Command).
As the card has all the same information that the host used to generate the host cryptogram, it should be able to
generate the same host cryptogram and, by performing a comparison, it is able to authenticate the off-card entity.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                       GlobalPlatform Card Specification 2.1.1                                                           201

SCP01 Mutual Authentication Flow
The following flow is an example of mutual authentication between a card and an off-card entity. This flow
shows mutual authentication occurring between a Security Domain and an off-card entity.



                                          Host                                                Security Domain



                                                             SELECT Security Domain
          SELECT
                                                                SELECT Response

                              Generate host challenge
                                                               INITIALIZE UPDATE
                                                                                                   Generate card challenge
                                                                                                   Generate session keys
                                                                                                  Calculate card cryptogram
                                                           INITIALIZE UPDATE Response
         Mutual             Generate session keys
      authentication        Verify card cryptogram
                           Calculate host cryptogram
                                                             EXTERNAL AUTHENTICATE
                                                                                                    Verify host cryptogram




                                                                      APDU Interface



                         Figure D-1: Mutual Authentication Flow (Security Domain)
Expanding the authentication process shown in the flow described in Section 7.4 - Runtime Messaging Support, it
can be seen how an Application would use the services of an associated Security Domain to achieve mutual
authentication.



                               Host                             Application                                         Security Domain

                       Generate host challenge
                                                  INITIALIZE UPDATE
                                                                                                                Generate card challenge
                                                                                    security processing         Generate session keys
                                                                                                               Calculate card cryptogram
                                          INITIALIZE UPDATE Response
     Mutual         Generate session keys
  authentication    Verify card cryptogram
                   Calculate host cryptogram
                                           EXTERNAL AUTHENTICATE
                                                                                   security processing           Verify host cryptogram




                                                 APDU Interface                           GP API




            Figure D-2: Mutual Authentication Flow (using services of Security Domain)




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
202                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

D.1.3       Message Integrity
The C-MAC is generated by applying multiple chained DES operations (using a Secure Channel session key
generated during the mutual authentication process) across the header and data field of an APDU command.
The card, on receipt of the message containing a C-MAC, using the same Secure Channel session key, performs
the same operation and by comparing its internally generated C-MAC with the C-MAC received from the off-
card entity is assured of the integrity of the full command. (If message data confidentiality has also been applied
to the message, the C-MAC applies to the message data field before encryption.)
The integrity of the sequence of commands being transmitted to the card is achieved by using the C-MAC from
the current command as the (possibly encrypted) Initial Chaining Vector (ICV) for the subsequent command. This
ensures the card that all commands in a sequence have been received.


D.1.4       Message Data Confidentiality
The message data field is encrypted by applying multiple chained DES operations (using a Secure Channel
session key generated during the mutual authentication process) across the entire data field of the command
message to be transmitted to the card, regardless of its contents (clear text data and/or already protected sensitive
data).


D.1.5        ICV Encryption
As an enhancement to the C-MAC mechanism, the ICV is encrypted before being applied to the calculation of the
next C-MAC. The encryption mechanism used is triple DES with the C-MAC session key.


D.1.6       Security Level
The security level of a communication not included in a Secure Channel Session shall be set to
NO_SECURITY_LEVEL.
For Secure Channel Protocol '01', the security level established in a Secure Channel Session is a bitmap
combination of the following values: AUTHENTICATED, C_MAC, and C_DECRYPTION. The Secure Channel
security level shall be set as follows:
      x   NO_SECURITY_LEVEL when a Secure Channel Session is closed or not yet fully initiated.
      x   AUTHENTICATED after a successful processing of an EXTERNAL AUTHENTICATE command:
           AUTHENTICATED shall be cleared once the Secure Channel Session is closed.
      x   AUTHENTICATED and C_MAC after a successful processing of an EXTERNAL AUTHENTICATE
           command with P1 indicating C-MAC (P1='01'): AUTHENTICATED and C-MAC shall be cleared once
           the Secure Channel Session is closed.
      x   AUTHENTICATED, C_MAC, and C_DECRYPTION after a successful processing of an EXTERNAL
           AUTHENTICATE command with P1 indicating C-MAC and command encryption (P1= '03'):
           AUTHENTICATED, C_MAC, and C_DECRYPTION shall be cleared once the Secure Channel Session
           is closed.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                       GlobalPlatform Card Specification 2.1.1                                       203

D.2 Cryptographic Keys
                 Key                                           Usage                          Length         Remark
 Secure Channel Encryption Key (S-              Secure Channel Authentication &              16 bytes        Mandatory
 ENC)                                           Encryption (DES)
 Secure Channel Message                         Secure Channel MAC Verification              16 bytes        Mandatory
 Authentication Code Key (S-MAC)                (DES)
 Data Encryption Key (DEK)                      Sensitive Data Decryption (DES)              16 bytes        Mandatory
                               Table D-1: Security Domain Secure Channel Keys
A Security Domain, including the Issuer Security Domain shall have at least one key set containing 3 keys to be
used in the initiation and use of a Secure Channel. These keys are all double length DES keys and are the
following:
    x        The Secure Channel encryption key (S-ENC) and the Secure Channel MAC key (S-MAC). These keys
              are only used to generate Secure Channel session keys during the initiation of a Secure Channel.
    x        The data encryption key (DEK) for decrypting sensitive data, e.g. secret or private keys. This key is a
              double length DES key and is used as a static key.


D.3 Cryptographic Usage

D.3.1          DES Session Keys
DES session keys shall be generated every time a Secure Channel is initiated and are used in the mutual
authentication process. These same session keys may be used for subsequent commands if the security level
indicates that secure messaging is required.
Session keys are generated to ensure that a different set of keys is used for each Secure Channel Session. While
this is not required for key encryption operations, it is important for authentication operations, MAC generation
and verification and command message encryption and decryption. It is therefore only necessary to create session
keys from the static Secure Channel encryption key (S-ENC) and the Secure Channel MAC key (S-MAC).
DES session keys are created using the static Secure Channel encryption key (S-ENC) and the Secure Channel
MAC key (S-MAC) and the random host and card challenges. Creating session keys involves 3 steps.
         x     Generating the session key derivation data. (The same derivation data is used to create both the Secure
                Channel encryption and Secure Channel MAC session keys.);
         x     Creating the Secure Channel encryption session key; and,
         x     Creating the Secure Channel MAC session key.
The DES operation used to generate these keys is always triple DES in ECB mode.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
204                            GlobalPlatform Card Specification 2.1.1                                         03/25/2003



           Card challenge (8 bytes)                                           Host challenge (8 bytes)




         Card challenge             Host challenge            Card challenge              Host challenge
        (4 byte right half)         (4 byte left half)        (4 byte left half)         (4 byte right half)




                                            Derivation data (16 bytes)




                       Figure D-3: Session Key - Step 1 - Generate Derivation data

                                                           Static S-ENC key (16 bytes)




                        Derivation data (16 bytes)               ECB encryption




                                                                                    Session S-ENC key (16 bytes)




                      Figure D-4: Session Key - Step 2 - Create S-ENC Session Key



                                                          Static S-MAC key (16 bytes)




                        Derivation data (16 bytes)               ECB encryption




                                                                                    Session S-MAC key (16 bytes)




                     Figure D-5: Session Key – Step 3 - Create S-MAC Session Key




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          205

D.3.2      Authentication Cryptograms
Both the card and the off-card entity (Host) generate an authentication cryptogram. The off-card entity verifies
the card cryptogram and the card verifies the host cryptogram. Generating or verifying an authentication
cryptogram uses the S-ENC session key and the signing method described in Appendix B.1.2.1 - Full Triple DES.

D.3.2.1    Card Authentication Cryptogram
The generation and verification of the card cryptogram is performed by concatenating the 8-byte host challenge
and 8-byte card challenge resulting in a 16-byte block.
Applying the same padding rules defined in Appendix B.4 - DES Padding, the data shall be padded with a further
8-byte block ('80 00 00 00 00 00 00 00').
The signature method, using the S-ENC session key and an ICV of binary zeroes, is applied across this 24-byte
block and the resulting 8-byte signature is the card cryptogram.

D.3.2.2    Host Authentication Cryptogram
The generation and verification of the host cryptogram is performed by concatenating the 8-byte card challenge
and 8-byte host challenge resulting in a 16-byte block.
Applying the same padding rules defined in Appendix B.4 - DES Padding, the data shall be padded with a further
8-byte block ('80 00 00 00 00 00 00 00').
The signature method, using the S-ENC session key and an ICV of binary zeroes, is applied across this 24-byte
block and the resulting 8-byte signature is the host cryptogram.


D.3.3      APDU Command MAC Generation and Verification
The Secure Channel mandates the use of a MAC on the EXTERNAL AUTHENTICATE command. Depending
on the security level defined in the initiation of the Secure Channel, all other commands within the Secure
Channel may require secure messaging and as such the use of a C-MAC.
A C-MAC is generated by an off-card entity and applied across the full APDU command being transmitted to the
card including the header (5 bytes) and the data field in the command message. (It does not include Le.)
Modification of the APDU command header and padding is required prior to the MAC operation being
performed.
The rules for APDU command header modification are as follows:
    x    The length of the command message (Lc) shall be incremented by 8 to indicate the inclusion of the C-
          MAC in the data field of the command message.

    x The class byte shall be modified to indicate that this APDU command includes secure messaging. This is
          achieved by setting bit 3 of the class byte. For all the commands defined in this specification, the class
          byte of commands that contain secure messaging shall be '84'. The C-MAC generation and verification
          does not reflect the logical channel information included in the class byte of the command: the logical
          channel number is always assumed to be zero in the generation or verification of the C-MAC.
    x    The rules for MAC padding are as defined in Appendix B.4 - DES Padding.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
206                             GlobalPlatform Card Specification 2.1.1                                 03/25/2003

As the ICV is used to chain the commands for command sequence integrity, the value of the ICV depends on
which APDU command within the sequence the MAC is being generated for:
x    For the EXTERNAL AUTHENTICATE command, the ICV is set to binary zeroes.
x    For any command following the EXTERNAL AUTHENTICATE command, the ICV is the C-MAC value
      successfully verified for the previous command received by the card. (Prior to using the ICV, the ICV can be
      encrypted as described in Appendix D.1.5 - ICV Encryption)
The signature method defined in Appendix B.1.2.1 - Full Triple DES, using the MAC session key and the ICV, is
applied across the padded data block and the resulting 8-byte signature is the C-MAC.
The C-MAC is appended at the end of the APDU command message excluding any padding but including the
modifications made to the command header (class and Lc).

     CLA          INS      P1      P2           Lc              Data Field

                                            Lc = Lc + length
                                               of C-MAC
      Set bit 3




     CLA          INS      P1      P2          Lc               Data Field               Padding




                                                                                   C-MAC Generation         C-MAC Session
                                                                                    (full triple DES)           Key




     CLA          INS     P1       P2          Lc               Data Field               C-MAC




                        Figure D-6: APDU Command MAC Generation and Verification
If no other secure messaging is required, the message is now prepared for transmission to the card. The C-MAC
shall be retained and used as the ICV for the subsequent C-MAC verification (if any).
The card, in order to verify the C-MAC, shall perform the same padding mechanism to the data and use the same
ICV and MAC session key employed by the off-card entity in order to verify the C-MAC. As with the off-card
entity, the C-MAC shall be retained and used as the ICV for the subsequent C-MAC verification (if any).
If the Secure Channel Session is occurring on a Supplementary Logical Channel, the logical channel number is
added to the class byte of the message after the C-MAC has been generated and prior to the message being
transmitted to the card. The card shall ignore any logical channel information in the class byte (i.e. assume the
logical channel number is zero) prior to verifying the C-MAC.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                                            207

D.3.4      APDU Data Field Encryption and Decryption
Depending on the security level defined in the initiation of the Secure Channel, all subsequent APDU commands
within the Secure Channel may require secure messaging and as such the use of a C-MAC (integrity) and
encryption (confidentiality).
If confidentiality is required, the off-card entity encrypts the “clear text” data field of the command message
being transmitted to the card. (If the APDU command does not originally contain command data, encryption is
not performed.) This excludes the header and the C-MAC but includes any data within the data field that has been
protected for another purpose e.g. secret or private keys encrypted with the data encryption key (DEK).
Command message encryption and decryption uses the Secure Channel encryption (S-ENC) session key and the
full triple DES encryption method described in Appendix B.1.1.1 – Encryption/Decryption CBC Mode
Prior to encrypting the data, the data shall be padded. Unlike the C-MAC, this padding now becomes part of the
data field and this necessitates further modification of the Lc value.
Padding of the data field to be encrypted is performed according to the following rules:
    x    The length of the original, “clear text”, data field is appended to the left of, and becomes part of the
          command data.
    x    If the length of the data field is now a multiple of 8, no further padding is required else continue with
          padding as defined in Appendix B.4 - DES Padding.
The number of bytes appended to the data field in order to fulfill the above padding shall be added to Lc. This
includes the mandatory length byte, the optional '80' and any optional binary zeroes.
The encryption can now be performed across the padded data field using the Secure Channel encryption session
key (S-ENC) and the result of each encryption becomes part of the encrypted data field in the command message.

    CLA        INS       P1        P2        Lc                                    Data Field               C-M AC
                                             Lc = Lc + 1 + length of padding




                                                                               L   Data Field               Padding




                                                                                          Encryption                  Encryption Session Key




   CLA        IN S       P1       P2         Lc                                      Encrypted Data Field                 C-M A C




                              Figure D-7: APDU Data Field Encryption
Note: The ICV and the chaining are only used to link the blocks of the data currently being encrypted. For this
reason the ICV for command data encryption is always binary zeroes.
The message is now prepared for transmission to the card.
The card is required to first decrypt the command message and strip off any padding prior to attempting to verify
the C-MAC. This decryption uses an ICV of binary zeroes and the same encryption session key employed by the
off-card entity. The padding shall be removed and Lc shall be modified to reflect the length prior to encryption
i.e. original clear text data plus C-MAC length.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
 208                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

 D.3.5      Key Sensitive Data Encryption and Decryption
 Key data encryption is used when transmitting key sensitive data to the card and is over and beyond the security
 level required for the Secure Channel. For instance all DES keys transmitted to a card should be encrypted.
 The key data encryption process uses the static data encryption key and the encryption method described in
 Appendix B.1.1.2 - ECB Mode.
 As all DES keys are by their very nature a multiple of 8-byte lengths no padding is required for key encryption
 operations. Similarly the sensitive data block length shall be constructed as a multiple of 8-byte long block before
 the data encryption operations: the eventual padding method is application specific.
 The encryption is performed across the key sensitive data and the result of each encryption becomes part of the
 encrypted key data. This encrypted key data becomes part of the “clear text” data field in the command message.
 The on-card decryption of key data is the exact opposite of the above operation; in particular, no padding is
 removed by the decryption operation.


 D.4 Secure Channel APDU Commands
 Table D-2 provides the list of minimum security requirements for SCP01 commands

                              Command                             Minimum Security Level
                     INITIALIZE UPDATE                         None
                     EXTERNAL AUTHENTICATE                     C-MAC
                   Table D-2: Minimum Security Requirements for SCP01 Commands
 Table D-3 provides the list of SCP01 command support per card Life Cycle State.

                       OP_READY            INITIALIZED          SECURED            CARD_LOCKED              TERMINATED
  Command                 DM                    DM                DM                   DM                       DM
                      ISD     SD          ISD       SD        ISD     SD           ISD      SD              ISD     SD
                          SD                    SD                 SD                  SD                       SD
INITIALIZE
                       9      9            9      9            9      9             9
UPDATE
EXTERNAL
                       9      9            9      9            9      9             9
AUTHENTICATE
                     Table D-3: SCP01 Command Support per Card Life Cycle State
 Legend of Table D-3:
 ISD: Issuer Security Domain.
 DM SD: Application Provider Security Domain with Delegated Management privilege.
 SD: Application Provider Security Domain without Delegated Management privilege.
 9 : Support required.
 Blank cell: Support optional.
 Striped cell: Support prohibited.




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          209




D.4.1      INITIALIZE UPDATE Command

D.4.1.1    Definition and Scope
The INITIALIZE UPDATE command is used to transmit card and Secure Channel Session data between the card
and the host. This command initiates the initiation of a Secure Channel Session.
At any time during a current Secure Channel, the INITIALIZE UPDATE command can be issued to the card in
order to initiate a new Secure Channel Session.
This INITIALIZE UPDATE command is not to be confused with commands of the same name in legacy
applications.

D.4.1.2      Command Message
The INITIALIZE UPDATE command message is coded according to the following table:

                    Code             Value                               Meaning
                 CLA             '80'
                 INS             '50'               INITIALIZE UPDATE
                 P1              'xx'               Key Version Number
                 P2              'xx'               Key Identifier
                 Lc              '08'               Length of host challenge
                 Data            'xx xx…'           Host challenge
                 Le              '00'
                            Table D-4: INITIALIZE UPDATE Command Message

D.4.1.3    Reference Control Parameter P1 - Key Version Number
The Key Version Number defines the Key Version Number within the Security Domain to be used to initiate the
Secure Channel Session. If this value is zero, the first available key chosen by the Security Domain will be used.

D.4.1.4    Reference Control Parameter P2 - Key Identifier
The Key Identifier together with the Key Version Number defined in reference control parameter P1 provide a
unique reference to the set of keys to be used to initiate the Secure Channel Session.

D.4.1.5    Data Field Sent in the Command Message
The data field of the command message contains 8 bytes of host challenge. This challenge, chosen by the off-card
entity, should be unique to this session.

D.4.1.6    Response Message
The data field of the response message shall contain the concatenation without delimiters of the following data
elements:




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
210                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003



                                                 Name                           Length
                               Key diversification data                       10 bytes
                               Key information                                2 bytes
                               Card challenge                                 8 bytes
                               Card cryptogram                                8 bytes
                            Table D-5: INITIALIZE UPDATE Response Message
The key diversification data is data typically used by a backend system to derive the card static keys.
The key information includes the Key Version Number and the Secure Channel Protocol identifier, here '01', used
in initiating the Secure Channel Session.
The card challenge is an internally generated random number.
The card cryptogram is an authentication cryptogram.

D.4.1.7    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
the following error condition:

                             SW1         SW2                    Meaning
                           '6A'        '88'       Referenced data not found
                              Table D-6: INITIALIZE UPDATE Error Condition




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          211




D.4.2       EXTERNAL AUTHENTICATE Command

D.4.2.1     Definition and Scope
The EXTERNAL AUTHENTICATE command is used by the card to authenticate the host and to determine the
level of security required for all subsequent commands.
A successful execution of the INITIALIZE UPDATE command shall precede this command.

D.4.2.2     Command Message
The EXTERNAL AUTHENTICATE command message is coded according to the following table:

            Code                  Value                                        Meaning
    CLA                     '84'
    INS                     '82'                   EXTERNAL AUTHENTICATE
    P1                      'xx'                   Security level
    P2                      '00'                   Reference control parameter P2
    Lc                      '10'                   Length of host cryptogram and MAC
    Data                    'xx xx…'               Host cryptogram and MAC
    Le                                             Not present
                      Table D-7: EXTERNAL AUTHENTICATE Command Message

D.4.2.3     Reference Control Parameter P1 - Security Level
The reference control parameter P1 defines the level of security for all secure messaging commands following
this EXTERNAL AUTHENTICATE command (it does not apply to this command) and within this Secure
Channel Session.

       b8      b7      b6      b5      b4     b3      b2      b1                     Description
      0       0       0       0        0      0      1       1       C-DECRYPTION and C-MAC.
      0       0       0       0        0      0      0       1       C-MAC
      0       0       0       0        0      0      0       0       No secure messaging expected.
              Table D-8: EXTERNAL AUTHENTICATE Reference Control Parameter P1

D.4.2.4     Reference Control Parameter P2
The reference control parameter P2 shall always be set to '00'.

D.4.2.5     Data Field Sent in the Command Message
The data field of the command message contains the host cryptogram and the APDU command MAC.

D.4.2.6     Data Field Returned in the Response Message
The data field of the response message is not present.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
212                              GlobalPlatform Card Specification 2.1.1                               03/25/2003

D.4.2.7    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
the following error condition:

                            SW1         SW2                        Meaning
                          '63'        '00'       Authentication of host cryptogram failed
                         Table D-9: EXTERNAL AUTHENTICATE Error Condition




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          213


E. Secure Channel Protocol '02'
The following section defines the usage of Secure Channel Protocol '02' (SCP02).


E.1 Secure Communication

E.1.1      SCP02 Secure Channel
Either the card or the off-card entity may play the role of being the secure sending and receiving entities. SCP02
provides the three followings levels of security:
Entity authentication - in which the card authenticates the off-card entity and the off-card entity may
authenticate the card, proving that the off-card entity has knowledge of the same secret(s) as the card;
Integrity and Data origin authentication - in which the receiving entity (the card or off-card entity) ensures that
the data being received actually came from an authenticated sending entity (respectively the off-card entity or
card) in the correct sequence and has not been altered; and,
Confidentiality - in which data being transmitted from the sending entity (the off-card entity or card) to the
receiving entity (respectively the card or off-card entity) is not viewable by an unauthorized entity.
A further level of security applies to sensitive data (e.g. secret keys) that shall always be transmitted as
confidential data.
In SCP02 the card shall support at least one of the following implementation options as defined by "i" (see
Appendix F - GlobalPlatform Data Values and Card Recognition Data):
    x   "i" = '04': Initiation mode explicit, C-MAC on modified APDU, ICV set to zero, no ICV encryption, 1
         Secure Channel base key,
    x   "i" = '05': Initiation mode explicit, C-MAC on modified APDU, ICV set to zero, no ICV encryption, 3
         Secure Channel Keys,
    x   "i" = '0A': Initiation mode implicit, C-MAC on unmodified APDU, ICV set to MAC over AID, no ICV
         encryption, 1 Secure Channel base key,
    x   "i" = '0B': Initiation mode implicit, C-MAC on unmodified APDU, ICV set to MAC over AID, no ICV
         encryption, 3 Secure Channel Keys.,
    x   "i" = '14': Initiation mode explicit, C-MAC on modified APDU, ICV set to zero, ICV encryption for C-
         MAC session, 1 Secure Channel base key,
    x   "i" = '15': Initiation mode explicit, C-MAC on modified APDU, ICV set to zero, ICV encryption for C-
         MAC session, 3 Secure Channel Keys,
    x   "i" = '1A': Initiation mode implicit, C-MAC on unmodified APDU, ICV set to MAC over AID, ICV
         encryption for C-MAC session, 1 Secure Channel base key,
    x   "i" = '1B': Initiation mode implicit, C-MAC on unmodified APDU, ICV set to MAC over AID, ICV
         encryption for C-MAC session, 3 Secure Channel Keys.
Implementation options '14', '15', '1A' and '1B' are enhancements over implementation options '04', '05', '0A' and
'0B' and are therefore recommended. At some point in the future implementation options '04', '05', '0A' and '0B'
will no longer be listed in the GlobalPlatform Specifications.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
214                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

E.1.2      Entity Authentication
Off-card entity authentication is achieved through the process of initiating a Secure Channel and provides
assurance to the card that it is communicating with an authenticated off-card entity. If any step in the off-card
authentication process fails, the process shall be restarted (i.e. new session keys generated).
The Secure Channel initiation and off-card entity authentication implies the creation of session keys derived from
card static key(s) using a Secure Channel Sequence Counter maintained by the Security Domain. The Security
Domain shall manage one Sequence Counter per Secure Channel base key or Secure Channel keys sharing the
same Key Version Number (see Appendix E.2 - Cryptographic Keys).
The Sequence Counter is incremented by 1 when and only when the first C-MAC of a secure channel (started
implicitly or explicitly) is verified as valid. It is incremented before the processing specific for the command. The
Sequence Counter is reset to zero on creation or update of the Secure Channel key(s). When the Secure Channel
key set contains more than one key (see Appendix E.2 - Cryptographic Keys), the Sequence Counter is reset to
zero on the creation or update of any one of the keys of this key set.
Note: the Sequence Counter is not updated for a C-MAC that is not the first of a Secure Channel Session or when
a Secure Channel Session is started and the C-MAC is invalid. In this respect, the Sequence Counter keeps track
of the number of valid Secure Channel Sessions the corresponding secure messaging key set has experienced so
far. When reaching its maximum value, the Sequence Counter shall not be reset to zero. Cards are not required to
support counter values beyond 32 767.

E.1.2.1    Explicit Secure Channel Initiation
The Secure Channel may be explicitly initiated by the off-card entity using the INITIALIZE UPDATE and
EXTERNAL AUTHENTICATE commands. The Application may pass the APDU to the Security Domain using
the appropriate API e.g. the processSecurity() method of a GlobalPlatform Java Card.
The explicit Secure Channel initiation allows the off-card entity to instruct the card (see Appendix E.5.2 -
EXTERNAL AUTHENTICATE Command) as to what level of security is required for the current Secure Channel
(integrity and/or confidentiality) and apply this level of security to all the subsequent messages exchanged
between the card and the off-card entity until the end of the session. It also gives the off-card entity the possibility
of selecting the Key Version Number to be used (see Appendix E.5.1 - INITIALIZE UPDATE Command).
Note: The explicit Secure Channel Session initiation also allows the card to inform the off-card entity what
Secure Channel Protocol is supported, using the returned Secure Channel Protocol identifier.
The Secure Channel is always initiated (see Appendix E.5.1 - INITIALIZE UPDATE Command) by the off-card
entity by passing a “host” challenge (random data unique to this session) to the card.
The card, on receipt of this challenge, generates its own “card” challenge (again random data unique to this
session).
The card, using its internal Sequence Counter and static keys, creates new secret session keys and generates a first
cryptographic value (card cryptogram) using one of its newly created session keys (see Appendix E.4.1 - DES
Session Keys).
This card cryptogram along with the Sequence Counter, the card challenge, the Secure Channel Protocol
identifier, and other data is transmitted back to the off-card entity.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          215

As the off-card entity should now have all the same information that the card used to generate the card
cryptogram, it should be able to generate the same session keys and the same card cryptogram and by performing
a comparison, it is able to authenticate the card.
The off-card entity now uses a similar process to create a second cryptographic value (host cryptogram) to be
passed back to the card (see Appendix E.5.2 - EXTERNAL AUTHENTICATE Command).
As the card has all the same information that the host used to generate the host cryptogram, it should be able to
generate the same cryptogram and, by performing a comparison, it is able to authenticate the off-card entity.
The off-card entity also creates a MAC to be passed back to the card and verified by the card. The verified MAC
is used by the card to create the Initial Chaining Vector for the verification of the subsequent C-MAC and/or R-
MAC.
When the off-card entity is successfully authenticated, the card increments its internal Secure Channel Sequence
Counter.

Explicit Secure Channel Initiation Flow
The following flow is an example of explicit Secure Channel initiation between a card and an off-card entity.
Expanding the authentication process shown in the flow described in Section 7.4 - Runtime Messaging Support, it
can be seen how an Application would use the services of a Security Domain to achieve the explicit Secure
Channel initiation.

                                     Off-card Entity                   Application                      Security Domain


                          Generate host challenge
                                                     INITIALIZE UPDATE
                                                                                                       Generate card challenge
                                                                                security processing    Generate session keys
                                                                                                      Calculate card cryptogram
                                              INITIALIZE UPDATE Response
    Mutual                Apply Secure Channel
 authentication                   Protocol
                          Generate session keys
                          Verify card cryptogram
                         Calculate host cryptogram

                                              EXTERNAL AUTHENTICATE
                                                                                                        Verify host cryptogram
                                                                                security processing
                                                                                                       Verify MAC & Initialize ICV


                                                APDU Interface                            GP API



                            Figure E-1: Explicit Secure Channel Initiation Flow




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
216                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

E.1.2.2     Implicit Secure Channel Initiation
The Secure Channel is implicitly initiated when receiving the first APDU command that contains a cryptographic
protection (C-MAC). The required level of security is implicitly known by both the card and off-card entity as
command message integrity only. The off-card entity implicitly knows which keys are to be used and the current
value of the Secure Channel Sequence Counter, or may have previously retrieved the corresponding information
using a GET DATA command.
The off-card entity, using the information it knows about the card static keys and its Secure Channel Sequence
Counter, creates new secret session keys and generates a C-MAC on an APDU command message.
The Secure Channel is initiated by the off-card entity by appending a C-MAC to an APDU command.
The card, on receipt of this first C-MAC, creates the C-MAC session key using its internal card static key(s) and
Secure Channel Sequence Counter.
The card has the same information that the host used to generate the C-MAC. It generates the same MAC and, by
performing a comparison, it authenticates the off-card entity.
When the off-card entity is successfully authenticated, the card increments its internal Secure Channel Sequence
Counter.
For sensitive data decryption, the card creates the data encryption session key using its internal card static key(s)
and the newly incremented value of the Secure Channel Sequence Counter. For R-MAC generation, the card
creates the R-MAC session key using its internal card static key(s) and the newly incremented value of the Secure
Channel Sequence Counter.
Note: In addition to command message integrity, the off-card entity may, at any moment during the Secure
Channel Session, initiate response message integrity using the BEGIN R-MAC SESSION command.


E.1.3       Message Integrity
The MAC is generated by applying multiple chained DES operations (using a session key generated prior to or
when opening the Secure Channel) across an APDU message.
A MAC may be generated on the following:
      x   C-MAC for APDU command messages (generated by the off-card entity),
      x   R-MAC for APDU response messages (generated by the card).
The receiving entity, on receipt of the message containing a MAC, using the same session key, performs the same
operation and by comparing its generated MAC with the MAC received from the sending entity is assured of the
integrity of the full command or response. (If message data confidentiality has also been applied to the message,
the MAC applies to the message data field before encryption.)
The integrity of the sequence of APDU command or response messages being transmitted to the receiving entity
is achieved by using the MAC from the current command or response as the (possibly encrypted) Initial Chaining
Vector (ICV) for the subsequent command or response. This ensures the receiving entity that all messages in a
sequence have been received. Computing the ICV is detailed in Appendix E.3 - Cryptographic Algorithms.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          217

E.1.4      Message Data Confidentiality
The message data field is encrypted by applying multiple chained DES operations (using a session key generated
during the Secure Channel initiation process) across the entire data field of either a command message or a
response, regardless of its contents (clear text data and/or already protected sensitive data).


E.1.5      Security Level
The security level of a communication not included in a Secure Channel Session shall be set to
NO_SECURITY_LEVEL.
For Secure Channel Protocol '02' with explicit initiation mode, the security level established in a Secure Channel
Session is a bitmap combination of the following values: AUTHENTICATED, C_MAC, R_MAC, and
C_DECRYPTION. The Secure Channel security level shall be set as follows:
    x   NO_SECURITY_LEVEL when a Secure Channel Session is closed or not yet fully initiated.
    x   AUTHENTICATED after a successful processing of an EXTERNAL AUTHENTICATE command:
         AUTHENTICATED shall be cleared once the Secure Channel Session is closed.
    x   C_MAC after a successful processing of an EXTERNAL AUTHENTICATE command with P1
         indicating C-MAC (P1='x1' or 'x3'): C-MAC shall be cleared once the Secure Channel Session is closed.
         Note that C_MAC is always combined with AUTHENTICATED and simultaneously set and cleared.
    x   C_DECRYPTION after a successful processing of an EXTERNAL AUTHENTICATE command with
         P1 indicating Command Encryption (P1= 'x3'): C_DECRYPTION shall be cleared once the Secure
         Channel Session is closed. Note that C_DECRYPTION is always combined with AUTHENTICATED
         and C_MAC and simultaneously set and cleared.
    x   R_MAC after a successful processing of an EXTERNAL AUTHENTICATE command with P1
         indicating R-MAC (P1='1x'): R-MAC shall be cleared once the Secure Channel Session is closed. Note
         that in this case R_MAC is always combined with AUTHENTICATED and simultaneously set and
         cleared. R_MAC may also be combined with C_MAC or C_DECRYPTION (according to the P1 value
         of the EXTERNAL AUTHENTICATE command) and simultaneously set and cleared.
    x   R_MAC after a successful processing of a BEGIN R-MAC SESSION command: R-MAC shall be
         cleared after a successful processing of an END R-MAC SESSION command. Note that in this case
         R_MAC may be combined with AUTHENTICATED, C_MAC, or C_DECRYPTION depending on the
         pre-existing security level of the Secure Channel Session. R_MAC is set and cleared independently of
         AUTHENTICATED, C_MAC, or C_DECRYPTION.
For Secure Channel Protocol '02' with implicit initiation mode, the security level established in a Secure Channel
Session is a bitmap combination of the following values: AUTHENTICATED, C_MAC, and R_MAC. The
Secure Channel security level shall be set as follows:
    x   NO_SECURITY_LEVEL when a Secure Channel Session is closed or not yet initiated.
    x   AUTHENTICATED and C_MAC after a successful verification of the C- MAC of the first command
         message with a C-MAC: C_MAC shall be cleared after the reception of the first command message
         without a C-MAC. AUTHENTICATED and C_MAC shall be cleared once the Secure Channel Session
         is closed.
    x   R_MAC after a successful processing of a BEGIN R-MAC SESSION command: R-MAC shall be
         cleared after a successful processing of an END R-MAC SESSION command.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
218                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

E.2 Cryptographic Keys
A Security Domain, including the Issuer Security Domain, shall have at least one key set to be used in the
initiation and use of a Secure Channel. This key set shall contain at least one double length DES key, the Secure
Channel base key. This Secure Channel base key is only used to generate session keys during the initiation of a
Secure Channel.

              Key                                       Usage                               Length         Remark
   Secure Channel base          Secure Channel authentication, MAC verification,
                                                                                           16 bytes       Mandatory
   key                          & sensitive data decryption (DES)
                    Table E-1: SCP02 - Security Domain Secure Channel Base Key
A Security Domain's, including the Issuer Security Domain's, Secure Channel key set may contain 3 double
length DES keys: the Secure Channel encryption key (S-ENC), the Secure Channel MAC key (S-MAC), and the
data encryption key (DEK) for decrypting sensitive data, e.g. secret or private keys. These keys are only used to
generate session keys during the initiation of a Secure Channel.

                    Key                                         Usage                         Length        Remark
   Secure Channel encryption key (S-          Secure Channel authentication &
                                                                                              16 bytes     Mandatory
   ENC)                                       encryption (DES)
   Secure Channel message                     Secure Channel MAC verification and
                                                                                              16 bytes     Mandatory
   authentication code key (S-MAC)            generation (DES)
   Data encryption key (DEK)                  Sensitive data decryption (DES)                 16 bytes     Mandatory
                       Table E-2: SCP02 - Security Domain Secure Channel Keys


E.3 Cryptographic Algorithms
The cryptographic and hashing algorithms described in Appendix B - Algorithms (Cryptographic and Hashing)
apply to SCP02. This section defines the additional requirements for SCP02.


E.3.1      Cipher Block Chaining (CBC)
The Initial Chaining Vector (ICV) used for chained data encryption in CBC mode is always 8 bytes of binary zero
('00').
The Initial Chaining Vector (ICV) used for chained message integrity in CBC mode is always 8 bytes and
initialized during the Secure Channel initiation.


E.3.2      Message Integrity ICV using Explicit Secure Channel Initiation
When using explicit Secure Channel initiation, SCP02 mandates the use of a MAC on the EXTERNAL
AUTHENTICATE command.
For the EXTERNAL AUTHENTICATE command MAC verification, the ICV is set to zero.
Once successfully verified, the MAC of the EXTERNAL AUTHENTICATE command becomes the ICV for the
subsequent C-MAC verification and/or R-MAC generation.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          219

E.3.3      Message Integrity ICV using Implicit Secure Channel Initiation
When using implicit Secure Channel Session initiation, the ICV shall be a MAC computed on the AID of the
selected Application. The ICV for the first C-MAC calculation of a new Secure Channel Session is calculated as
follows:
    x   Apply reversible padding to the AID of the selected Application as defined in Appendix B.4 - DES
         Padding.
    x   Calculate a MAC as defined in Appendix B.1.2.2 - Single DES Plus Final Triple DES with the C-MAC
         key over the padded Application AID with an ICV value of binary zeroes.
The resulting MAC is the ICV for the first C-MAC of the Secure Channel Session. This ICV makes the Secure
Channel Session application specific.
The ICV for the first R-MAC of a Secure Channel Session is calculated the same way, except that the R-MAC
key is used in step 2 for the MAC calculation.


E.3.4      ICV Encryption
As an enhancement to the C-MAC mechanism, the ICV is encrypted before being applied to the calculation of the
next C-MAC. The encryption mechanism used is single DES with the first half of the Secure Channel C-MAC
session key.


E.4 Cryptographic Usage

E.4.1      DES Session Keys
DES session keys are generated every time a Secure Channel is initiated. These session keys may be used for
subsequent commands if secure messaging is required.
Session keys are generated to ensure that a different set of keys is used for each secure communication session.
DES session keys are created using the static Secure Channel key(s), the Secure Channel Sequence Counter, a
constant, and a padding of binary zeroes. Creating session keys is performed as follows:
    x   Generating the Secure Channel C-MAC session keys using the Secure Channel base key or MAC key
         (S-MAC) and the session keys derivation data with a constant of '0101',
    x   Generating the Secure Channel R-MAC session keys using the Secure Channel base key or MAC key
         (S-MAC) and the session keys derivation data with a constant of '0102',
    x   Generating the Secure Channel encryption session keys using the Secure Channel base key or encryption
         key (S-ENC) and the session keys derivation data with a constant of '0182',
    x   Generating the Secure Channel data encryption session keys using the Secure Channel base key or data
         encryption key (DEK) and the session keys derivation data with a constant of '0181'.
The DES operation used to generate these keys is always triple DES in CBC mode.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
220                           GlobalPlatform Card Specification 2.1.1                                   03/25/2003


                                 Constant            Sequence Counter              ‘00’ Padding
                                 (2 bytes)           (2 bytes)                     (12 bytes)


                                                    S ecure Channel base key (16 bytes)




                       Derivation data (16 bytes)                CB C encryption




                                                                                    S ession K ey (16 bytes)




                 Figure E-2: Create Secure Channel Session Key from the Base Key


E.4.2      Authentication Cryptograms in Explicit Secure Channel Initiation
Both the card and the off-card entity (host) generate an authentication cryptogram. The off-card entity verifies the
card cryptogram and the card verifies the host cryptogram. Generating or verifying an authentication cryptogram
uses the S-ENC session key and the signing method described in Appendix B.1.2.1 - Full Triple DES.

E.4.2.1    Card Authentication Cryptogram
The generation and verification of the card cryptogram is performed by concatenating the 8-byte host challenge,
2-byte Sequence Counter, and 6-byte card challenge resulting in a 16-byte block.
Applying the same padding rules defined in Appendix B.4 - DES Padding, the data shall be padded with a further
8-byte block ('80 00 00 00 00 00 00 00').
The signature method, using the S-ENC session key and an ICV of binary zeroes, is applied across this 24-byte
block and the resulting 8-byte signature is the card cryptogram.

E.4.2.2    Host Authentication Cryptogram
The generation and verification of the host cryptogram is performed by concatenating the 2-byte Sequence
Counter, 6-byte card challenge, and 8-byte host challenge resulting in a 16-byte block.
Applying the same padding rules defined in Appendix B.4 - DES Padding, the data shall be padded with a further
8-byte block ('80 00 00 00 00 00 00 00').
The signature method, using the S-ENC session key and an ICV of binary zeroes, is applied across this 24-byte
block and the resulting 8-byte signature is the host cryptogram.


E.4.3      Authentication Cryptogram in Implicit Secure Channel Initiation
When using the implicit Secure Channel Session initiation, the authentication cryptogram is the first C-MAC
received by the card from the off-card entity.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          221

The rules for C-MAC generation and verification are detailed in the following subsection.


E.4.4      APDU Command C-MAC Generation and Verification
A C-MAC is generated by an off-card entity and applied across the full APDU command being transmitted to the
card including the header and the data field in the command message. It does not include Le.
C-MAC generation and verification uses the Secure Channel C-MAC session key, an ICV and the signature
method described in Appendix B.1.2.2 - Single DES Plus Final Triple DES. (Prior to using the ICV, the ICV can
be encrypted as described in Appendix E.3.4 - ICV Encryption)
The ICV is used to chain the commands for command sequence integrity; the initial value of the ICV is described
in Appendix E.3 - Cryptographic Algorithms. For any subsequent command following the first successful C-
MAC verification, the ICV is the C-MAC value successfully verified for the previous command received by the
card.
The signature method, using the Secure Channel C-MAC session key and the ICV, is applied across the padded
command message and the resulting 8-byte signature is the C-MAC. The rules for C-MAC padding are as defined
in Appendix B.4 - DES Padding.
To reflect the presence of a C-MAC in the command message, the command header shall be modified as follows:
    x   The length of the command message (Lc) shall be incremented by 8 to indicate the inclusion of the C-
         MAC in the data field of the command message.
    x   The class byte shall be modified to indicate that this APDU command includes secure messaging. This is
         achieved by setting bit 3 of the class byte. For all the commands defined in this specification, the class
         byte of commands that contain secure messaging will be '84'. The C-MAC generation and verification
         does not reflect the logical channel information included in the class byte of the command: the logical
         channel number is always assumed to be zero in the generation or verification of the C-MAC.
The C-MAC is appended at the end of the APDU command message excluding any padding but including the
modifications made to the command header (class and Lc).




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
222                                    GlobalPlatform Card Specification 2.1.1                                                   03/25/2003



The two following methods are defined for the C-MAC generation:
                x   C-MAC generation on unmodified APDU: padding of the APDU command is required prior to the C-
                     MAC generation being performed, and modification of the APDU command header is required after the
                     C-MAC generation has been performed.

 C LA                  IN S    P1       P2         Lc                         D ata Field               P adding




                                                  Lc = Lc + length of C-MAC
  Set bit 3




                                                                                                C -M A C G eneration
                                                                                               (single D E S plus final          C -M A C S ession K ey
                                                                                                     triple D E S )




 C LA                 IN S     P1       P2        Lc                          D ata Field               C -M A C



                                     Figure E-3: C-MAC Generation on Unmodified APDU
                x   C-MAC generation on modified APDU: padding of the APDU command and modification of the
                     command header is required prior to the C-MAC generation being performed.

 CLA                   IN S     P1      P2            Lc                      D a ta F ie ld
                                                Lc = Lc + length
                                                   of C-MAC
    Set bit 3




 CLA                   IN S     P1      P2            Lc                      D a ta F ie ld            P a d d in g




                                                                                                C -M A C G e n e ra tio n
                                                                                                                                   C -M A C S e s s io n
                                                                                               (s in g le D E S p lu s fin a l
                                                                                                                                          Key
                                                                                                        trip le D E S )



 CLA                   IN S    P1       P2         Lc                         D a ta F ie ld             C -M A C



                                      Figure E-4: C-MAC Generation on Modified APDU
If no other secure messaging is required, the message is now prepared for transmission to the card.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          223

The card, in order to verify the C-MAC, shall perform the same padding mechanism to the data and use the same
ICV and C-MAC session key employed by the off-card entity in order to verify the C-MAC. The verified C-MAC
shall be retained and used as the ICV for any subsequent C-MAC verification. This is true regardless of whether
the APDU completed successfully or not i.e. a verified C-MAC shall never be discarded in favor of a previous
verified C-MAC value.
If the Secure Channel Session is occurring on a Supplementary Logical Channel, the logical channel number is
added to the class byte of the message after the C-MAC has been generated and prior to the message being
transmitted to the card. The card shall remove any logical channel information from the class byte (i.e. assume the
logical channel number is zero) prior to verifying the C-MAC.


E.4.5      APDU Response R-MAC Generation and Verification
When using explicit Secure Channel Session initiation, the off-card entity instructs the card whether R-MAC
generation applies to all the subsequent command/response messages. The APDU response message integrity
does not include the EXTERNAL AUTHENTICATE command/response pair and lasts until the end of the
Secure Channel Session.
When using implicit Secure Channel Session initiation, the off-card entity instructs the card to start APDU
response message integrity using the BEGIN R-MAC SESSION command (see Appendix E.5.3 - BEGIN R-MAC
SESSION Command). The APDU response message integrity includes the BEGIN R-MAC SESSION
command/response pair and lasts until reception of the END R-MAC SESSION command (see Appendix E.5.4 -
END R-MAC SESSION Command).
The R-MAC is computed on the following data block:
    x   The stripped APDU command message, i.e. without any C-MAC and modified command header (the
         logical channel number is always assumed to be zero),
    x   The response data preceded with a byte that codes its length modulo 256,
    x   The status words.
The signature method, using the Secure Channel R-MAC session key and the ICV, is applied across the padded
data block and the resulting 8-byte signature is the R-MAC. The rules for R-MAC padding are as defined in
Appendix B.4 - DES Padding.
                                          Command Data        Li: Length of   Response Data       Status
  Header (CLA, INS, P1, P2)      Lc                                                                            Padding
                                             Field               R-Data           Field           Words




                                                            R-MAC generation                     R-MAC Session Key




                                          Response Data
                                                                  R-MAC          Status Words
                                              Field


                                         Figure E-5: R-MAC Generation




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
224                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

The R-MAC can be retrieved from the card by sending an END R-MAC SESSION command. This ends the R-
MAC session.
The off-card entity, in order to verify the R-MAC, shall perform the same padding mechanism to the
command/response pair and use the same ICV and R-MAC session key employed by the card in order to verify
the R-MAC. The generated R-MAC shall be retained and used as the ICV for any subsequent R-MAC generation.
(This is true regardless of whether the APDU command completed successfully or not.)
If the Secure Channel Session is occurring on a Supplementary Logical Channel, the logical channel information
is not included in any of the R-MAC computations. The R-MAC is generated with a logical channel number
assumed to be zero and the off-card entity is either not aware of, or removes, any logical channel information
from the class byte of the corresponding command when verifying the R-MAC.


E.4.6      APDU Command Data Field Encryption and Decryption
Depending on the security level defined in the explicit initiation of the Secure Channel, all subsequent APDU
commands within the Secure Channel may require secure messaging and as such the use of a C-MAC (integrity)
and encryption (confidentiality).
Note that, with an implicit initiation of the Secure Channel, command message data field encryption does not
apply.
If confidentiality is required, the off-card entity encrypts the data field of the command message being transmitted
to the card. This excludes the header and the C-MAC but includes any data within the data field that has been
protected for another purpose e.g. secret or private keys encrypted with the data encryption session key.
Command message encryption and decryption uses the Secure Channel encryption session key and the encryption
method described in Appendix B.1.1.1 – Encryption/Decryption CBC Mode.
Prior to encrypting the data, the data shall be padded. Unlike the C-MAC, this padding now becomes part of the
data field and this necessitates further modification of the Lc value.
Padding of the data field to be encrypted is performed according to Appendix B.4 - DES Padding.
The number of bytes appended to the data field in order to fulfill the above padding shall be added to Lc. This
includes the mandatory '80' and any optional binary zeroes.
The encryption can now be performed across the padded data field using the Secure Channel encryption session
key and the result of each encryption becomes part of the encrypted data field in the command message.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                     GlobalPlatform Card Specification 2.1.1                                                225

    CLA        INS       P1        P2        Lc                           Data Field             C-MAC




                                             Lc = Lc +length of padding
                                                                          Data Field             Padding




                                                                              Encryption                    Encryption Session Key




   CLA        INS        P1       P2         Lc                           Encrypted Data Field             C-MAC




                              Figure E-6: APDU Command Data Field Encryption
Note: The ICV and the chaining are only used to link the blocks of the data currently being encrypted. For this
reason the ICV for command data encryption is always binary zeroes.
The message is now prepared for transmission to the card. The card is required to first decrypt the command
message and strip off any padding prior to attempting to verify the C-MAC. This decryption uses an ICV of
binary zeroes and the same encryption session key employed by the off-card entity. The padding shall be removed
and Lc shall be modified to reflect the length prior to encryption i.e. original clear text data plus C-MAC length.


E.4.7      Sensitive Data Encryption and Decryption
Data encryption is used when transmitting sensitive data to the card and is over and beyond the security level
required for the Secure Channel; For instance all DES keys transmitted to a card (e.g. in a PUT KEY command)
should be encrypted.
The data encryption process uses the data encryption session key and the encryption method described in
Appendix B.1.1.2 – Encryption/Decryption ECB Mode when using explicit initiation of the Secure Channel and
Appendix B.1.1.1 – Encryption/Decryption CBC Mode when using implicit initiation of the Secure Channel.
As all DES keys are by their very nature a multiple of 8-byte lengths no padding is required for key encryption
operations. Similarly the sensitive data block length shall be constructed as a multiple of 8-byte long block before
the data encryption operations: the eventual padding method is application specific.
The encryption is performed across the sensitive data and the result of each encryption becomes part of the
encrypted data. This encrypted data becomes part of the “clear text” data field in the command message.
The on-card decryption of key data, is the exact opposite of the above operation: in particular, no padding is
removed by the decryption operation.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
 226                             GlobalPlatform Card Specification 2.1.1                                03/25/2003




 E.5 Secure Channel APDU Commands
                                                                    Secure Channel Initiation
           Command
                                                         Explicit                                    Implicit
INITIALIZE UPDATE                                          9
EXTERNAL AUTHENTICATE                                      9
BEGIN R-MAC SESSION
END R-MAC SESSION
                                      Table E-3: SCP02 Command Support

                                                                    Minimum Security Level
           Command
                                                         Explicit                                    Implicit
INITIALIZE UPDATE                        None
EXTERNAL AUTHENTICATE                    C-MAC                                                  Dependent on the
BEGIN R-MAC SESSION                      Secure Channel initiation                            Issuer security policy
END R-MAC SESSION                        Secure Channel initiation
                   Table E-4: Minimum Security Requirements for SCP02 Commands
 Note that Table E-3 shall be used in conjunction with Table E-5 to determine SCP02 command support
 requirements.

                       OP_READY            INITIALIZED          SECURED            CARD_LOCKED              TERMINATED
  Command                 DM                    DM                DM                   DM                       DM
                      ISD     SD          ISD       SD        ISD     SD           ISD      SD              ISD     SD
                          SD                    SD                 SD                  SD                       SD
INITIALIZE
             9               9            9      9            9      9            9
UPDATE
EXTERNAL
             9               9            9      9            9      9            9
AUTHENTICATE
BEGIN R-MAC
SESSION
END R-MAC
SESSION
                     Table E-5: SCP02 Command Support per card Life Cycle State
 Legend of Table E-3 and Table E-5:
 ISD: Issuer Security Domain.
 DM SD: Application Provider Security Domain with Delegated Management privilege.
 SD: Application Provider Security Domain without Delegated Management privilege.
 9 : Support required.
 Blank cell: Support optional.
 Striped cell: Support prohibited.




 Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
 The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
 information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
 prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          227




E.5.1      INITIALIZE UPDATE Command

E.5.1.1    Definition and Scope
The INITIALIZE UPDATE command is used, during explicit initiation of a Secure Channel, to transmit card and
session data between the card and the host. This command initiates the initiation of a Secure Channel Session.
At any time during a current Secure Channel, the INITIALIZE UPDATE command can be issued to the card in
order to initiate a new Secure Channel Session.
This INITIALIZE UPDATE command is not to be confused with commands of the same name in legacy
applications.

E.5.1.2    Command Message
The INITIALIZE UPDATE command message is coded according to the following table:

                       Code                   Value                            Meaning
                CLA                    '80'
                INS                    '50'                   INITIALIZE UPDATE
                P1                     'xx'                   Key Version Number
                P2                     '00'                   Reference control parameter P2
                Lc                     '08'                   Length of host challenge
                Data                   'xx xx…'               Host challenge
                Le                     '00'
                            Table E-6: INITIALIZE UPDATE Command Message

E.5.1.3    Reference Control Parameter P1 - Key Version Number
The Key Version Number defines the Key Version Number within the Security Domain to be used to initiate the
Secure Channel Session. If this value is zero, the first available key chosen by the Security Domain will be used.

E.5.1.4    Reference Control Parameter P2
The reference control parameter P2 shall always be set to '00'.

E.5.1.5    Data Field Sent in the Command Message
The data field of the command message contains 8 bytes of host challenge. This challenge, chosen by the off-card
entity, should be unique to this session.

E.5.1.6    Response Message
The data field of the response message contains the concatenation without delimiters of the following data
elements:




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
228                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003



                                               Name                             Length
                             Key diversification data                       10 bytes
                             Key information                                2 bytes
                             Sequence Counter                               2 bytes
                             Card challenge                                 6 bytes
                             Card cryptogram                                8 bytes
                            Table E-7: INITIALIZE UPDATE Response Message
The key diversification data is data typically used by a backend system to derive the card static keys.
The key information includes the Key Version Number and the Secure Channel Protocol identifier, here '02', used
in initiating the Secure Channel Session.
The Sequence Counter is an internal incremental counter used for creating session keys.
The card challenge is an internally generated random number.
The card cryptogram is an authentication cryptogram.

E.5.1.7    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
the following error condition:

                             SW1         SW2                       Meaning
                           '6A'        '88'       Referenced data not found
                              Table E-8: INITIALIZE UPDATE Error Condition




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          229




E.5.2      EXTERNAL AUTHENTICATE Command

E.5.2.1    Definition and Scope
The EXTERNAL AUTHENTICATE command is used by the card, during explicit initiation of a Secure Channel,
to authenticate the host and to determine the level of security required for all subsequent commands.
A successful execution of the INITIALIZE UPDATE command shall precede this command.

E.5.2.2    Command Message
The EXTERNAL AUTHENTICATE command message is coded according to the following table.

                Code                  Value                                    Meaning
         CLA                   '84'
         INS                   '82'                     EXTERNAL AUTHENTICATE
         P1                    'xx'                     Security level
         P2                    '00'                     Reference control parameter P2
         Lc                    '10'                     Length of host cryptogram and MAC
         Data                  'xx xx…'                 Host cryptogram and MAC
         Le                                             Not present
                       Table E-9: EXTERNAL AUTHENTICATE Command Message

E.5.2.3    Reference Control Parameter P1 - Security Level
The reference control parameter P1 defines the level of security for all secure messaging commands following
this EXTERNAL AUTHENTICATE command (it does not apply to this command) and within this Secure
Channel Session.

    b8     b7     b6     b5     b4     b3     b2     b1                           Description
   0      0      1      1      0      0       1     1      RFU
   0      0      1      1      0      0       0     1      RFU
   0      0      1      1      0      0       0     0      RFU
   0      0      0      1      0      0       1     1      C-DECRYPTION, C-MAC and R-MAC
   0      0      0      1      0      0       0     1      C-MAC and R-MAC
   0      0      0      1      0      0       0     0      R-MAC
   0      0      0      0      0      0       1     1      C-DECRYPTION and C-MAC
   0      0      0      0      0      0       0     1      C-MAC
   0      0      0      0      0      0       0     0      No secure messaging expected.

              Table E-10: EXTERNAL AUTHENTICATE Reference Control Parameter P1

E.5.2.4    Reference Control Parameter P2
The reference control parameter P2 shall always be set to '00'.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
230                             GlobalPlatform Card Specification 2.1.1                                03/25/2003

E.5.2.5    Data Field Sent in the Command Message
The data field of the command message contains the host cryptogram and the C-MAC.

E.5.2.6    Data Field Returned in the Response Message
The data field of the response message is not present.

E.5.2.7    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
the following warning condition:

                          SW1      SW2                           Meaning
                         '63'      '00'     Authentication of host cryptogram failed
                         Table E-11: EXTERNAL AUTHENTICATE warning Code




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                              GlobalPlatform Card Specification 2.1.1                                                231




E.5.3      BEGIN R-MAC SESSION Command

E.5.3.1    Definition and Scope
The BEGIN R-MAC SESSION command is used to initiate a Secure Channel Session for APDU response
message integrity. At any time, the BEGIN R-MAC SESSION command may be issued to the card in order to
initiate a R-MAC session.

E.5.3.2    Command Message
The BEGIN R-MAC SESSION command message is coded according to the following table:

                  Code                  Value                                                 Meaning
                  CLA          '80' or '84'
                  INS          '7A'                         BEGIN R-MAC SESSION
                  P1           'xx'                         Reference control parameter P1
                  P2           '01'                         Reference control parameter P2
                  Lc           'xx'                         Length of data field, if any
                  Data         'xx xx…'                     BEGIN R-MAC SESSION data and C-MAC, if needed
                  Le                                        Not present
                              Table E-12: BEGIN R-MAC SESSION Command Message

E.5.3.3    Reference Control Parameter P1
The reference control parameter P1 defines the level of security for all subsequent APDU response messages
following this BEGIN R-MAC SESSION command (it does not apply to this command).

          b8        b7        b6        b5        b4        b3        b2        b1                   Description
          0         0         1         1         0         0         0         0        Response Encryption and R-MAC (RFU)
          0         0         0         1         0         0         0         0        R-MAC
          0         0         0         0         0         0         0         0        No secure messaging expected
                    Table E-13: BEGIN R-MAC SESSION Reference Control Parameter P1
When P1 is set to '10' each APDU response message during the R-MAC session includes a R-MAC.
When P1 is set to '00' only the END R-MAC SESSION response message will contain a R-MAC.

E.5.3.4    Reference Control Parameter P2
The reference control parameter P2 defines the beginning of the session for APDU response message integrity.

               b8        b7        b6        b5        b4        b3        b2        b1               Description
              0         0         0         0         0         0          0         1     Begin R-MAC session.
                    Table E-14: BEGIN R-MAC SESSION Reference Control Parameter P2




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
232                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

E.5.3.5    Data Field Sent in the Command Message
The data field of the BEGIN R-MAC SESSION contains an LV coded ‘data’ element and optionally a C–MAC.
The card does not interpret the ‘data’. However since it is included in R-MAC calculation, this gives the off-card
entity the possibility to include a challenge in the R-MAC.
The following table details the BEGIN R-MAC SESSION data field:

                               Presence           Length in Bytes               Name
                              Mandatory          1                         Length of data
                              Conditional        0-24                      data
                       Table E-15: BEGIN R-MAC SESSION Command Data Field

E.5.3.6    Data Field Returned in the Response Message
The data field of the response message is not present.

E.5.3.7    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
the following error condition:

                                 SW1        SW2                    Meaning
                               '6A'       '88'        Referenced data not found
                          Table E-16: BEGIN R-MAC SESSION Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                           GlobalPlatform Card Specification 2.1.1                                       233




E.5.4      END R-MAC SESSION Command

E.5.4.1    Definition and Scope
The END R-MAC SESSION command is used to terminate a Secure Channel Session for APDU response
message integrity. At any time during an R-MAC session, the END R-MAC SESSION command may be issued
to the card in order to terminate the R-MAC session.

E.5.4.2    Command Message
The END R-MAC SESSION command message is coded according to the following table:

                        Code                 Value                                       Meaning
                       CLA           '80' or '84'
                       INS           '78'                       END R-MAC SESSION
                       P1            '00'                       Reference control parameter P1
                       P2            '03'                       Reference control parameter P2
                       Lc            'xx'                       Length of data field, if any
                       Data          'xx xx…'                   C-MAC, if needed
                       Le            '00'
                                Table E-17: END R-MAC SESSION Command Message

E.5.4.3    Reference Control Parameter P1
The reference control parameter P1 defines the level of security for all subsequent APDU response messages
following this END R-MAC SESSION command (it does not apply to this command).

          b8       b7       b6       b5       b4       b3       b2        b1                     Description
          0        0        0        0        0        0         0        0         No secure messaging expected
                   Table E-18: END R-MAC SESSION Reference Control Parameter P1

E.5.4.4    Reference Control Parameter P2
The reference control parameter P2 defines the end of the session for APDU response message integrity.

              b8       b7       b6       B5       b4       b3        b2        b1                 Description
              0        0        0        0        0        0         1         1       End R-MAC session
                   Table E-19: END R-MAC SESSION Reference Control Parameter P2

E.5.4.5    Data Field Sent in the Command Message
The data field of the command message may optionally contain a C-MAC.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
234                           GlobalPlatform Card Specification 2.1.1                                  03/25/2003

E.5.4.6    Data Field Returned in the Response Message
The data field of response message contains the final R-MAC of the current R-MAC session.

E.5.4.7    Processing State Returned in the Response Message
A successful execution of the command shall be indicated by status words '90' '00'.
This command may either return a general error condition as listed in Section 9.1.3 - General Error Conditions or
the following error condition:

                                 SW1        SW2                    Meaning
                               '6A'       '88'        Referenced data not found
                            Table E-20: END R-MAC SESSION Error Conditions




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
03/25/2003                    GlobalPlatform Card Specification 2.1.1                                          235


F. GlobalPlatform Data Values and Card Recognition
   Data

F.1      Data Values
The Object Identifier (OID) assigned to GlobalPlatform is as follows:
      GlobalPlatform OID ::= {iso(1) member-body(2) country-USA(840) Global-Platform(114283)}
The hexadecimal representation of the above OID is '2A864886FC6B'. The Object Identifier value for Card
Recognition Data {globalPlatform 1} or {1 2 840 114283 1}, which also identifies GlobalPlatform as the Tag
Allocation Authority for Card Recognition Data objects has an hexadecimal representation of '2A864886FC6B01'
and so on and so forth for all subsequent GlobalPlatform Object Identifiers.
The Registered Application Provider Identifier (RID) assigned to GlobalPlatform is as follows:
      GlobalPlatform RID = 'A000000151'
The default AID of the Issuer Security Domain, based on the above ISO assigned RID, is 'A0000001510000'.
The encoding of an OID is defined in ISO/IEC 8825-1. The definition of a RID is described in ISO/IEC 7816-5.


F.2      Structure of Card Recognition Data
All data is TLV encoded. Application tags not defined in this specification are RFU. GlobalPlatform may assign
additional Application tags in the future.
Many of the data objects contain Object Identifiers (OIDs). An OID is made up of a series of numeric values.
Each OID is shown here in curly brackets, with its component values separated by spaces. The actual numeric
values of some of the symbolic OID values shown, such as “globalPlatform”, are defined in this document and
may themselves comprise a series of values.




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
  236                              GlobalPlatform Card Specification 2.1.1                               03/25/2003

       Tag               Explanation        Length                       Value                              Presence
                       Tag for ‘Card       variable -    Data objects identified in 7816-6,
'66'                                                                                                  Mandatory
                       Data’               see note 1    including tag '73'
                       Tag for ‘Card
  '73'                                     variable      Data objects listed below                    Mandatory
                       Recognition Data’
                                                         {globalPlatform 1}
                       Universal tag for
                                                         OID for Card Recognition Data, also
       '06'            “Object             variable                                                   Mandatory
                                                         identifies Global Platform as the Tag
                       Identifier” (OID)
                                                         Allocation Authority
                                                         {globalPlatform 2 v}
       '60'            Application tag 0   variable
                                                         OID for Card Management Type and             Mandatory
              '06'     ‘OID’ tag           variable
                                                         Version - see note 2
                                                         {globalPlatform 3}
       '63'            Application tag 3   variable
                                                         OID for Card Identification Scheme -         Mandatory
              '06'     ‘OID’ tag           variable
                                                         see note 3
                                                         {globalPlatform 4 scp i}
       '64'            Application tag 4   variable      OID for Secure Channel Protocol of
                                                                                                      Mandatory
                '06'   ‘OID’ tag           variable      the Issuer Security Domain and its
                                                         implementation options- see note 4
       '65'            Application tag 5   variable      Card configuration details - see note 5      Optional

       '66'            Application tag 6   variable      Card / chip details - see note 6             Optional

                                    Table F-1: Structure of Card Recognition Data
  Note 1: Card Data should not exceed 127 bytes. This recommendation is to avoid the complexity of extending the
  length field of the '66' and '73' data objects and also to minimize the overheads involved in transferring the data.
  Note 2: Tag '60': The OID {globalPlatform 2 v} identifies a card that conforms to the GlobalPlatform Card
  Specification version “v”. Thus a card conforming to the GlobalPlatform Card Specification 2.1 would use OID
  {globalPlatform 2 2 1} and a card conforming to the GlobalPlatform Card Specification 2.1.1 would use OID
  {globalPlatform 2 2 1 1}.
  Note 3: Tag '63': The OID {globalPlatform 3} indicates a GlobalPlatform card that is uniquely identified by the
  Issuer Identification Number (IIN) and Card Image Number (CIN), as defined in Sections 6.8.1 - Issuer
  Identification Number and 6.8.2 - Card Image Number. The objective is that an off-card entity is able to construct
  a globally unique identifier for the card by concatenating this {globalPlatform 3} OID, the IIN and the CIN.
  Note 4: Tag '64'. The OID {globalPlatform 4 scp i} identifies the Secure Channel Protocol of the Issuer Security
  Domain. "scp" identifies the Secure Channel Protocol identifier as defined in Section 8.6 - Secure Channel
  Protocol Identifier."i" identifies the eventual implementation options such as implicit or explicit initiation as
  defined in Appendix D.1.1 - SCP01 Secure Channel for SCP '01' and Appendix E.1.1 - SCP02 Secure Channel
  for SCP '02'.
  Note 5: The data object with tag '65' may contain information about the GlobalPlatform implementation details or
  commonly used Card Issuer options. Such information shall be TLV encoded. The structure of this data object is
  under definition by GlobalPlatform.




  Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
  The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
  information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
  prohibited.
03/25/2003                      GlobalPlatform Card Specification 2.1.1                                        237

Note 6: The value of the data object with tag '66' is not defined by Global Platform. It may contain information
about the card and chip implementation, such as the operating system/runtime environment or a security kernel.
Such information shall be TLV encoded.


F.3         Security Domain Management Data
The Security Domain management data may be returned in the SELECT response message within template '73' as
described in Section 9.9.3.1 - Data Field Returned in the Response Message. When present, the Security Domain
management data shall be coded as follows.

   Tag                 Explanation        Length                       Value                          Presence
'73'                Template              variable     Data objects listed below                  Mandatory
                    Universal tag for
                                                       Identifies Global Platform as the
    '06'            “Object Identifier”   variable                                                Mandatory
                                                       Tag Allocation Authority
                    (OID)
                                                       {globalPlatform 2 v}
    '60'            Application tag 0     variable
                                                       OID for Card Management Type               Optional
           '06'     ‘OID’ tag             variable
                                                       and Version
    '63'            Application tag 3     variable     {globalPlatform 3}
                                                                                                  Optional
           '06'     ‘OID’ tag             variable     OID for Card Identification Scheme
                                                       {globalPlatform 4 scp i}
    '64'            Application tag 4     variable     OID for Secure Channel Protocol of
                                                                                                  Optional
             '06'   ‘OID’ tag             variable     the selected Security Domain and its
                                                       implementation options
    '65'            Application tag 5     variable     Card configuration details                 Optional

    '66'            Application tag 6     variable     Card / chip details                         Optional

                                 Table F-2: Security Domain Management Data




Copyright  2003 GlobalPlatform Inc. All Rights Reserved.
The technology provided or described herein is subject to updates, revisions, and extensions by GlobalPlatform. Use of this
information is governed by the GlobalPlatform license agreement and any use inconsistent with that agreement is strictly
prohibited.
